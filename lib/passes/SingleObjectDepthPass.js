var __extends = this.__extends || function (d, b) {
    for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p];
    function __() { this.constructor = d; }
    __.prototype = b.prototype;
    d.prototype = new __();
};
var Matrix3D = require("awayjs-core/lib/geom/Matrix3D");
var RenderTexture = require("awayjs-core/lib/textures/RenderTexture");
var TriangleSubGeometry = require("awayjs-display/lib/base/TriangleSubGeometry");
var ContextGLProgramType = require("awayjs-stagegl/lib/base/ContextGLProgramType");
var MaterialPassGLBase = require("awayjs-renderergl/lib/passes/MaterialPassGLBase");
/**
 * The SingleObjectDepthPass provides a material pass that renders a single object to a depth map from the point
 * of view from a light.
 */
var SingleObjectDepthPass = (function (_super) {
    __extends(SingleObjectDepthPass, _super);
    /**
     * Creates a new SingleObjectDepthPass object.
     */
    function SingleObjectDepthPass() {
        _super.call(this);
        this._textureSize = 512;
        this._polyOffset = Array(15, 0, 0, 0);
        this._projectionTexturesInvalid = true;
        //this._pNumUsedStreams = 2;
        //this._pNumUsedVertexConstants = 7;
        //this._enc = Array<number>(1.0, 255.0, 65025.0, 16581375.0, 1.0/255.0, 1.0/255.0, 1.0/255.0, 0.0);
        //
        //this._pAnimatableAttributes = Array<string>("va0", "va1");
        //this._pAnimationTargetRegisters = Array<string>("vt0", "vt1");
    }
    Object.defineProperty(SingleObjectDepthPass.prototype, "textureSize", {
        /**
         * The size of the depth map texture to render to.
         */
        get: function () {
            return this._textureSize;
        },
        set: function (value) {
            this._textureSize = value;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(SingleObjectDepthPass.prototype, "polyOffset", {
        /**
         * The amount by which the rendered object will be inflated, to prevent depth map rounding errors.
         */
        get: function () {
            return this._polyOffset[0];
        },
        set: function (value) {
            this._polyOffset[0] = value;
        },
        enumerable: true,
        configurable: true
    });
    /**
     * @inheritDoc
     */
    SingleObjectDepthPass.prototype.dispose = function () {
        if (this._textures) {
            for (var key in this._textures) {
                var texture = this._textures[key];
                texture.dispose();
            }
            this._textures = null;
        }
    };
    /**
     * Updates the projection textures used to contain the depth renders.
     */
    SingleObjectDepthPass.prototype.updateProjectionTextures = function () {
        if (this._textures) {
            for (var key in this._textures) {
                var texture = this._textures[key];
                texture.dispose();
            }
        }
        this._textures = new Object();
        this._projections = new Object();
        this._projectionTexturesInvalid = false;
    };
    /**
     * @inheritDoc
     */
    SingleObjectDepthPass.prototype._iGetVertexCode = function () {
        var code;
        // offset
        code = "mul vt7, vt1, vc4.x	\n" + "add vt7, vt7, vt0\n" + "mov vt7.w, vt0.w\n";
        // project
        code += "m44 vt2, vt7, vc0\n" + "mov op, vt2\n";
        // perspective divide
        code += "div v0, vt2, vt2.w\n";
        return code;
    };
    /**
     * @inheritDoc
     */
    SingleObjectDepthPass.prototype._iGetFragmentCode = function (shaderObject, registerCache, sharedRegisters) {
        var code = "";
        // encode float -> rgba
        code += "mul ft0, fc0, v0.z\n" + "frc ft0, ft0\n" + "mul ft1, ft0.yzww, fc1\n" + "sub ft0, ft0, ft1\n" + "mov oc, ft0\n";
        return code;
    };
    /**
     * Gets the depth maps rendered for this object from all lights.
     * @param renderable The renderable for which to retrieve the depth maps.
     * @param stage3DProxy The Stage3DProxy object currently used for rendering.
     * @return A list of depth map textures for all supported lights.
     */
    SingleObjectDepthPass.prototype._iGetDepthMap = function (renderable) {
        return this._textures[renderable.materialOwner.id];
    };
    /**
     * Retrieves the depth map projection maps for all lights.
     * @param renderable The renderable for which to retrieve the projection maps.
     * @return A list of projection maps for all supported lights.
     */
    SingleObjectDepthPass.prototype._iGetProjection = function (renderable) {
        return this._projections[renderable.materialOwner.id];
    };
    /**
     * @inheritDoc
     */
    SingleObjectDepthPass.prototype._iRender = function (pass, renderable, stage, camera, viewProjection) {
        var matrix;
        var context = stage.context;
        var len /*uint*/;
        var light;
        var lights = this._pLightPicker.allPickedLights;
        var rId = renderable.materialOwner.id;
        if (!this._textures[rId])
            this._textures[rId] = new RenderTexture(this._textureSize, this._textureSize);
        if (!this._projections[rId])
            this._projections[rId] = new Matrix3D();
        len = lights.length;
        // local position = enough
        light = lights[0];
        matrix = light.iGetObjectProjectionMatrix(renderable.sourceEntity, camera, this._projections[rId]);
        stage.setRenderTarget(this._textures[rId], true);
        context.clear(1.0, 1.0, 1.0);
        context.setProgramConstantsFromMatrix(ContextGLProgramType.VERTEX, 0, matrix, true);
        context.setProgramConstantsFromArray(ContextGLProgramType.FRAGMENT, 0, this._enc, 2);
        stage.activateBuffer(0, renderable.getVertexData(TriangleSubGeometry.POSITION_DATA), renderable.getVertexOffset(TriangleSubGeometry.POSITION_DATA), TriangleSubGeometry.POSITION_FORMAT);
        stage.activateBuffer(1, renderable.getVertexData(TriangleSubGeometry.NORMAL_DATA), renderable.getVertexOffset(TriangleSubGeometry.NORMAL_DATA), TriangleSubGeometry.NORMAL_FORMAT);
        context.drawTriangles(stage.getIndexBuffer(renderable.getIndexData()), 0, renderable.numTriangles);
    };
    /**
     * @inheritDoc
     */
    SingleObjectDepthPass.prototype._iActivate = function (pass, renderer, camera) {
        if (this._projectionTexturesInvalid)
            this.updateProjectionTextures();
        // never scale
        _super.prototype._iActivate.call(this, pass, renderer, camera);
        renderer.context.setProgramConstantsFromArray(ContextGLProgramType.VERTEX, 4, this._polyOffset, 1);
    };
    return SingleObjectDepthPass;
})(MaterialPassGLBase);
module.exports = SingleObjectDepthPass;

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImF3YXlqcy1tZXRob2RtYXRlcmlhbHMvbGliL3Bhc3Nlcy9TaW5nbGVPYmplY3REZXB0aFBhc3MudHMiXSwibmFtZXMiOlsiU2luZ2xlT2JqZWN0RGVwdGhQYXNzIiwiU2luZ2xlT2JqZWN0RGVwdGhQYXNzLmNvbnN0cnVjdG9yIiwiU2luZ2xlT2JqZWN0RGVwdGhQYXNzLnRleHR1cmVTaXplIiwiU2luZ2xlT2JqZWN0RGVwdGhQYXNzLnBvbHlPZmZzZXQiLCJTaW5nbGVPYmplY3REZXB0aFBhc3MuZGlzcG9zZSIsIlNpbmdsZU9iamVjdERlcHRoUGFzcy51cGRhdGVQcm9qZWN0aW9uVGV4dHVyZXMiLCJTaW5nbGVPYmplY3REZXB0aFBhc3MuX2lHZXRWZXJ0ZXhDb2RlIiwiU2luZ2xlT2JqZWN0RGVwdGhQYXNzLl9pR2V0RnJhZ21lbnRDb2RlIiwiU2luZ2xlT2JqZWN0RGVwdGhQYXNzLl9pR2V0RGVwdGhNYXAiLCJTaW5nbGVPYmplY3REZXB0aFBhc3MuX2lHZXRQcm9qZWN0aW9uIiwiU2luZ2xlT2JqZWN0RGVwdGhQYXNzLl9pUmVuZGVyIiwiU2luZ2xlT2JqZWN0RGVwdGhQYXNzLl9pQWN0aXZhdGUiXSwibWFwcGluZ3MiOiI7Ozs7OztBQUFBLElBQU8sUUFBUSxXQUFpQiwrQkFBK0IsQ0FBQyxDQUFDO0FBQ2pFLElBQU8sYUFBYSxXQUFlLHdDQUF3QyxDQUFDLENBQUM7QUFHN0UsSUFBTyxtQkFBbUIsV0FBYyw2Q0FBNkMsQ0FBQyxDQUFDO0FBSXZGLElBQU8sb0JBQW9CLFdBQWMsOENBQThDLENBQUMsQ0FBQztBQVV6RixJQUFPLGtCQUFrQixXQUFjLGlEQUFpRCxDQUFDLENBQUM7QUFFMUYsQUFJQTs7O0dBREc7SUFDRyxxQkFBcUI7SUFBU0EsVUFBOUJBLHFCQUFxQkEsVUFBMkJBO0lBbUNyREE7O09BRUdBO0lBQ0hBLFNBdENLQSxxQkFBcUJBO1FBd0N6QkMsaUJBQU9BLENBQUNBO1FBcENEQSxpQkFBWUEsR0FBbUJBLEdBQUdBLENBQUNBO1FB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LENBQUNBLElBQUlBLENBQUNBLFNBQVNBLENBQUNBLEdBQUdBLENBQUNBLENBQUNBO1lBQ3hCQSxJQUFJQSxDQUFDQSxTQUFTQSxDQUFDQSxHQUFHQSxDQUFDQSxHQUFHQSxJQUFJQSxhQUFhQSxDQUFDQSxJQUFJQSxDQUFDQSxZQUFZQSxFQUFFQSxJQUFJQSxDQUFDQSxZQUFZQSxDQUFDQSxDQUFDQTtRQUUvRUEsRUFBRUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsSUFBSUEsQ0FBQ0EsWUFBWUEsQ0FBQ0EsR0FBR0EsQ0FBQ0EsQ0FBQ0E7WUFDM0JBLElBQUlBLENBQUNBLFlBQVlBLENBQUNBLEdBQUdBLENBQUNBLEdBQUdBLElBQUlBLFFBQVFBLEVBQUVBLENBQUNBO1FBRXpDQSxHQUFHQSxHQUFHQSxNQUFNQSxDQUFDQSxNQUFNQSxDQUFDQTtRQUVwQkEsQUFDQUEsMEJBRDBCQTtRQUMxQkEsS0FBS0EsR0FBR0EsTUFBTUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7UUFFbEJBLE1BQU1BLEdBQUdBLEtBQUtBLENBQUNBLDBCQUEwQkEsQ0FBQ0EsVUFBVUEsQ0FBQ0EsWUFBWUEsRUFBRUEsTUFBTUEsRUFBRUEsSUFBSUEsQ0FBQ0EsWUFBWUEsQ0FBQ0EsR0FBR0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7UUFFbkdBLEtBQUtBLENBQUNBLGVBQWVBLENBQUNBLElBQUlBLENBQUNBLFNBQVNBLENBQUNBLEdBQUdBLENBQUNBLEVBQUVBLElBQUlBLENBQUNBLENBQUNBO1FBQ2pEQSxPQUFPQSxDQUFDQSxLQUFLQSxDQUFDQSxHQUFHQSxFQUFFQSxHQUFHQSxFQUFFQSxHQUFHQSxDQUFDQSxDQUFDQTtRQUM3QkEsT0FBT0EsQ0FBQ0EsNkJBQTZCQSxDQUFDQSxvQkFBb0JBLENBQUNBLE1BQU1BLEVBQUVBLENBQUNBLEVBQUVBLE1BQU1BLEVBQUVBLElBQUlBLENBQUNBLENBQUNBO1FBQ3BGQSxPQUFPQSxDQUFDQSw0QkFBNEJBLENBQUNBLG9CQUFvQkEsQ0FBQ0EsUUFBUUEsRUFBRUEsQ0FBQ0EsRUFBRUEsSUFBSUEsQ0FBQ0EsSUFBSUEsRUFBRUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7UUFFckZBLEtBQUtBLENBQUNBLGNBQWNBLENBQUNBLENBQUNBLEVBQUVBLFVBQVVBLENBQUNBLGFBQWFBLENBQUNBLG1CQUFtQkEsQ0FBQ0EsYUFBYUEsQ0FBQ0EsRUFBRUEsVUFBVUEsQ0FBQ0EsZUFBZUEsQ0FBQ0EsbUJBQW1CQSxDQUFDQSxhQUFhQSxDQUFDQSxFQUFFQSxtQkFBbUJBLENBQUNBLGVBQWVBLENBQUNBLENBQUNBO1FBQ3pMQSxLQUFLQSxDQUFDQSxjQUFjQSxDQUFDQSxDQUFDQSxFQUFFQSxVQUFVQSxDQUFDQSxhQUFhQSxDQUFDQSxtQkFBbUJBLENBQUNBLFdBQVdBLENBQUNBLEVBQUVBLFVBQVVBLENBQUNBLGVBQWVBLENBQUNBLG1CQUFtQkEsQ0FBQ0EsV0FBV0EsQ0FBQ0EsRUFBRUEsbUJBQW1CQSxDQUFDQSxhQUFhQSxDQUFDQSxDQUFDQTtRQUNuTEEsT0FBT0EsQ0FBQ0EsYUFBYUEsQ0FBQ0EsS0FBS0EsQ0FBQ0EsY0FBY0EsQ0FBQ0EsVUFBVUEsQ0FBQ0EsWUFBWUEsRUFBRUEsQ0FBQ0EsRUFBRUEsQ0FBQ0EsRUFBRUEsVUFBVUEsQ0FBQ0EsWUFBWUEsQ0FBQ0EsQ0FBQ0E7SUFDcEdBLENBQUNBO0lBRURWOztPQUVHQTtJQUNJQSwwQ0FBVUEsR0FBakJBLFVBQWtCQSxJQUFxQkEsRUFBRUEsUUFBcUJBLEVBQUVBLE1BQWFBO1FBRTVFVyxFQUFFQSxDQUFDQSxDQUFDQSxJQUFJQSxDQUFDQSwwQkFBMEJBLENBQUNBO1lBQ25DQSxJQUFJQSxDQUFDQSx3QkFBd0JBLEVBQUVBLENBQUNBO1FBRWpDQSxBQUNBQSxjQURjQTtRQUNkQSxnQkFBS0EsQ0FBQ0EsVUFBVUEsWUFBQ0EsSUFBSUEsRUFBRUEsUUFBUUEsRUFBRUEsTUFBTUEsQ0FBQ0EsQ0FBQ0E7UUFFekNBLFFBQVFBLENBQUNBLE9BQU9BLENBQUNBLDRCQUE0QkEsQ0FBQ0Esb0JBQW9CQSxDQUFDQSxNQUFNQSxFQUFFQSxDQUFDQSxFQUFFQSxJQUFJQSxDQUFDQSxXQUFXQSxFQUFFQSxDQUFDQSxDQUFDQSxDQUFDQTtJQUNwR0EsQ0FBQ0E7SUFDRlgsNEJBQUNBO0FBQURBLENBM0xBLEFBMkxDQSxFQTNMbUMsa0JBQWtCLEVBMkxyRDtBQUVELEFBQStCLGlCQUF0QixxQkFBcUIsQ0FBQyIsImZpbGUiOiJwYXNzZXMvU2luZ2xlT2JqZWN0RGVwdGhQYXNzLmpzIiwic291cmNlUm9vdCI6Ii4uLyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBNYXRyaXgzRFx0XHRcdFx0XHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLWNvcmUvbGliL2dlb20vTWF0cml4M0RcIik7XG5pbXBvcnQgUmVuZGVyVGV4dHVyZVx0XHRcdFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtY29yZS9saWIvdGV4dHVyZXMvUmVuZGVyVGV4dHVyZVwiKTtcblxuaW1wb3J0IExpZ2h0QmFzZVx0XHRcdFx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1kaXNwbGF5L2xpYi9iYXNlL0xpZ2h0QmFzZVwiKTtcbmltcG9ydCBUcmlhbmdsZVN1Ykdlb21ldHJ5XHRcdFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtZGlzcGxheS9saWIvYmFzZS9UcmlhbmdsZVN1Ykdlb21ldHJ5XCIpO1xuaW1wb3J0IENhbWVyYVx0XHRcdFx0XHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLWRpc3BsYXkvbGliL2VudGl0aWVzL0NhbWVyYVwiKTtcbmltcG9ydCBNYXRlcmlhbEJhc2VcdFx0XHRcdFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtZGlzcGxheS9saWIvbWF0ZXJpYWxzL01hdGVyaWFsQmFzZVwiKTtcblxuaW1wb3J0IENvbnRleHRHTFByb2dyYW1UeXBlXHRcdFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtc3RhZ2VnbC9saWIvYmFzZS9Db250ZXh0R0xQcm9ncmFtVHlwZVwiKTtcbmltcG9ydCBJQ29udGV4dEdMXHRcdFx0XHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLXN0YWdlZ2wvbGliL2Jhc2UvSUNvbnRleHRHTFwiKTtcbmltcG9ydCBTdGFnZVx0XHRcdFx0XHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLXN0YWdlZ2wvbGliL2Jhc2UvU3RhZ2VcIik7XG5cbmltcG9ydCBSZW5kZXJlckJhc2VcdFx0XHRcdFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtcmVuZGVyZXJnbC9saWIvYmFzZS9SZW5kZXJlckJhc2VcIik7XG5pbXBvcnQgTWF0ZXJpYWxQYXNzRGF0YVx0XHRcdFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtcmVuZGVyZXJnbC9saWIvcG9vbC9NYXRlcmlhbFBhc3NEYXRhXCIpO1xuaW1wb3J0IFJlbmRlcmFibGVCYXNlXHRcdFx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1yZW5kZXJlcmdsL2xpYi9wb29sL1JlbmRlcmFibGVCYXNlXCIpO1xuaW1wb3J0IFNoYWRlck9iamVjdEJhc2VcdFx0XHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLXJlbmRlcmVyZ2wvbGliL2NvbXBpbGF0aW9uL1NoYWRlck9iamVjdEJhc2VcIik7XG5pbXBvcnQgU2hhZGVyUmVnaXN0ZXJDYWNoZVx0XHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLXJlbmRlcmVyZ2wvbGliL2NvbXBpbGF0aW9uL1NoYWRlclJlZ2lzdGVyQ2FjaGVcIik7XG5pbXBvcnQgU2hhZGVyUmVnaXN0ZXJEYXRhXHRcdFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtcmVuZGVyZXJnbC9saWIvY29tcGlsYXRpb24vU2hhZGVyUmVnaXN0ZXJEYXRhXCIpO1xuaW1wb3J0IE1hdGVyaWFsUGFzc0dMQmFzZVx0XHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLXJlbmRlcmVyZ2wvbGliL3Bhc3Nlcy9NYXRlcmlhbFBhc3NHTEJhc2VcIik7XG5cbi8qKlxuICogVGhlIFNpbmdsZU9iamVjdERlcHRoUGFzcyBwcm92aWRlcyBhIG1hdGVyaWFsIHBhc3MgdGhhdCByZW5kZXJzIGEgc2luZ2xlIG9iamVjdCB0byBhIGRlcHRoIG1hcCBmcm9tIHRoZSBwb2ludFxuICogb2YgdmlldyBmcm9tIGEgbGlnaHQuXG4gKi9cbmNsYXNzIFNpbmdsZU9iamVjdERlcHRoUGFzcyBleHRlbmRzIE1hdGVyaWFsUGFzc0dMQmFzZVxue1xuXHRwcml2YXRlIF90ZXh0dXJlczpPYmplY3Q7XG5cdHByaXZhdGUgX3Byb2plY3Rpb25zOk9iamVjdDtcblx0cHJpdmF0ZSBfdGV4dHVyZVNpemU6bnVtYmVyIC8qdWludCovID0gNTEyO1xuXHRwcml2YXRlIF9wb2x5T2Zmc2V0OkFycmF5PG51bWJlcj4gPSBBcnJheTxudW1iZXI+KDE1LCAwLCAwLCAwKTtcblx0cHJpdmF0ZSBfZW5jOkFycmF5PG51bWJlcj47XG5cdHByaXZhdGUgX3Byb2plY3Rpb25UZXh0dXJlc0ludmFsaWQ6Qm9vbGVhbiA9IHRydWU7XG5cblx0LyoqXG5cdCAqIFRoZSBzaXplIG9mIHRoZSBkZXB0aCBtYXAgdGV4dHVyZSB0byByZW5kZXIgdG8uXG5cdCAqL1xuXHRwdWJsaWMgZ2V0IHRleHR1cmVTaXplKCk6bnVtYmVyXG5cdHtcblx0XHRyZXR1cm4gdGhpcy5fdGV4dHVyZVNpemU7XG5cdH1cblxuXHRwdWJsaWMgc2V0IHRleHR1cmVTaXplKHZhbHVlOm51bWJlcilcblx0e1xuXHRcdHRoaXMuX3RleHR1cmVTaXplID0gdmFsdWU7XG5cdH1cblxuXHQvKipcblx0ICogVGhlIGFtb3VudCBieSB3aGljaCB0aGUgcmVuZGVyZWQgb2JqZWN0IHdpbGwgYmUgaW5mbGF0ZWQsIHRvIHByZXZlbnQgZGVwdGggbWFwIHJvdW5kaW5nIGVycm9ycy5cblx0ICovXG5cdHB1YmxpYyBnZXQgcG9seU9mZnNldCgpOm51bWJlclxuXHR7XG5cdFx0cmV0dXJuIHRoaXMuX3BvbHlPZmZzZXRbMF07XG5cdH1cblxuXHRwdWJsaWMgc2V0IHBvbHlPZmZzZXQodmFsdWU6bnVtYmVyKVxuXHR7XG5cdFx0dGhpcy5fcG9seU9mZnNldFswXSA9IHZhbHVlO1xuXHR9XG5cblx0LyoqXG5cdCAqIENyZWF0ZXMgYSBuZXcgU2luZ2xlT2JqZWN0RGVwdGhQYXNzIG9iamVjdC5cblx0ICovXG5cdGNvbnN0cnVjdG9yKClcblx0e1xuXHRcdHN1cGVyKCk7XG5cblx0XHQvL3RoaXMuX3BOdW1Vc2VkU3RyZWFtcyA9IDI7XG5cdFx0Ly90aGlzLl9wTnVtVXNlZFZlcnRleENvbnN0YW50cyA9IDc7XG5cdFx0Ly90aGlzLl9lbmMgPSBBcnJheTxudW1iZXI+KDEuMCwgMjU1LjAsIDY1MDI1LjAsIDE2NTgxMzc1LjAsIDEuMC8yNTUuMCwgMS4wLzI1NS4wLCAxLjAvMjU1LjAsIDAuMCk7XG5cdFx0Ly9cblx0XHQvL3RoaXMuX3BBbmltYXRhYmxlQXR0cmlidXRlcyA9IEFycmF5PHN0cmluZz4oXCJ2YTBcIiwgXCJ2YTFcIik7XG5cdFx0Ly90aGlzLl9wQW5pbWF0aW9uVGFyZ2V0UmVnaXN0ZXJzID0gQXJyYXk8c3RyaW5nPihcInZ0MFwiLCBcInZ0MVwiKTtcblx0fVxuXG5cdC8qKlxuXHQgKiBAaW5oZXJpdERvY1xuXHQgKi9cblx0cHVibGljIGRpc3Bvc2UoKVxuXHR7XG5cdFx0aWYgKHRoaXMuX3RleHR1cmVzKSB7XG5cdFx0XHRmb3IgKHZhciBrZXkgaW4gdGhpcy5fdGV4dHVyZXMpIHtcblx0XHRcdFx0dmFyIHRleHR1cmU6UmVuZGVyVGV4dHVyZSA9IHRoaXMuX3RleHR1cmVzW2tleV07XG5cdFx0XHRcdHRleHR1cmUuZGlzcG9zZSgpO1xuXHRcdFx0fVxuXHRcdFx0dGhpcy5fdGV4dHVyZXMgPSBudWxsO1xuXHRcdH1cblx0fVxuXG5cdC8qKlxuXHQgKiBVcGRhdGVzIHRoZSBwcm9qZWN0aW9uIHRleHR1cmVzIHVzZWQgdG8gY29udGFpbiB0aGUgZGVwdGggcmVuZGVycy5cblx0ICovXG5cdHByaXZhdGUgdXBkYXRlUHJvamVjdGlvblRleHR1cmVzKClcblx0e1xuXHRcdGlmICh0aGlzLl90ZXh0dXJlcykge1xuXHRcdFx0Zm9yICh2YXIga2V5IGluIHRoaXMuX3RleHR1cmVzKSB7XG5cdFx0XHRcdHZhciB0ZXh0dXJlOlJlbmRlclRleHR1cmUgPSB0aGlzLl90ZXh0dXJlc1trZXldO1xuXHRcdFx0XHR0ZXh0dXJlLmRpc3Bvc2UoKTtcblx0XHRcdH1cblx0XHR9XG5cblx0XHR0aGlzLl90ZXh0dXJlcyA9IG5ldyBPYmplY3QoKTtcblx0XHR0aGlzLl9wcm9qZWN0aW9ucyA9IG5ldyBPYmplY3QoKTtcblx0XHR0aGlzLl9wcm9qZWN0aW9uVGV4dHVyZXNJbnZhbGlkID0gZmFsc2U7XG5cdH1cblxuXHQvKipcblx0ICogQGluaGVyaXREb2Ncblx0ICovXG5cdHB1YmxpYyBfaUdldFZlcnRleENvZGUoKTpzdHJpbmdcblx0e1xuXHRcdHZhciBjb2RlOnN0cmluZztcblx0XHQvLyBvZmZzZXRcblx0XHRjb2RlID0gXCJtdWwgdnQ3LCB2dDEsIHZjNC54XHRcXG5cIiArXG5cdFx0XHRcdFwiYWRkIHZ0NywgdnQ3LCB2dDBcXG5cIiArXG5cdFx0XHRcdFwibW92IHZ0Ny53LCB2dDAud1xcblwiO1xuXHRcdC8vIHByb2plY3Rcblx0XHRjb2RlICs9IFwibTQ0IHZ0MiwgdnQ3LCB2YzBcXG5cIiArXG5cdFx0XHRcdFwibW92IG9wLCB2dDJcXG5cIjtcblxuXHRcdC8vIHBlcnNwZWN0aXZlIGRpdmlkZVxuXHRcdGNvZGUgKz0gXCJkaXYgdjAsIHZ0MiwgdnQyLndcXG5cIjtcblxuXHRcdHJldHVybiBjb2RlO1xuXHR9XG5cblx0LyoqXG5cdCAqIEBpbmhlcml0RG9jXG5cdCAqL1xuXHRwdWJsaWMgX2lHZXRGcmFnbWVudENvZGUoc2hhZGVyT2JqZWN0OlNoYWRlck9iamVjdEJhc2UsIHJlZ2lzdGVyQ2FjaGU6U2hhZGVyUmVnaXN0ZXJDYWNoZSwgc2hhcmVkUmVnaXN0ZXJzOlNoYWRlclJlZ2lzdGVyRGF0YSk6c3RyaW5nXG5cdHtcblx0XHR2YXIgY29kZTpzdHJpbmcgPSBcIlwiO1xuXG5cdFx0Ly8gZW5jb2RlIGZsb2F0IC0+IHJnYmFcblx0XHRjb2RlICs9IFwibXVsIGZ0MCwgZmMwLCB2MC56XFxuXCIgK1xuXHRcdFx0XHRcImZyYyBmdDAsIGZ0MFxcblwiICtcblx0XHRcdFx0XCJtdWwgZnQxLCBmdDAueXp3dywgZmMxXFxuXCIgK1xuXHRcdFx0XHRcInN1YiBmdDAsIGZ0MCwgZnQxXFxuXCIgK1xuXHRcdFx0XHRcIm1vdiBvYywgZnQwXFxuXCI7XG5cblx0XHRyZXR1cm4gY29kZTtcblx0fVxuXG5cdC8qKlxuXHQgKiBHZXRzIHRoZSBkZXB0aCBtYXBzIHJlbmRlcmVkIGZvciB0aGlzIG9iamVjdCBmcm9tIGFsbCBsaWdodHMuXG5cdCAqIEBwYXJhbSByZW5kZXJhYmxlIFRoZSByZW5kZXJhYmxlIGZvciB3aGljaCB0byByZXRyaWV2ZSB0aGUgZGVwdGggbWFwcy5cblx0ICogQHBhcmFtIHN0YWdlM0RQcm94eSBUaGUgU3RhZ2UzRFByb3h5IG9iamVjdCBjdXJyZW50bHkgdXNlZCBmb3IgcmVuZGVyaW5nLlxuXHQgKiBAcmV0dXJuIEEgbGlzdCBvZiBkZXB0aCBtYXAgdGV4dHVyZXMgZm9yIGFsbCBzdXBwb3J0ZWQgbGlnaHRzLlxuXHQgKi9cblx0cHVibGljIF9pR2V0RGVwdGhNYXAocmVuZGVyYWJsZTpSZW5kZXJhYmxlQmFzZSk6UmVuZGVyVGV4dHVyZVxuXHR7XG5cdFx0cmV0dXJuIHRoaXMuX3RleHR1cmVzW3JlbmRlcmFibGUubWF0ZXJpYWxPd25lci5pZF07XG5cdH1cblxuXHQvKipcblx0ICogUmV0cmlldmVzIHRoZSBkZXB0aCBtYXAgcHJvamVjdGlvbiBtYXBzIGZvciBhbGwgbGlnaHRzLlxuXHQgKiBAcGFyYW0gcmVuZGVyYWJsZSBUaGUgcmVuZGVyYWJsZSBmb3Igd2hpY2ggdG8gcmV0cmlldmUgdGhlIHByb2plY3Rpb24gbWFwcy5cblx0ICogQHJldHVybiBBIGxpc3Qgb2YgcHJvamVjdGlvbiBtYXBzIGZvciBhbGwgc3VwcG9ydGVkIGxpZ2h0cy5cblx0ICovXG5cdHB1YmxpYyBfaUdldFByb2plY3Rpb24ocmVuZGVyYWJsZTpSZW5kZXJhYmxlQmFzZSk6TWF0cml4M0Rcblx0e1xuXHRcdHJldHVybiB0aGlzLl9wcm9qZWN0aW9uc1tyZW5kZXJhYmxlLm1hdGVyaWFsT3duZXIuaWRdO1xuXHR9XG5cblx0LyoqXG5cdCAqIEBpbmhlcml0RG9jXG5cdCAqL1xuXHRwdWJsaWMgX2lSZW5kZXIocGFzczpNYXRlcmlhbFBhc3NEYXRhLCByZW5kZXJhYmxlOlJlbmRlcmFibGVCYXNlLCBzdGFnZTpTdGFnZSwgY2FtZXJhOkNhbWVyYSwgdmlld1Byb2plY3Rpb246TWF0cml4M0QpXG5cdHtcblx0XHR2YXIgbWF0cml4Ok1hdHJpeDNEO1xuXHRcdHZhciBjb250ZXh0OklDb250ZXh0R0wgPSBzdGFnZS5jb250ZXh0O1xuXHRcdHZhciBsZW46bnVtYmVyIC8qdWludCovO1xuXHRcdHZhciBsaWdodDpMaWdodEJhc2U7XG5cdFx0dmFyIGxpZ2h0czpBcnJheTxMaWdodEJhc2U+ID0gdGhpcy5fcExpZ2h0UGlja2VyLmFsbFBpY2tlZExpZ2h0cztcblx0XHR2YXIgcklkOm51bWJlciA9IHJlbmRlcmFibGUubWF0ZXJpYWxPd25lci5pZDtcblxuXHRcdGlmICghdGhpcy5fdGV4dHVyZXNbcklkXSlcblx0XHRcdHRoaXMuX3RleHR1cmVzW3JJZF0gPSBuZXcgUmVuZGVyVGV4dHVyZSh0aGlzLl90ZXh0dXJlU2l6ZSwgdGhpcy5fdGV4dHVyZVNpemUpO1xuXG5cdFx0aWYgKCF0aGlzLl9wcm9qZWN0aW9uc1tySWRdKVxuXHRcdFx0dGhpcy5fcHJvamVjdGlvbnNbcklkXSA9IG5ldyBNYXRyaXgzRCgpO1xuXG5cdFx0bGVuID0gbGlnaHRzLmxlbmd0aDtcblxuXHRcdC8vIGxvY2FsIHBvc2l0aW9uID0gZW5vdWdoXG5cdFx0bGlnaHQgPSBsaWdodHNbMF07XG5cblx0XHRtYXRyaXggPSBsaWdodC5pR2V0T2JqZWN0UHJvamVjdGlvbk1hdHJpeChyZW5kZXJhYmxlLnNvdXJjZUVudGl0eSwgY2FtZXJhLCB0aGlzLl9wcm9qZWN0aW9uc1tySWRdKTtcblxuXHRcdHN0YWdlLnNldFJlbmRlclRhcmdldCh0aGlzLl90ZXh0dXJlc1tySWRdLCB0cnVlKTtcblx0XHRjb250ZXh0LmNsZWFyKDEuMCwgMS4wLCAxLjApO1xuXHRcdGNvbnRleHQuc2V0UHJvZ3JhbUNvbnN0YW50c0Zyb21NYXRyaXgoQ29udGV4dEdMUHJvZ3JhbVR5cGUuVkVSVEVYLCAwLCBtYXRyaXgsIHRydWUpO1xuXHRcdGNvbnRleHQuc2V0UHJvZ3JhbUNvbnN0YW50c0Zyb21BcnJheShDb250ZXh0R0xQcm9ncmFtVHlwZS5GUkFHTUVOVCwgMCwgdGhpcy5fZW5jLCAyKTtcblxuXHRcdHN0YWdlLmFjdGl2YXRlQnVmZmVyKDAsIHJlbmRlcmFibGUuZ2V0VmVydGV4RGF0YShUcmlhbmdsZVN1Ykdlb21ldHJ5LlBPU0lUSU9OX0RBVEEpLCByZW5kZXJhYmxlLmdldFZlcnRleE9mZnNldChUcmlhbmdsZVN1Ykdlb21ldHJ5LlBPU0lUSU9OX0RBVEEpLCBUcmlhbmdsZVN1Ykdlb21ldHJ5LlBPU0lUSU9OX0ZPUk1BVCk7XG5cdFx0c3RhZ2UuYWN0aXZhdGVCdWZmZXIoMSwgcmVuZGVyYWJsZS5nZXRWZXJ0ZXhEYXRhKFRyaWFuZ2xlU3ViR2VvbWV0cnkuTk9STUFMX0RBVEEpLCByZW5kZXJhYmxlLmdldFZlcnRleE9mZnNldChUcmlhbmdsZVN1Ykdlb21ldHJ5Lk5PUk1BTF9EQVRBKSwgVHJpYW5nbGVTdWJHZW9tZXRyeS5OT1JNQUxfRk9STUFUKTtcblx0XHRjb250ZXh0LmRyYXdUcmlhbmdsZXMoc3RhZ2UuZ2V0SW5kZXhCdWZmZXIocmVuZGVyYWJsZS5nZXRJbmRleERhdGEoKSksIDAsIHJlbmRlcmFibGUubnVtVHJpYW5nbGVzKTtcblx0fVxuXG5cdC8qKlxuXHQgKiBAaW5oZXJpdERvY1xuXHQgKi9cblx0cHVibGljIF9pQWN0aXZhdGUocGFzczpNYXRlcmlhbFBhc3NEYXRhLCByZW5kZXJlcjpSZW5kZXJlckJhc2UsIGNhbWVyYTpDYW1lcmEpXG5cdHtcblx0XHRpZiAodGhpcy5fcHJvamVjdGlvblRleHR1cmVzSW52YWxpZClcblx0XHRcdHRoaXMudXBkYXRlUHJvamVjdGlvblRleHR1cmVzKCk7XG5cblx0XHQvLyBuZXZlciBzY2FsZVxuXHRcdHN1cGVyLl9pQWN0aXZhdGUocGFzcywgcmVuZGVyZXIsIGNhbWVyYSk7XG5cblx0XHRyZW5kZXJlci5jb250ZXh0LnNldFByb2dyYW1Db25zdGFudHNGcm9tQXJyYXkoQ29udGV4dEdMUHJvZ3JhbVR5cGUuVkVSVEVYLCA0LCB0aGlzLl9wb2x5T2Zmc2V0LCAxKTtcblx0fVxufVxuXG5leHBvcnQgPSBTaW5nbGVPYmplY3REZXB0aFBhc3M7Il19