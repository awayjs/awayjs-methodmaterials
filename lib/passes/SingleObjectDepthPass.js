var __extends = this.__extends || function (d, b) {
    for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p];
    function __() { this.constructor = d; }
    __.prototype = b.prototype;
    d.prototype = new __();
};
var Matrix3D = require("awayjs-core/lib/geom/Matrix3D");
var RenderTexture = require("awayjs-core/lib/textures/RenderTexture");
var TriangleSubGeometry = require("awayjs-display/lib/base/TriangleSubGeometry");
var ContextGLProgramType = require("awayjs-stagegl/lib/base/ContextGLProgramType");
var RenderPassBase = require("awayjs-renderergl/lib/passes/RenderPassBase");
/**
 * The SingleObjectDepthPass provides a material pass that renders a single object to a depth map from the point
 * of view from a light.
 */
var SingleObjectDepthPass = (function (_super) {
    __extends(SingleObjectDepthPass, _super);
    /**
     * Creates a new SingleObjectDepthPass object.
     */
    function SingleObjectDepthPass(renderObject, renderObjectOwner, renderableClass, stage) {
        _super.call(this, renderObject, renderObjectOwner, renderableClass, stage);
        this._textureSize = 512;
        this._polyOffset = Array(15, 0, 0, 0);
        this._projectionTexturesInvalid = true;
        //this._pNumUsedStreams = 2;
        //this._pNumUsedVertexConstants = 7;
        //this._enc = Array<number>(1.0, 255.0, 65025.0, 16581375.0, 1.0/255.0, 1.0/255.0, 1.0/255.0, 0.0);
        //
        //this._pAnimatableAttributes = Array<string>("va0", "va1");
        //this._pAnimationTargetRegisters = Array<string>("vt0", "vt1");
    }
    Object.defineProperty(SingleObjectDepthPass.prototype, "textureSize", {
        /**
         * The size of the depth map texture to render to.
         */
        get: function () {
            return this._textureSize;
        },
        set: function (value) {
            this._textureSize = value;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(SingleObjectDepthPass.prototype, "polyOffset", {
        /**
         * The amount by which the rendered object will be inflated, to prevent depth map rounding errors.
         */
        get: function () {
            return this._polyOffset[0];
        },
        set: function (value) {
            this._polyOffset[0] = value;
        },
        enumerable: true,
        configurable: true
    });
    /**
     * @inheritDoc
     */
    SingleObjectDepthPass.prototype.dispose = function () {
        if (this._textures) {
            for (var key in this._textures) {
                var texture = this._textures[key];
                texture.dispose();
            }
            this._textures = null;
        }
    };
    /**
     * Updates the projection textures used to contain the depth renders.
     */
    SingleObjectDepthPass.prototype.updateProjectionTextures = function () {
        if (this._textures) {
            for (var key in this._textures) {
                var texture = this._textures[key];
                texture.dispose();
            }
        }
        this._textures = new Object();
        this._projections = new Object();
        this._projectionTexturesInvalid = false;
    };
    /**
     * @inheritDoc
     */
    SingleObjectDepthPass.prototype._iGetVertexCode = function () {
        var code;
        // offset
        code = "mul vt7, vt1, vc4.x	\n" + "add vt7, vt7, vt0\n" + "mov vt7.w, vt0.w\n";
        // project
        code += "m44 vt2, vt7, vc0\n" + "mov op, vt2\n";
        // perspective divide
        code += "div v0, vt2, vt2.w\n";
        return code;
    };
    /**
     * @inheritDoc
     */
    SingleObjectDepthPass.prototype._iGetFragmentCode = function (shaderObject, registerCache, sharedRegisters) {
        var code = "";
        // encode float -> rgba
        code += "mul ft0, fc0, v0.z\n" + "frc ft0, ft0\n" + "mul ft1, ft0.yzww, fc1\n" + "sub ft0, ft0, ft1\n" + "mov oc, ft0\n";
        return code;
    };
    /**
     * Gets the depth maps rendered for this object from all lights.
     * @param renderable The renderable for which to retrieve the depth maps.
     * @param stage3DProxy The Stage3DProxy object currently used for rendering.
     * @return A list of depth map textures for all supported lights.
     */
    SingleObjectDepthPass.prototype._iGetDepthMap = function (renderable) {
        return this._textures[renderable.renderableOwner.id];
    };
    /**
     * Retrieves the depth map projection maps for all lights.
     * @param renderable The renderable for which to retrieve the projection maps.
     * @return A list of projection maps for all supported lights.
     */
    SingleObjectDepthPass.prototype._iGetProjection = function (renderable) {
        return this._projections[renderable.renderableOwner.id];
    };
    /**
     * @inheritDoc
     */
    SingleObjectDepthPass.prototype._iRender = function (renderable, camera, viewProjection) {
        var matrix;
        var context = this._stage.context;
        var len /*uint*/;
        var light;
        var lights = this._renderObjectOwner.lightPicker.allPickedLights;
        var rId = renderable.renderableOwner.id;
        if (!this._textures[rId])
            this._textures[rId] = new RenderTexture(this._textureSize, this._textureSize);
        if (!this._projections[rId])
            this._projections[rId] = new Matrix3D();
        len = lights.length;
        // local position = enough
        light = lights[0];
        matrix = light.iGetObjectProjectionMatrix(renderable.sourceEntity, camera, this._projections[rId]);
        this._stage.setRenderTarget(this._textures[rId], true);
        context.clear(1.0, 1.0, 1.0);
        context.setProgramConstantsFromMatrix(ContextGLProgramType.VERTEX, 0, matrix, true);
        context.setProgramConstantsFromArray(ContextGLProgramType.FRAGMENT, 0, this._enc, 2);
        this._stage.activateBuffer(0, renderable.getVertexData(TriangleSubGeometry.POSITION_DATA), renderable.getVertexOffset(TriangleSubGeometry.POSITION_DATA), TriangleSubGeometry.POSITION_FORMAT);
        this._stage.activateBuffer(1, renderable.getVertexData(TriangleSubGeometry.NORMAL_DATA), renderable.getVertexOffset(TriangleSubGeometry.NORMAL_DATA), TriangleSubGeometry.NORMAL_FORMAT);
        context.drawTriangles(this._stage.getIndexBuffer(renderable.getIndexData()), 0, renderable.numTriangles);
    };
    /**
     * @inheritDoc
     */
    SingleObjectDepthPass.prototype._iActivate = function (camera) {
        if (this._projectionTexturesInvalid)
            this.updateProjectionTextures();
        // never scale
        _super.prototype._iActivate.call(this, camera);
        this._stage.context.setProgramConstantsFromArray(ContextGLProgramType.VERTEX, 4, this._polyOffset, 1);
    };
    return SingleObjectDepthPass;
})(RenderPassBase);
module.exports = SingleObjectDepthPass;

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImF3YXlqcy1tZXRob2RtYXRlcmlhbHMvbGliL3Bhc3Nlcy9TaW5nbGVPYmplY3REZXB0aFBhc3MudHMiXSwibmFtZXMiOlsiU2luZ2xlT2JqZWN0RGVwdGhQYXNzIiwiU2luZ2xlT2JqZWN0RGVwdGhQYXNzLmNvbnN0cnVjdG9yIiwiU2luZ2xlT2JqZWN0RGVwdGhQYXNzLnRleHR1cmVTaXplIiwiU2luZ2xlT2JqZWN0RGVwdGhQYXNzLnBvbHlPZmZzZXQiLCJTaW5nbGVPYmplY3REZXB0aFBhc3MuZGlzcG9zZSIsIlNpbmdsZU9iamVjdERlcHRoUGFzcy51cGRhdGVQcm9qZWN0aW9uVGV4dHVyZXMiLCJTaW5nbGVPYmplY3REZXB0aFBhc3MuX2lHZXRWZXJ0ZXhDb2RlIiwiU2luZ2xlT2JqZWN0RGVwdGhQYXNzLl9pR2V0RnJhZ21lbnRDb2RlIiwiU2luZ2xlT2JqZWN0RGVwdGhQYXNzLl9pR2V0RGVwdGhNYXAiLCJTaW5nbGVPYmplY3REZXB0aFBhc3MuX2lHZXRQcm9qZWN0aW9uIiwiU2luZ2xlT2JqZWN0RGVwdGhQYXNzLl9pUmVuZGVyIiwiU2luZ2xlT2JqZWN0RGVwdGhQYXNzLl9pQWN0aXZhdGUiXSwibWFwcGluZ3MiOiI7Ozs7OztBQUFBLElBQU8sUUFBUSxXQUFpQiwrQkFBK0IsQ0FBQyxDQUFDO0FBQ2pFLElBQU8sYUFBYSxXQUFlLHdDQUF3QyxDQUFDLENBQUM7QUFHN0UsSUFBTyxtQkFBbUIsV0FBYyw2Q0FBNkMsQ0FBQyxDQUFDO0FBS3ZGLElBQU8sb0JBQW9CLFdBQWMsOENBQThDLENBQUMsQ0FBQztBQVd6RixJQUFPLGNBQWMsV0FBZSw2Q0FBNkMsQ0FBQyxDQUFDO0FBRW5GLEFBSUE7OztHQURHO0lBQ0cscUJBQXFCO0lBQVNBLFVBQTlCQSxxQkFBcUJBLFVBQXVCQTtJQW1DakRBOztPQUVHQTtJQUNIQSxTQXRDS0EscUJBQXFCQSxDQXNDZEEsWUFBNkJBLEVBQUVBLGlCQUFvQ0EsRUFBRUEsZUFBZ0NBLEVBQUVBLEtBQVdBO1FBRTdI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QUFDQSxlQUFlQSxDQUFDQTtRQUNsRkEsSUFBSUEsR0FBR0EsR0FBVUEsVUFBVUEsQ0FBQ0EsZUFBZUEsQ0FBQ0EsRUFBRUEsQ0FBQ0E7UUFFL0NBLEVBQUVBLENBQUNBLENBQUNBLENBQUNBLElBQUlBLENBQUNBLFNBQVNBLENBQUNBLEdBQUdBLENBQUNBLENBQUNBO1lBQ3hCQSxJQUFJQSxDQUFDQSxTQUFTQSxDQUFDQSxHQUFHQSxDQUFDQSxHQUFHQSxJQUFJQSxhQUFhQSxDQUFDQSxJQUFJQSxDQUFDQSxZQUFZQSxFQUFFQSxJQUFJQSxDQUFDQSxZQUFZQSxDQUFDQSxDQUFDQTtRQUUvRUEsRUFBRUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsSUFBSUEsQ0FBQ0EsWUFBWUEsQ0FBQ0EsR0FBR0EsQ0FBQ0EsQ0FBQ0E7WUFDM0JBLElBQUlBLENBQUNBLFlBQVlBLENBQUNBLEdBQUdBLENBQUNBLEdBQUdBLElBQUlBLFFBQVFBLEVBQUVBLENBQUNBO1FBRXpDQSxHQUFHQSxHQUFHQSxNQUFNQSxDQUFDQSxNQUFNQSxDQUFDQTtRQUVwQkEsQUFDQUEsMEJBRDBCQTtRQUMxQkEsS0FBS0EsR0FBR0EsTUFBTUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7UUFFbEJBLE1BQU1BLEdBQUdBLEtBQUtBLENBQUNBLDBCQUEwQkEsQ0FBQ0EsVUFBVUEsQ0FBQ0EsWUFBWUEsRUFBRUEsTUFBTUEsRUFBRUEsSUFBSUEsQ0FBQ0EsWUFBWUEsQ0FBQ0EsR0FBR0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7UUFFbkdBLElBQUlBLENBQUNBLE1BQU1BLENBQUNBLGVBQWVBLENBQUNBLElBQUlBLENBQUNBLFNBQVNBLENBQUNBLEdBQUdBLENBQUNBLEVBQUVBLElBQUlBLENBQUNBLENBQUNBO1FBQ3ZEQSxPQUFPQSxDQUFDQSxLQUFLQSxDQUFDQSxHQUFHQSxFQUFFQSxHQUFHQSxFQUFFQSxHQUFHQSxDQUFDQSxDQUFDQTtRQUM3QkEsT0FBT0EsQ0FBQ0EsNkJBQTZCQSxDQUFDQSxvQkFBb0JBLENBQUNBLE1BQU1BLEVBQUVBLENBQUNBLEVBQUVBLE1BQU1BLEVBQUVBLElBQUlBLENBQUNBLENBQUNBO1FBQ3BGQSxPQUFPQSxDQUFDQSw0QkFBNEJBLENBQUNBLG9CQUFvQkEsQ0FBQ0EsUUFBUUEsRUFBRUEsQ0FBQ0EsRUFBRUEsSUFBSUEsQ0FBQ0EsSUFBSUEsRUFBRUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7UUFFckZBLElBQUlBLENBQUNBLE1BQU1BLENBQUNBLGNBQWNBLENBQUNBLENBQUNBLEVBQUVBLFVBQVVBLENBQUNBLGFBQWFBLENBQUNBLG1CQUFtQkEsQ0FBQ0EsYUFBYUEsQ0FBQ0EsRUFBRUEsVUFBVUEsQ0FBQ0EsZUFBZUEsQ0FBQ0EsbUJBQW1CQSxDQUFDQSxhQUFhQSxDQUFDQSxFQUFFQSxtQkFBbUJBLENBQUNBLGVBQWVBLENBQUNBLENBQUNBO1FBQy9MQSxJQUFJQSxDQUFDQSxNQUFNQSxDQUFDQSxjQUFjQSxDQUFDQSxDQUFDQSxFQUFFQSxVQUFVQSxDQUFDQSxhQUFhQSxDQUFDQSxtQkFBbUJBLENBQUNBLFdBQVdBLENBQUNBLEVBQUVBLFVBQVVBLENBQUNBLGVBQWVBLENBQUNBLG1CQUFtQkEsQ0FBQ0EsV0FBV0EsQ0FBQ0EsRUFBRUEsbUJBQW1CQSxDQUFDQSxhQUFhQSxDQUFDQSxDQUFDQTtRQUN6TEEsT0FBT0EsQ0FBQ0EsYUFBYUEsQ0FBQ0EsSUFBSUEsQ0FBQ0EsTUFBTUEsQ0FBQ0EsY0FBY0EsQ0FBQ0EsVUFBVUEsQ0FBQ0EsWUFBWUEsRUFBRUEsQ0FBQ0EsRUFBRUEsQ0FBQ0EsRUFBRUEsVUFBVUEsQ0FBQ0EsWUFBWUEsQ0FBQ0EsQ0FBQ0E7SUFDMUdBLENBQUNBO0lBRURWOztPQUVHQTtJQUNJQSwwQ0FBVUEsR0FBakJBLFVBQWtCQSxNQUFhQTtRQUU5QlcsRUFBRUEsQ0FBQ0EsQ0FBQ0EsSUFBSUEsQ0FBQ0EsMEJBQTBCQSxDQUFDQTtZQUNuQ0EsSUFBSUEsQ0FBQ0Esd0JBQXdCQSxFQUFFQSxDQUFDQTtRQUVqQ0EsQUFDQUEsY0FEY0E7UUFDZEEsZ0JBQUtBLENBQUNBLFVBQVVBLFlBQUNBLE1BQU1BLENBQUNBLENBQUNBO1FBRXpCQSxJQUFJQSxDQUFDQSxNQUFNQSxDQUFDQSxPQUFPQSxDQUFDQSw0QkFBNEJBLENBQUNBLG9CQUFvQkEsQ0FBQ0EsTUFBTUEsRUFBRUEsQ0FBQ0EsRUFBRUEsSUFBSUEsQ0FBQ0EsV0FBV0EsRUFBRUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7SUFDdkdBLENBQUNBO0lBQ0ZYLDRCQUFDQTtBQUFEQSxDQTNMQSxBQTJMQ0EsRUEzTG1DLGNBQWMsRUEyTGpEO0FBRUQsQUFBK0IsaUJBQXRCLHFCQUFxQixDQUFDIiwiZmlsZSI6InBhc3Nlcy9TaW5nbGVPYmplY3REZXB0aFBhc3MuanMiLCJzb3VyY2VSb290IjoiLi4vIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IE1hdHJpeDNEXHRcdFx0XHRcdFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtY29yZS9saWIvZ2VvbS9NYXRyaXgzRFwiKTtcbmltcG9ydCBSZW5kZXJUZXh0dXJlXHRcdFx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1jb3JlL2xpYi90ZXh0dXJlcy9SZW5kZXJUZXh0dXJlXCIpO1xuXG5pbXBvcnQgTGlnaHRCYXNlXHRcdFx0XHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLWRpc3BsYXkvbGliL2Jhc2UvTGlnaHRCYXNlXCIpO1xuaW1wb3J0IFRyaWFuZ2xlU3ViR2VvbWV0cnlcdFx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1kaXNwbGF5L2xpYi9iYXNlL1RyaWFuZ2xlU3ViR2VvbWV0cnlcIik7XG5pbXBvcnQgQ2FtZXJhXHRcdFx0XHRcdFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtZGlzcGxheS9saWIvZW50aXRpZXMvQ2FtZXJhXCIpO1xuaW1wb3J0IE1hdGVyaWFsQmFzZVx0XHRcdFx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1kaXNwbGF5L2xpYi9tYXRlcmlhbHMvTWF0ZXJpYWxCYXNlXCIpO1xuaW1wb3J0IElSZW5kZXJPYmplY3RPd25lclx0XHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLWRpc3BsYXkvbGliL2Jhc2UvSVJlbmRlck9iamVjdE93bmVyXCIpO1xuXG5pbXBvcnQgQ29udGV4dEdMUHJvZ3JhbVR5cGVcdFx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1zdGFnZWdsL2xpYi9iYXNlL0NvbnRleHRHTFByb2dyYW1UeXBlXCIpO1xuaW1wb3J0IElDb250ZXh0R0xcdFx0XHRcdFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtc3RhZ2VnbC9saWIvYmFzZS9JQ29udGV4dEdMXCIpO1xuaW1wb3J0IFN0YWdlXHRcdFx0XHRcdFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtc3RhZ2VnbC9saWIvYmFzZS9TdGFnZVwiKTtcblxuaW1wb3J0IFJlbmRlcmVyQmFzZVx0XHRcdFx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1yZW5kZXJlcmdsL2xpYi9iYXNlL1JlbmRlcmVyQmFzZVwiKTtcbmltcG9ydCBSZW5kZXJPYmplY3RCYXNlXHRcdFx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1yZW5kZXJlcmdsL2xpYi9jb21waWxhdGlvbi9SZW5kZXJPYmplY3RCYXNlXCIpO1xuaW1wb3J0IFJlbmRlcmFibGVCYXNlXHRcdFx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1yZW5kZXJlcmdsL2xpYi9wb29sL1JlbmRlcmFibGVCYXNlXCIpO1xuaW1wb3J0IFNoYWRlck9iamVjdEJhc2VcdFx0XHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLXJlbmRlcmVyZ2wvbGliL2NvbXBpbGF0aW9uL1NoYWRlck9iamVjdEJhc2VcIik7XG5pbXBvcnQgU2hhZGVyUmVnaXN0ZXJDYWNoZVx0XHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLXJlbmRlcmVyZ2wvbGliL2NvbXBpbGF0aW9uL1NoYWRlclJlZ2lzdGVyQ2FjaGVcIik7XG5pbXBvcnQgU2hhZGVyUmVnaXN0ZXJEYXRhXHRcdFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtcmVuZGVyZXJnbC9saWIvY29tcGlsYXRpb24vU2hhZGVyUmVnaXN0ZXJEYXRhXCIpO1xuaW1wb3J0IElSZW5kZXJhYmxlQ2xhc3NcdFx0XHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLXJlbmRlcmVyZ2wvbGliL3Bvb2wvSVJlbmRlcmFibGVDbGFzc1wiKTtcbmltcG9ydCBSZW5kZXJQYXNzQmFzZVx0XHRcdFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtcmVuZGVyZXJnbC9saWIvcGFzc2VzL1JlbmRlclBhc3NCYXNlXCIpO1xuXG4vKipcbiAqIFRoZSBTaW5nbGVPYmplY3REZXB0aFBhc3MgcHJvdmlkZXMgYSBtYXRlcmlhbCBwYXNzIHRoYXQgcmVuZGVycyBhIHNpbmdsZSBvYmplY3QgdG8gYSBkZXB0aCBtYXAgZnJvbSB0aGUgcG9pbnRcbiAqIG9mIHZpZXcgZnJvbSBhIGxpZ2h0LlxuICovXG5jbGFzcyBTaW5nbGVPYmplY3REZXB0aFBhc3MgZXh0ZW5kcyBSZW5kZXJQYXNzQmFzZVxue1xuXHRwcml2YXRlIF90ZXh0dXJlczpPYmplY3Q7XG5cdHByaXZhdGUgX3Byb2plY3Rpb25zOk9iamVjdDtcblx0cHJpdmF0ZSBfdGV4dHVyZVNpemU6bnVtYmVyIC8qdWludCovID0gNTEyO1xuXHRwcml2YXRlIF9wb2x5T2Zmc2V0OkFycmF5PG51bWJlcj4gPSBBcnJheTxudW1iZXI+KDE1LCAwLCAwLCAwKTtcblx0cHJpdmF0ZSBfZW5jOkFycmF5PG51bWJlcj47XG5cdHByaXZhdGUgX3Byb2plY3Rpb25UZXh0dXJlc0ludmFsaWQ6Qm9vbGVhbiA9IHRydWU7XG5cblx0LyoqXG5cdCAqIFRoZSBzaXplIG9mIHRoZSBkZXB0aCBtYXAgdGV4dHVyZSB0byByZW5kZXIgdG8uXG5cdCAqL1xuXHRwdWJsaWMgZ2V0IHRleHR1cmVTaXplKCk6bnVtYmVyXG5cdHtcblx0XHRyZXR1cm4gdGhpcy5fdGV4dHVyZVNpemU7XG5cdH1cblxuXHRwdWJsaWMgc2V0IHRleHR1cmVTaXplKHZhbHVlOm51bWJlcilcblx0e1xuXHRcdHRoaXMuX3RleHR1cmVTaXplID0gdmFsdWU7XG5cdH1cblxuXHQvKipcblx0ICogVGhlIGFtb3VudCBieSB3aGljaCB0aGUgcmVuZGVyZWQgb2JqZWN0IHdpbGwgYmUgaW5mbGF0ZWQsIHRvIHByZXZlbnQgZGVwdGggbWFwIHJvdW5kaW5nIGVycm9ycy5cblx0ICovXG5cdHB1YmxpYyBnZXQgcG9seU9mZnNldCgpOm51bWJlclxuXHR7XG5cdFx0cmV0dXJuIHRoaXMuX3BvbHlPZmZzZXRbMF07XG5cdH1cblxuXHRwdWJsaWMgc2V0IHBvbHlPZmZzZXQodmFsdWU6bnVtYmVyKVxuXHR7XG5cdFx0dGhpcy5fcG9seU9mZnNldFswXSA9IHZhbHVlO1xuXHR9XG5cblx0LyoqXG5cdCAqIENyZWF0ZXMgYSBuZXcgU2luZ2xlT2JqZWN0RGVwdGhQYXNzIG9iamVjdC5cblx0ICovXG5cdGNvbnN0cnVjdG9yKHJlbmRlck9iamVjdDpSZW5kZXJPYmplY3RCYXNlLCByZW5kZXJPYmplY3RPd25lcjpJUmVuZGVyT2JqZWN0T3duZXIsIHJlbmRlcmFibGVDbGFzczpJUmVuZGVyYWJsZUNsYXNzLCBzdGFnZTpTdGFnZSlcblx0e1xuXHRcdHN1cGVyKHJlbmRlck9iamVjdCwgcmVuZGVyT2JqZWN0T3duZXIsIHJlbmRlcmFibGVDbGFzcywgc3RhZ2UpO1xuXG5cdFx0Ly90aGlzLl9wTnVtVXNlZFN0cmVhbXMgPSAyO1xuXHRcdC8vdGhpcy5fcE51bVVzZWRWZXJ0ZXhDb25zdGFudHMgPSA3O1xuXHRcdC8vdGhpcy5fZW5jID0gQXJyYXk8bnVtYmVyPigxLjAsIDI1NS4wLCA2NTAyNS4wLCAxNjU4MTM3NS4wLCAxLjAvMjU1LjAsIDEuMC8yNTUuMCwgMS4wLzI1NS4wLCAwLjApO1xuXHRcdC8vXG5cdFx0Ly90aGlzLl9wQW5pbWF0YWJsZUF0dHJpYnV0ZXMgPSBBcnJheTxzdHJpbmc+KFwidmEwXCIsIFwidmExXCIpO1xuXHRcdC8vdGhpcy5fcEFuaW1hdGlvblRhcmdldFJlZ2lzdGVycyA9IEFycmF5PHN0cmluZz4oXCJ2dDBcIiwgXCJ2dDFcIik7XG5cdH1cblxuXHQvKipcblx0ICogQGluaGVyaXREb2Ncblx0ICovXG5cdHB1YmxpYyBkaXNwb3NlKClcblx0e1xuXHRcdGlmICh0aGlzLl90ZXh0dXJlcykge1xuXHRcdFx0Zm9yICh2YXIga2V5IGluIHRoaXMuX3RleHR1cmVzKSB7XG5cdFx0XHRcdHZhciB0ZXh0dXJlOlJlbmRlclRleHR1cmUgPSB0aGlzLl90ZXh0dXJlc1trZXldO1xuXHRcdFx0XHR0ZXh0dXJlLmRpc3Bvc2UoKTtcblx0XHRcdH1cblx0XHRcdHRoaXMuX3RleHR1cmVzID0gbnVsbDtcblx0XHR9XG5cdH1cblxuXHQvKipcblx0ICogVXBkYXRlcyB0aGUgcHJvamVjdGlvbiB0ZXh0dXJlcyB1c2VkIHRvIGNvbnRhaW4gdGhlIGRlcHRoIHJlbmRlcnMuXG5cdCAqL1xuXHRwcml2YXRlIHVwZGF0ZVByb2plY3Rpb25UZXh0dXJlcygpXG5cdHtcblx0XHRpZiAodGhpcy5fdGV4dHVyZXMpIHtcblx0XHRcdGZvciAodmFyIGtleSBpbiB0aGlzLl90ZXh0dXJlcykge1xuXHRcdFx0XHR2YXIgdGV4dHVyZTpSZW5kZXJUZXh0dXJlID0gdGhpcy5fdGV4dHVyZXNba2V5XTtcblx0XHRcdFx0dGV4dHVyZS5kaXNwb3NlKCk7XG5cdFx0XHR9XG5cdFx0fVxuXG5cdFx0dGhpcy5fdGV4dHVyZXMgPSBuZXcgT2JqZWN0KCk7XG5cdFx0dGhpcy5fcHJvamVjdGlvbnMgPSBuZXcgT2JqZWN0KCk7XG5cdFx0dGhpcy5fcHJvamVjdGlvblRleHR1cmVzSW52YWxpZCA9IGZhbHNlO1xuXHR9XG5cblx0LyoqXG5cdCAqIEBpbmhlcml0RG9jXG5cdCAqL1xuXHRwdWJsaWMgX2lHZXRWZXJ0ZXhDb2RlKCk6c3RyaW5nXG5cdHtcblx0XHR2YXIgY29kZTpzdHJpbmc7XG5cdFx0Ly8gb2Zmc2V0XG5cdFx0Y29kZSA9IFwibXVsIHZ0NywgdnQxLCB2YzQueFx0XFxuXCIgK1xuXHRcdFx0XHRcImFkZCB2dDcsIHZ0NywgdnQwXFxuXCIgK1xuXHRcdFx0XHRcIm1vdiB2dDcudywgdnQwLndcXG5cIjtcblx0XHQvLyBwcm9qZWN0XG5cdFx0Y29kZSArPSBcIm00NCB2dDIsIHZ0NywgdmMwXFxuXCIgK1xuXHRcdFx0XHRcIm1vdiBvcCwgdnQyXFxuXCI7XG5cblx0XHQvLyBwZXJzcGVjdGl2ZSBkaXZpZGVcblx0XHRjb2RlICs9IFwiZGl2IHYwLCB2dDIsIHZ0Mi53XFxuXCI7XG5cblx0XHRyZXR1cm4gY29kZTtcblx0fVxuXG5cdC8qKlxuXHQgKiBAaW5oZXJpdERvY1xuXHQgKi9cblx0cHVibGljIF9pR2V0RnJhZ21lbnRDb2RlKHNoYWRlck9iamVjdDpTaGFkZXJPYmplY3RCYXNlLCByZWdpc3RlckNhY2hlOlNoYWRlclJlZ2lzdGVyQ2FjaGUsIHNoYXJlZFJlZ2lzdGVyczpTaGFkZXJSZWdpc3RlckRhdGEpOnN0cmluZ1xuXHR7XG5cdFx0dmFyIGNvZGU6c3RyaW5nID0gXCJcIjtcblxuXHRcdC8vIGVuY29kZSBmbG9hdCAtPiByZ2JhXG5cdFx0Y29kZSArPSBcIm11bCBmdDAsIGZjMCwgdjAuelxcblwiICtcblx0XHRcdFx0XCJmcmMgZnQwLCBmdDBcXG5cIiArXG5cdFx0XHRcdFwibXVsIGZ0MSwgZnQwLnl6d3csIGZjMVxcblwiICtcblx0XHRcdFx0XCJzdWIgZnQwLCBmdDAsIGZ0MVxcblwiICtcblx0XHRcdFx0XCJtb3Ygb2MsIGZ0MFxcblwiO1xuXG5cdFx0cmV0dXJuIGNvZGU7XG5cdH1cblxuXHQvKipcblx0ICogR2V0cyB0aGUgZGVwdGggbWFwcyByZW5kZXJlZCBmb3IgdGhpcyBvYmplY3QgZnJvbSBhbGwgbGlnaHRzLlxuXHQgKiBAcGFyYW0gcmVuZGVyYWJsZSBUaGUgcmVuZGVyYWJsZSBmb3Igd2hpY2ggdG8gcmV0cmlldmUgdGhlIGRlcHRoIG1hcHMuXG5cdCAqIEBwYXJhbSBzdGFnZTNEUHJveHkgVGhlIFN0YWdlM0RQcm94eSBvYmplY3QgY3VycmVudGx5IHVzZWQgZm9yIHJlbmRlcmluZy5cblx0ICogQHJldHVybiBBIGxpc3Qgb2YgZGVwdGggbWFwIHRleHR1cmVzIGZvciBhbGwgc3VwcG9ydGVkIGxpZ2h0cy5cblx0ICovXG5cdHB1YmxpYyBfaUdldERlcHRoTWFwKHJlbmRlcmFibGU6UmVuZGVyYWJsZUJhc2UpOlJlbmRlclRleHR1cmVcblx0e1xuXHRcdHJldHVybiB0aGlzLl90ZXh0dXJlc1tyZW5kZXJhYmxlLnJlbmRlcmFibGVPd25lci5pZF07XG5cdH1cblxuXHQvKipcblx0ICogUmV0cmlldmVzIHRoZSBkZXB0aCBtYXAgcHJvamVjdGlvbiBtYXBzIGZvciBhbGwgbGlnaHRzLlxuXHQgKiBAcGFyYW0gcmVuZGVyYWJsZSBUaGUgcmVuZGVyYWJsZSBmb3Igd2hpY2ggdG8gcmV0cmlldmUgdGhlIHByb2plY3Rpb24gbWFwcy5cblx0ICogQHJldHVybiBBIGxpc3Qgb2YgcHJvamVjdGlvbiBtYXBzIGZvciBhbGwgc3VwcG9ydGVkIGxpZ2h0cy5cblx0ICovXG5cdHB1YmxpYyBfaUdldFByb2plY3Rpb24ocmVuZGVyYWJsZTpSZW5kZXJhYmxlQmFzZSk6TWF0cml4M0Rcblx0e1xuXHRcdHJldHVybiB0aGlzLl9wcm9qZWN0aW9uc1tyZW5kZXJhYmxlLnJlbmRlcmFibGVPd25lci5pZF07XG5cdH1cblxuXHQvKipcblx0ICogQGluaGVyaXREb2Ncblx0ICovXG5cdHB1YmxpYyBfaVJlbmRlcihyZW5kZXJhYmxlOlJlbmRlcmFibGVCYXNlLCBjYW1lcmE6Q2FtZXJhLCB2aWV3UHJvamVjdGlvbjpNYXRyaXgzRClcblx0e1xuXHRcdHZhciBtYXRyaXg6TWF0cml4M0Q7XG5cdFx0dmFyIGNvbnRleHQ6SUNvbnRleHRHTCA9IHRoaXMuX3N0YWdlLmNvbnRleHQ7XG5cdFx0dmFyIGxlbjpudW1iZXIgLyp1aW50Ki87XG5cdFx0dmFyIGxpZ2h0OkxpZ2h0QmFzZTtcblx0XHR2YXIgbGlnaHRzOkFycmF5PExpZ2h0QmFzZT4gPSB0aGlzLl9yZW5kZXJPYmplY3RPd25lci5saWdodFBpY2tlci5hbGxQaWNrZWRMaWdodHM7XG5cdFx0dmFyIHJJZDpudW1iZXIgPSByZW5kZXJhYmxlLnJlbmRlcmFibGVPd25lci5pZDtcblxuXHRcdGlmICghdGhpcy5fdGV4dHVyZXNbcklkXSlcblx0XHRcdHRoaXMuX3RleHR1cmVzW3JJZF0gPSBuZXcgUmVuZGVyVGV4dHVyZSh0aGlzLl90ZXh0dXJlU2l6ZSwgdGhpcy5fdGV4dHVyZVNpemUpO1xuXG5cdFx0aWYgKCF0aGlzLl9wcm9qZWN0aW9uc1tySWRdKVxuXHRcdFx0dGhpcy5fcHJvamVjdGlvbnNbcklkXSA9IG5ldyBNYXRyaXgzRCgpO1xuXG5cdFx0bGVuID0gbGlnaHRzLmxlbmd0aDtcblxuXHRcdC8vIGxvY2FsIHBvc2l0aW9uID0gZW5vdWdoXG5cdFx0bGlnaHQgPSBsaWdodHNbMF07XG5cblx0XHRtYXRyaXggPSBsaWdodC5pR2V0T2JqZWN0UHJvamVjdGlvbk1hdHJpeChyZW5kZXJhYmxlLnNvdXJjZUVudGl0eSwgY2FtZXJhLCB0aGlzLl9wcm9qZWN0aW9uc1tySWRdKTtcblxuXHRcdHRoaXMuX3N0YWdlLnNldFJlbmRlclRhcmdldCh0aGlzLl90ZXh0dXJlc1tySWRdLCB0cnVlKTtcblx0XHRjb250ZXh0LmNsZWFyKDEuMCwgMS4wLCAxLjApO1xuXHRcdGNvbnRleHQuc2V0UHJvZ3JhbUNvbnN0YW50c0Zyb21NYXRyaXgoQ29udGV4dEdMUHJvZ3JhbVR5cGUuVkVSVEVYLCAwLCBtYXRyaXgsIHRydWUpO1xuXHRcdGNvbnRleHQuc2V0UHJvZ3JhbUNvbnN0YW50c0Zyb21BcnJheShDb250ZXh0R0xQcm9ncmFtVHlwZS5GUkFHTUVOVCwgMCwgdGhpcy5fZW5jLCAyKTtcblxuXHRcdHRoaXMuX3N0YWdlLmFjdGl2YXRlQnVmZmVyKDAsIHJlbmRlcmFibGUuZ2V0VmVydGV4RGF0YShUcmlhbmdsZVN1Ykdlb21ldHJ5LlBPU0lUSU9OX0RBVEEpLCByZW5kZXJhYmxlLmdldFZlcnRleE9mZnNldChUcmlhbmdsZVN1Ykdlb21ldHJ5LlBPU0lUSU9OX0RBVEEpLCBUcmlhbmdsZVN1Ykdlb21ldHJ5LlBPU0lUSU9OX0ZPUk1BVCk7XG5cdFx0dGhpcy5fc3RhZ2UuYWN0aXZhdGVCdWZmZXIoMSwgcmVuZGVyYWJsZS5nZXRWZXJ0ZXhEYXRhKFRyaWFuZ2xlU3ViR2VvbWV0cnkuTk9STUFMX0RBVEEpLCByZW5kZXJhYmxlLmdldFZlcnRleE9mZnNldChUcmlhbmdsZVN1Ykdlb21ldHJ5Lk5PUk1BTF9EQVRBKSwgVHJpYW5nbGVTdWJHZW9tZXRyeS5OT1JNQUxfRk9STUFUKTtcblx0XHRjb250ZXh0LmRyYXdUcmlhbmdsZXModGhpcy5fc3RhZ2UuZ2V0SW5kZXhCdWZmZXIocmVuZGVyYWJsZS5nZXRJbmRleERhdGEoKSksIDAsIHJlbmRlcmFibGUubnVtVHJpYW5nbGVzKTtcblx0fVxuXG5cdC8qKlxuXHQgKiBAaW5oZXJpdERvY1xuXHQgKi9cblx0cHVibGljIF9pQWN0aXZhdGUoY2FtZXJhOkNhbWVyYSlcblx0e1xuXHRcdGlmICh0aGlzLl9wcm9qZWN0aW9uVGV4dHVyZXNJbnZhbGlkKVxuXHRcdFx0dGhpcy51cGRhdGVQcm9qZWN0aW9uVGV4dHVyZXMoKTtcblxuXHRcdC8vIG5ldmVyIHNjYWxlXG5cdFx0c3VwZXIuX2lBY3RpdmF0ZShjYW1lcmEpO1xuXG5cdFx0dGhpcy5fc3RhZ2UuY29udGV4dC5zZXRQcm9ncmFtQ29uc3RhbnRzRnJvbUFycmF5KENvbnRleHRHTFByb2dyYW1UeXBlLlZFUlRFWCwgNCwgdGhpcy5fcG9seU9mZnNldCwgMSk7XG5cdH1cbn1cblxuZXhwb3J0ID0gU2luZ2xlT2JqZWN0RGVwdGhQYXNzOyJdfQ==