var __extends = this.__extends || function (d, b) {
    for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p];
    function __() { this.constructor = d; }
    __.prototype = b.prototype;
    d.prototype = new __();
};
var ShadingMethodEvent = require("awayjs-renderergl/lib/events/ShadingMethodEvent");
var ShadowMethodBase = require("awayjs-methodmaterials/lib/methods/ShadowMethodBase");
// TODO: shadow mappers references in materials should be an interface so that this class should NOT extend ShadowMapMethodBase just for some delegation work
/**
 * ShadowNearMethod provides a shadow map method that restricts the shadowed area near the camera to optimize
 * shadow map usage. This method needs to be used in conjunction with a NearDirectionalShadowMapper.
 *
 * @see away.lights.NearDirectionalShadowMapper
 */
var ShadowNearMethod = (function (_super) {
    __extends(ShadowNearMethod, _super);
    /**
     * Creates a new ShadowNearMethod object.
     * @param baseMethod The shadow map sampling method used to sample individual cascades (fe: ShadowHardMethod, ShadowSoftMethod)
     * @param fadeRatio The amount of shadow fading to the outer shadow area. A value of 1 would mean the shadows start fading from the camera's near plane.
     */
    function ShadowNearMethod(baseMethod, fadeRatio) {
        var _this = this;
        if (fadeRatio === void 0) { fadeRatio = .1; }
        _super.call(this, baseMethod.castingLight);
        this._onShaderInvalidatedDelegate = function (event) { return _this.onShaderInvalidated(event); };
        this._baseMethod = baseMethod;
        this._fadeRatio = fadeRatio;
        this._nearShadowMapper = this._pCastingLight.shadowMapper;
        if (!this._nearShadowMapper)
            throw new Error("ShadowNearMethod requires a light that has a NearDirectionalShadowMapper instance assigned to shadowMapper.");
        this._baseMethod.addEventListener(ShadingMethodEvent.SHADER_INVALIDATED, this._onShaderInvalidatedDelegate);
    }
    Object.defineProperty(ShadowNearMethod.prototype, "baseMethod", {
        /**
         * The base shadow map method on which this method's shading is based.
         */
        get: function () {
            return this._baseMethod;
        },
        set: function (value) {
            if (this._baseMethod == value)
                return;
            this._baseMethod.removeEventListener(ShadingMethodEvent.SHADER_INVALIDATED, this._onShaderInvalidatedDelegate);
            this._baseMethod = value;
            this._baseMethod.addEventListener(ShadingMethodEvent.SHADER_INVALIDATED, this._onShaderInvalidatedDelegate);
            this.iInvalidateShaderProgram();
        },
        enumerable: true,
        configurable: true
    });
    /**
     * @inheritDoc
     */
    ShadowNearMethod.prototype.iInitConstants = function (shaderObject, methodVO) {
        _super.prototype.iInitConstants.call(this, shaderObject, methodVO);
        this._baseMethod.iInitConstants(shaderObject, methodVO);
        var fragmentData = shaderObject.fragmentConstantData;
        var index = methodVO.secondaryFragmentConstantsIndex;
        fragmentData[index + 2] = 0;
        fragmentData[index + 3] = 1;
    };
    /**
     * @inheritDoc
     */
    ShadowNearMethod.prototype.iInitVO = function (shaderObject, methodVO) {
        this._baseMethod.iInitVO(shaderObject, methodVO);
        methodVO.needsProjection = true;
    };
    /**
     * @inheritDoc
     */
    ShadowNearMethod.prototype.dispose = function () {
        this._baseMethod.removeEventListener(ShadingMethodEvent.SHADER_INVALIDATED, this._onShaderInvalidatedDelegate);
    };
    Object.defineProperty(ShadowNearMethod.prototype, "alpha", {
        /**
         * @inheritDoc
         */
        get: function () {
            return this._baseMethod.alpha;
        },
        set: function (value) {
            this._baseMethod.alpha = value;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(ShadowNearMethod.prototype, "epsilon", {
        /**
         * @inheritDoc
         */
        get: function () {
            return this._baseMethod.epsilon;
        },
        set: function (value) {
            this._baseMethod.epsilon = value;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(ShadowNearMethod.prototype, "fadeRatio", {
        /**
         * The amount of shadow fading to the outer shadow area. A value of 1 would mean the shadows start fading from the camera's near plane.
         */
        get: function () {
            return this._fadeRatio;
        },
        set: function (value) {
            this._fadeRatio = value;
        },
        enumerable: true,
        configurable: true
    });
    /**
     * @inheritDoc
     */
    ShadowNearMethod.prototype.iGetFragmentCode = function (shaderObject, methodVO, targetReg, registerCache, sharedRegisters) {
        var code = this._baseMethod.iGetFragmentCode(shaderObject, methodVO, targetReg, registerCache, sharedRegisters);
        var dataReg = registerCache.getFreeFragmentConstant();
        var temp = registerCache.getFreeFragmentSingleTemp();
        methodVO.secondaryFragmentConstantsIndex = dataReg.index * 4;
        code += "abs " + temp + ", " + sharedRegisters.projectionFragment + ".w\n" + "sub " + temp + ", " + temp + ", " + dataReg + ".x\n" + "mul " + temp + ", " + temp + ", " + dataReg + ".y\n" + "sat " + temp + ", " + temp + "\n" + "sub " + temp + ", " + dataReg + ".w," + temp + "\n" + "sub " + targetReg + ".w, " + dataReg + ".w," + targetReg + ".w\n" + "mul " + targetReg + ".w, " + targetReg + ".w, " + temp + "\n" + "sub " + targetReg + ".w, " + dataReg + ".w," + targetReg + ".w\n";
        return code;
    };
    /**
     * @inheritDoc
     */
    ShadowNearMethod.prototype.iActivate = function (shaderObject, methodVO, stage) {
        this._baseMethod.iActivate(shaderObject, methodVO, stage);
    };
    /**
     * @inheritDoc
     */
    ShadowNearMethod.prototype.iDeactivate = function (shaderObject, methodVO, stage) {
        this._baseMethod.iDeactivate(shaderObject, methodVO, stage);
    };
    /**
     * @inheritDoc
     */
    ShadowNearMethod.prototype.iSetRenderState = function (shaderObject, methodVO, renderable, stage, camera) {
        // todo: move this to activate (needs camera)
        var near = camera.projection.near;
        var d = camera.projection.far - near;
        var maxDistance = this._nearShadowMapper.coverageRatio;
        var minDistance = maxDistance * (1 - this._fadeRatio);
        maxDistance = near + maxDistance * d;
        minDistance = near + minDistance * d;
        var fragmentData = shaderObject.fragmentConstantData;
        var index = methodVO.secondaryFragmentConstantsIndex;
        fragmentData[index] = minDistance;
        fragmentData[index + 1] = 1 / (maxDistance - minDistance);
        this._baseMethod.iSetRenderState(shaderObject, methodVO, renderable, stage, camera);
    };
    /**
     * @inheritDoc
     */
    ShadowNearMethod.prototype.iGetVertexCode = function (shaderObject, methodVO, registerCache, sharedRegisters) {
        return this._baseMethod.iGetVertexCode(shaderObject, methodVO, registerCache, sharedRegisters);
    };
    /**
     * @inheritDoc
     */
    ShadowNearMethod.prototype.iReset = function () {
        this._baseMethod.iReset();
    };
    /**
     * @inheritDoc
     */
    ShadowNearMethod.prototype.iCleanCompilationData = function () {
        _super.prototype.iCleanCompilationData.call(this);
        this._baseMethod.iCleanCompilationData();
    };
    /**
     * Called when the base method's shader code is invalidated.
     */
    ShadowNearMethod.prototype.onShaderInvalidated = function (event) {
        this.iInvalidateShaderProgram();
    };
    return ShadowNearMethod;
})(ShadowMethodBase);
module.exports = ShadowNearMethod;

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImF3YXlqcy1tZXRob2RtYXRlcmlhbHMvbGliL21ldGhvZHMvU2hhZG93TmVhck1ldGhvZC50cyJdLCJuYW1lcyI6WyJTaGFkb3dOZWFyTWV0aG9kIiwiU2hhZG93TmVhck1ldGhvZC5jb25zdHJ1Y3RvciIsIlNoYWRvd05lYXJNZXRob2QuYmFzZU1ldGhvZCIsIlNoYWRvd05lYXJNZXRob2QuaUluaXRDb25zdGFudHMiLCJTaGFkb3dOZWFyTWV0aG9kLmlJbml0Vk8iLCJTaGFkb3dOZWFyTWV0aG9kLmRpc3Bvc2UiLCJTaGFkb3dOZWFyTWV0aG9kLmFscGhhIiwiU2hhZG93TmVhck1ldGhvZC5lcHNpbG9uIiwiU2hhZG93TmVhck1ldGhvZC5mYWRlUmF0aW8iLCJTaGFkb3dOZWFyTWV0aG9kLmlHZXRGcmFnbWVudENvZGUiLCJTaGFkb3dOZWFyTWV0aG9kLmlBY3RpdmF0ZSIsIlNoYWRvd05lYXJNZXRob2QuaURlYWN0aXZhdGUiLCJTaGFkb3dOZWFyTWV0aG9kLmlTZXRSZW5kZXJTdGF0ZSIsIlNoYWRvd05lYXJNZXRob2QuaUdldFZlcnRleENvZGUiLCJTaGFkb3dOZWFyTWV0aG9kLmlSZXNldCIsIlNoYWRvd05lYXJNZXRob2QuaUNsZWFuQ29tcGlsYXRpb25EYXRhIiwiU2hhZG93TmVhck1ldGhvZC5vblNoYWRlckludmFsaWRhdGVkIl0sIm1hcHBpbmdzIjoiOzs7Ozs7QUFNQSxJQUFPLGtCQUFrQixXQUFjLGlEQUFpRCxDQUFDLENBQUM7QUFRMUYsSUFBTyxnQkFBZ0IsV0FBZSxxREFBcUQsQ0FBQyxDQUFDO0FBRTdGLEFBT0EsNkpBUDZKO0FBQzdKOzs7OztHQUtHO0lBQ0csZ0JBQWdCO0lBQVNBLFVBQXpCQSxnQkFBZ0JBLFVBQXlCQTtJQVM5Q0E7Ozs7T0FJR0E7SUFDSEEsU0FkS0EsZ0JBQWdCQSxDQWNUQSxVQUEyQkEsRUFBRUEsU0FBcUJBO1FBZC9EQyxpQkFzTkNBO1FBeE15Q0EseUJBQXFCQSxHQUFyQkEsY0FBcUJBO1FBRTdEQSxrQkFBTUEsVUFBVUEsQ0FBQ0EsWUFBWUEsQ0FBQ0EsQ0FBQ0E7UUFFL0JBLElBQUlBLENBQUNBLDRCQUE0QkEsR0FBR0EsVUFBQ0EsS0FBd0JBLElBQUtBLE9BQUFBLEtBQUlBLENBQUNBLG1CQUFtQkEsQ0FBQ0EsS0FBS0EsQ0FBQ0EsRUFBL0JBLENBQStCQSxDQUFDQTtRQUVsR0EsSUFBSUEsQ0FBQ0EsV0FBV0EsR0FBR0EsVUFBVUEsQ0FBQ0E7UUFDOUJBLElBQUlBLENBQUNBLFVBQVVBLEdBQUdBLFNBQVNBLENBQUNBO1FBQzVCQSxJQUFJQSxDQUFDQSxpQkFBaUJBLEdBQWlDQSxJQUFJQSxDQUFDQSxjQUFjQSxDQUFDQSxZQUFZQSxDQUFDQTtRQUN4RkEsRUFBRUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsSUFBSUEsQ0FBQ0EsaUJBQWlCQSxDQUFDQTtZQUMzQkEsTUFBTUEsSUFBSUEsS0FBS0EsQ0FBQ0EsNkdBQTZHQSxDQUFDQSxDQUFDQTtRQUNoSUEsSUFBSUEsQ0FBQ0EsV0FBV0EsQ0FBQ0EsZ0JBQWdCQSxDQUFDQSxrQkFBa0JBLENBQUNBLGtCQUFrQkEsRUFBRUEsSUFBSUEsQ0FBQ0EsNEJBQTRCQSxDQUFDQSxDQUFDQTtJQUM3R0EsQ0FBQ0E7SUFLREQsc0JBQVdBLHdDQUFVQTtRQUhyQkE7O1dBRUdBO2FBQ0hBO1lBRUNFLE1BQU1BLENBQUNBLElBQUlBLENBQUNBLFdBQVdBLENBQUNBO1FBQ3pCQSxDQUFDQTthQUVERixVQUFzQkEsS0FBc0JBO1lBRTNDRSxFQUFFQSxDQUFDQSxDQUFDQSxJQUFJQSxDQUFDQSxXQUFXQSxJQUFJQSxLQUFLQSxDQUFDQTtnQkFDN0JBLE1BQU1BLENBQUNBO1lBRVJBLElBQUlBLENBQUNBLFdBQVdBLENBQUNBLG1CQUFtQkEsQ0FBQ0Esa0JBQWtCQSxDQUFDQSxrQkFBa0JBLEVBQUVBLElBQUlBLENBQUNBLDRCQUE0QkEsQ0FBQ0EsQ0FBQ0E7WUFFL0dBLElBQUlBLENBQUNBLFdBQVdBLEdBQUdBLEtBQUtBLENBQUNBO1lBRXpCQSxJQUFJQSxDQUFDQSxXQUFXQSxDQUFDQSxnQkFBZ0JBLENBQUNBLGtCQUFrQkEsQ0FBQ0Esa0JBQWtCQSxFQUFFQSxJQUFJQSxDQUFDQSw0QkFBNEJBLENBQUNBLENBQUNBO1lBRTVHQSxJQUFJQSxDQUFDQSx3QkFBd0JBLEVBQUVBLENBQUNBO1FBQ2pDQSxDQUFDQTs7O09BZEFGO0lBZ0JEQTs7T0FFR0E7SUFDSUEseUNBQWNBLEdBQXJCQSxVQUFzQkEsWUFBNkJBLEVBQUVBLFFBQWlCQTtRQUVyRUcsZ0JBQUtBLENBQUNBLGNBQWNBLFlBQUNBLFlBQVlBLEVBQUVBLFFBQVFBLENBQUNBLENBQUNBO1FBQzdDQSxJQUFJQSxDQUFDQSxXQUFXQSxDQUFDQSxjQUFjQSxDQUFDQSxZQUFZQSxFQUFFQSxRQUFRQSxDQUFDQSxDQUFDQTtRQUV4REEsSUFBSUEsWUFBWUEsR0FBaUJBLFlBQVlBLENBQUNBLG9CQUFvQkEsQ0FBQ0E7UUFDbkVBLElBQUlBLEtBQUtBLEdBQWtCQSxRQUFRQSxDQUFDQSwrQkFBK0JBLENBQUNBO1FBQ3BFQSxZQUFZQSxDQUFDQSxLQUFLQSxHQUFHQSxDQUFDQSxDQUFDQSxHQUFHQSxDQUFDQSxDQUFDQTtRQUM1QkEsWUFBWUEsQ0FBQ0EsS0FBS0EsR0FBR0EsQ0FBQ0EsQ0FBQ0EsR0FBR0EsQ0FBQ0EsQ0FBQ0E7SUFDN0JBLENBQUNBO0lBRURIOztPQUVHQTtJQUNJQSxrQ0FBT0EsR0FBZEEsVUFBZUEsWUFBaUNBLEVBQUVBLFFBQWlCQTtRQUVsRUksSUFBSUEsQ0FBQ0EsV0FBV0EsQ0FBQ0EsT0FBT0EsQ0FBQ0EsWUFBWUEsRUFBRUEsUUFBUUEsQ0FBQ0EsQ0FBQ0E7UUFFakRBLFFBQVFBLENBQUNBLGVBQWVBLEdBQUdBLElBQUlBLENBQUNBO0lBQ2pDQSxDQUFDQTtJQUVESjs7T0FFR0E7SUFDSUEsa0NBQU9BLEdBQWRBO1FBRUNLLElBQUlBLENBQUNBLFdBQVdBLENBQUNBLG1CQUFtQkEsQ0FBQ0Esa0JBQWtCQSxDQUFDQSxrQkFBa0JBLEVBQUVBLElBQUlBLENBQUNBLDRCQUE0QkEsQ0FBQ0EsQ0FBQ0E7SUFDaEhBLENBQUNBO0lBS0RMLHNCQUFXQSxtQ0FBS0E7UUFIaEJBOztXQUVHQTthQUNIQTtZQUVDTSxNQUFNQSxDQUFDQSxJQUFJQSxDQUFDQSxXQUFXQSxDQUFDQSxLQUFLQSxDQUFDQTtRQUMvQkEsQ0FBQ0E7YUFFRE4sVUFBaUJBLEtBQVlBO1lBRTVCTSxJQUFJQSxDQUFDQSxXQUFXQSxDQUFDQSxLQUFLQSxHQUFHQSxLQUFLQSxDQUFDQTtRQUNoQ0EsQ0FBQ0E7OztPQUxBTjtJQVVEQSxzQkFBV0EscUNBQU9BO1FBSGxCQTs7V0FFR0E7YUFDSEE7WUFFQ08sTUFBTUEsQ0FBQ0EsSUFBSUEsQ0FBQ0EsV0FBV0EsQ0FBQ0EsT0FBT0EsQ0FBQ0E7UUFDakNBLENBQUNBO2FBRURQLFVBQW1CQSxLQUFZQTtZQUU5Qk8sSUFBSUEsQ0FBQ0EsV0FBV0EsQ0FBQ0EsT0FBT0EsR0FBR0EsS0FBS0EsQ0FBQ0E7UUFDbENBLENBQUNBOzs7T0FMQVA7SUFVREEsc0JBQVdBLHVDQUFTQTtRQUhwQkE7O1dBRUdBO2FBQ0hBO1lBRUNRLE1BQU1BLENBQUNBLElBQUlBLENBQUNBLFVBQVVBLENBQUNBO1FBQ3hCQSxDQUFDQTthQUVEUixVQUFxQkEsS0FBWUE7WUFFaENRLElBQUlBLENBQUNBLFVBQVVBLEdBQUdBLEtBQUtBLENBQUNBO1FBQ3pCQSxDQUFDQTs7O09BTEFSO0lBT0RBOztPQUVHQTtJQUNJQSwyQ0FBZ0JBLEdBQXZCQSxVQUF3QkEsWUFBNkJBLEVBQUVBLFFBQWlCQSxFQUFFQSxTQUErQkEsRUFBRUEsYUFBaUNBLEVBQUVBLGVBQWtDQTtRQUUvS1MsSUFBSUEsSUFBSUEsR0FBVUEsSUFBSUEsQ0FBQ0EsV0FBV0EsQ0FBQ0EsZ0JBQWdCQSxDQUFDQSxZQUFZQSxFQUFFQSxRQUFRQSxFQUFFQSxTQUFTQSxFQUFFQSxhQUFhQSxFQUFFQSxlQUFlQSxDQUFDQSxDQUFDQTtRQUV2SEEsSUFBSUEsT0FBT0EsR0FBeUJBLGFBQWFBLENBQUNBLHVCQUF1QkEsRUFBRUEsQ0FBQ0E7UUFDNUVBLElBQUlBLElBQUlBLEdBQXlCQSxhQUFhQSxDQUFDQSx5QkFBeUJBLEVBQUVBLENBQUNBO1FBQzNFQSxRQUFRQSxDQUFDQSwrQkFBK0JBLEdBQUdBLE9BQU9BLENBQUNBLEtBQUtBLEdBQUNBLENBQUNBLENBQUNBO1FBRTNEQSxJQUFJQSxJQUFJQSxNQUFNQSxHQUFHQSxJQUFJQSxHQUFHQSxJQUFJQSxHQUFHQSxlQUFlQSxDQUFDQSxrQkFBa0JBLEdBQUdBLE1BQU1BLEdBQ3pFQSxNQUFNQSxHQUFHQSxJQUFJQSxHQUFHQSxJQUFJQSxHQUFHQSxJQUFJQSxHQUFHQSxJQUFJQSxHQUFHQSxPQUFPQSxHQUFHQSxNQUFNQSxHQUNyREEsTUFBTUEsR0FBR0EsSUFBSUEsR0FBR0EsSUFBSUEsR0FBR0EsSUFBSUEsR0FBR0EsSUFBSUEsR0FBR0EsT0FBT0EsR0FBR0EsTUFBTUEsR0FDckRBLE1BQU1BLEdBQUdBLElBQUlBLEdBQUdBLElBQUlBLEdBQUdBLElBQUlBLEdBQUdBLElBQUlBLEdBQ2xDQSxNQUFNQSxHQUFHQSxJQUFJQSxHQUFHQSxJQUFJQSxHQUFHQSxPQUFPQSxHQUFHQSxLQUFLQSxHQUFHQSxJQUFJQSxHQUFHQSxJQUFJQSxHQUNwREEsTUFBTUEsR0FBR0EsU0FBU0EsR0FBR0EsTUFBTUEsR0FBR0EsT0FBT0EsR0FBR0EsS0FBS0EsR0FBR0EsU0FBU0EsR0FBR0EsTUFBTUEsR0FDbEVBLE1BQU1BLEdBQUdBLFNBQVNBLEdBQUdBLE1BQU1BLEdBQUdBLFNBQVNBLEdBQUdBLE1BQU1BLEdBQUdBLElBQUlBLEdBQUdBLElBQUlBLEdBQzlEQSxNQUFNQSxHQUFHQSxTQUFTQSxHQUFHQSxNQUFNQSxHQUFHQSxPQUFPQSxHQUFHQSxLQUFLQSxHQUFHQSxTQUFTQSxHQUFHQSxNQUFNQSxDQUFDQTtRQUVwRUEsTUFBTUEsQ0FBQ0EsSUFBSUEsQ0FBQ0E7SUFDYkEsQ0FBQ0E7SUFFRFQ7O09BRUdBO0lBQ0lBLG9DQUFTQSxHQUFoQkEsVUFBaUJBLFlBQTZCQSxFQUFFQSxRQUFpQkEsRUFBRUEsS0FBV0E7UUFFN0VVLElBQUlBLENBQUNBLFdBQVdBLENBQUNBLFNBQVNBLENBQUNBLFlBQVlBLEVBQUVBLFFBQVFBLEVBQUVBLEtBQUtBLENBQUNBLENBQUNBO0lBQzNEQSxDQUFDQTtJQUVEVjs7T0FFR0E7SUFDSUEsc0NBQVdBLEdBQWxCQSxVQUFtQkEsWUFBNkJBLEVBQUVBLFFBQWlCQSxFQUFFQSxLQUFXQTtRQUUvRVcsSUFBSUEsQ0FBQ0EsV0FBV0EsQ0FBQ0EsV0FBV0EsQ0FBQ0EsWUFBWUEsRUFBRUEsUUFBUUEsRUFBRUEsS0FBS0EsQ0FBQ0EsQ0FBQ0E7SUFDN0RBLENBQUNBO0lBRURYOztPQUVHQTtJQUNJQSwwQ0FBZUEsR0FBdEJBLFVBQXVCQSxZQUE2QkEsRUFBRUEsUUFBaUJBLEVBQUVBLFVBQXlCQSxFQUFFQSxLQUFXQSxFQUFFQSxNQUFhQTtRQUU3SFksQUFDQUEsNkNBRDZDQTtZQUN6Q0EsSUFBSUEsR0FBVUEsTUFBTUEsQ0FBQ0EsVUFBVUEsQ0FBQ0EsSUFBSUEsQ0FBQ0E7UUFDekNBLElBQUlBLENBQUNBLEdBQVVBLE1BQU1BLENBQUNBLFVBQVVBLENBQUNBLEdBQUdBLEdBQUdBLElBQUlBLENBQUNBO1FBQzVDQSxJQUFJQSxXQUFXQSxHQUFVQSxJQUFJQSxDQUFDQSxpQkFBaUJBLENBQUNBLGFBQWFBLENBQUNBO1FBQzlEQSxJQUFJQSxXQUFXQSxHQUFVQSxXQUFXQSxHQUFDQSxDQUFDQSxDQUFDQSxHQUFHQSxJQUFJQSxDQUFDQSxVQUFVQSxDQUFDQSxDQUFDQTtRQUUzREEsV0FBV0EsR0FBR0EsSUFBSUEsR0FBR0EsV0FBV0EsR0FBQ0EsQ0FBQ0EsQ0FBQ0E7UUFDbkNBLFdBQVdBLEdBQUdBLElBQUlBLEdBQUdBLFdBQVdBLEdBQUNBLENBQUNBLENBQUNBO1FBRW5DQSxJQUFJQSxZQUFZQSxHQUFpQkEsWUFBWUEsQ0FBQ0Esb0JBQW9CQSxDQUFDQTtRQUNuRUEsSUFBSUEsS0FBS0EsR0FBa0JBLFFBQVFBLENBQUNBLCtCQUErQkEsQ0FBQ0E7UUFDcEVBLFlBQVlBLENBQUNBLEtBQUtBLENBQUNBLEdBQUdBLFdBQVdBLENBQUNBO1FBQ2xDQSxZQUFZQSxDQUFDQSxLQUFLQSxHQUFHQSxDQUFDQSxDQUFDQSxHQUFHQSxDQUFDQSxHQUFDQSxDQUFDQSxXQUFXQSxHQUFHQSxXQUFXQSxDQUFDQSxDQUFDQTtRQUV4REEsSUFBSUEsQ0FBQ0EsV0FBV0EsQ0FBQ0EsZUFBZUEsQ0FBQ0EsWUFBWUEsRUFBRUEsUUFBUUEsRUFBRUEsVUFBVUEsRUFBRUEsS0FBS0EsRUFBRUEsTUFBTUEsQ0FBQ0EsQ0FBQ0E7SUFDckZBLENBQUNBO0lBRURaOztPQUVHQTtJQUNJQSx5Q0FBY0EsR0FBckJBLFVBQXNCQSxZQUE2QkEsRUFBRUEsUUFBaUJBLEVBQUVBLGFBQWlDQSxFQUFFQSxlQUFrQ0E7UUFFNUlhLE1BQU1BLENBQUNBLElBQUlBLENBQUNBLFdBQVdBLENBQUNBLGNBQWNBLENBQUNBLFlBQVlBLEVBQUVBLFFBQVFBLEVBQUVBLGFBQWFBLEVBQUVBLGVBQWVBLENBQUNBLENBQUNBO0lBQ2hHQSxDQUFDQTtJQUVEYjs7T0FFR0E7SUFDSUEsaUNBQU1BLEdBQWJBO1FBRUNjLElBQUlBLENBQUNBLFdBQVdBLENBQUNBLE1BQU1BLEVBQUVBLENBQUNBO0lBQzNCQSxDQUFDQTtJQUVEZDs7T0FFR0E7SUFDSUEsZ0RBQXFCQSxHQUE1QkE7UUFFQ2UsZ0JBQUtBLENBQUNBLHFCQUFxQkEsV0FBRUEsQ0FBQ0E7UUFDOUJBLElBQUlBLENBQUNBLFdBQVdBLENBQUNBLHFCQUFxQkEsRUFBRUEsQ0FBQ0E7SUFDMUNBLENBQUNBO0lBRURmOztPQUVHQTtJQUNLQSw4Q0FBbUJBLEdBQTNCQSxVQUE0QkEsS0FBd0JBO1FBRW5EZ0IsSUFBSUEsQ0FBQ0Esd0JBQXdCQSxFQUFFQSxDQUFDQTtJQUNqQ0EsQ0FBQ0E7SUFDRmhCLHVCQUFDQTtBQUFEQSxDQXROQSxBQXNOQ0EsRUF0TjhCLGdCQUFnQixFQXNOOUM7QUFFRCxBQUEwQixpQkFBakIsZ0JBQWdCLENBQUMiLCJmaWxlIjoibWV0aG9kcy9TaGFkb3dOZWFyTWV0aG9kLmpzIiwic291cmNlUm9vdCI6Ii4uLyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBOZWFyRGlyZWN0aW9uYWxTaGFkb3dNYXBwZXJcdFx0PSByZXF1aXJlKFwiYXdheWpzLWRpc3BsYXkvbGliL21hdGVyaWFscy9zaGFkb3dtYXBwZXJzL05lYXJEaXJlY3Rpb25hbFNoYWRvd01hcHBlclwiKTtcclxuaW1wb3J0IENhbWVyYVx0XHRcdFx0XHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLWRpc3BsYXkvbGliL2VudGl0aWVzL0NhbWVyYVwiKTtcclxuXHJcbmltcG9ydCBTdGFnZVx0XHRcdFx0XHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLXN0YWdlZ2wvbGliL2Jhc2UvU3RhZ2VcIik7XHJcblxyXG5pbXBvcnQgUmVuZGVyYWJsZUJhc2VcdFx0XHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLXJlbmRlcmVyZ2wvbGliL3Bvb2wvUmVuZGVyYWJsZUJhc2VcIik7XHJcbmltcG9ydCBTaGFkaW5nTWV0aG9kRXZlbnRcdFx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1yZW5kZXJlcmdsL2xpYi9ldmVudHMvU2hhZGluZ01ldGhvZEV2ZW50XCIpO1xyXG5pbXBvcnQgU2hhZGVyTGlnaHRpbmdPYmplY3RcdFx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1yZW5kZXJlcmdsL2xpYi9jb21waWxhdGlvbi9TaGFkZXJMaWdodGluZ09iamVjdFwiKTtcclxuaW1wb3J0IFNoYWRlck9iamVjdEJhc2VcdFx0XHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLXJlbmRlcmVyZ2wvbGliL2NvbXBpbGF0aW9uL1NoYWRlck9iamVjdEJhc2VcIik7XHJcbmltcG9ydCBTaGFkZXJSZWdpc3RlckNhY2hlXHRcdFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtcmVuZGVyZXJnbC9saWIvY29tcGlsYXRpb24vU2hhZGVyUmVnaXN0ZXJDYWNoZVwiKTtcclxuaW1wb3J0IFNoYWRlclJlZ2lzdGVyRGF0YVx0XHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLXJlbmRlcmVyZ2wvbGliL2NvbXBpbGF0aW9uL1NoYWRlclJlZ2lzdGVyRGF0YVwiKTtcclxuaW1wb3J0IFNoYWRlclJlZ2lzdGVyRWxlbWVudFx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1yZW5kZXJlcmdsL2xpYi9jb21waWxhdGlvbi9TaGFkZXJSZWdpc3RlckVsZW1lbnRcIik7XHJcblxyXG5pbXBvcnQgTWV0aG9kVk9cdFx0XHRcdFx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1tZXRob2RtYXRlcmlhbHMvbGliL2RhdGEvTWV0aG9kVk9cIik7XHJcbmltcG9ydCBTaGFkb3dNZXRob2RCYXNlXHRcdFx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1tZXRob2RtYXRlcmlhbHMvbGliL21ldGhvZHMvU2hhZG93TWV0aG9kQmFzZVwiKTtcclxuXHJcbi8vIFRPRE86IHNoYWRvdyBtYXBwZXJzIHJlZmVyZW5jZXMgaW4gbWF0ZXJpYWxzIHNob3VsZCBiZSBhbiBpbnRlcmZhY2Ugc28gdGhhdCB0aGlzIGNsYXNzIHNob3VsZCBOT1QgZXh0ZW5kIFNoYWRvd01hcE1ldGhvZEJhc2UganVzdCBmb3Igc29tZSBkZWxlZ2F0aW9uIHdvcmtcclxuLyoqXHJcbiAqIFNoYWRvd05lYXJNZXRob2QgcHJvdmlkZXMgYSBzaGFkb3cgbWFwIG1ldGhvZCB0aGF0IHJlc3RyaWN0cyB0aGUgc2hhZG93ZWQgYXJlYSBuZWFyIHRoZSBjYW1lcmEgdG8gb3B0aW1pemVcclxuICogc2hhZG93IG1hcCB1c2FnZS4gVGhpcyBtZXRob2QgbmVlZHMgdG8gYmUgdXNlZCBpbiBjb25qdW5jdGlvbiB3aXRoIGEgTmVhckRpcmVjdGlvbmFsU2hhZG93TWFwcGVyLlxyXG4gKlxyXG4gKiBAc2VlIGF3YXkubGlnaHRzLk5lYXJEaXJlY3Rpb25hbFNoYWRvd01hcHBlclxyXG4gKi9cclxuY2xhc3MgU2hhZG93TmVhck1ldGhvZCBleHRlbmRzIFNoYWRvd01ldGhvZEJhc2Vcclxue1xyXG5cdHByaXZhdGUgX2Jhc2VNZXRob2Q6U2hhZG93TWV0aG9kQmFzZTtcclxuXHJcblx0cHJpdmF0ZSBfZmFkZVJhdGlvOm51bWJlcjtcclxuXHRwcml2YXRlIF9uZWFyU2hhZG93TWFwcGVyOk5lYXJEaXJlY3Rpb25hbFNoYWRvd01hcHBlcjtcclxuXHJcblx0cHJpdmF0ZSBfb25TaGFkZXJJbnZhbGlkYXRlZERlbGVnYXRlOkZ1bmN0aW9uO1xyXG5cclxuXHQvKipcclxuXHQgKiBDcmVhdGVzIGEgbmV3IFNoYWRvd05lYXJNZXRob2Qgb2JqZWN0LlxyXG5cdCAqIEBwYXJhbSBiYXNlTWV0aG9kIFRoZSBzaGFkb3cgbWFwIHNhbXBsaW5nIG1ldGhvZCB1c2VkIHRvIHNhbXBsZSBpbmRpdmlkdWFsIGNhc2NhZGVzIChmZTogU2hhZG93SGFyZE1ldGhvZCwgU2hhZG93U29mdE1ldGhvZClcclxuXHQgKiBAcGFyYW0gZmFkZVJhdGlvIFRoZSBhbW91bnQgb2Ygc2hhZG93IGZhZGluZyB0byB0aGUgb3V0ZXIgc2hhZG93IGFyZWEuIEEgdmFsdWUgb2YgMSB3b3VsZCBtZWFuIHRoZSBzaGFkb3dzIHN0YXJ0IGZhZGluZyBmcm9tIHRoZSBjYW1lcmEncyBuZWFyIHBsYW5lLlxyXG5cdCAqL1xyXG5cdGNvbnN0cnVjdG9yKGJhc2VNZXRob2Q6U2hhZG93TWV0aG9kQmFzZSwgZmFkZVJhdGlvOm51bWJlciA9IC4xKVxyXG5cdHtcclxuXHRcdHN1cGVyKGJhc2VNZXRob2QuY2FzdGluZ0xpZ2h0KTtcclxuXHJcblx0XHR0aGlzLl9vblNoYWRlckludmFsaWRhdGVkRGVsZWdhdGUgPSAoZXZlbnQ6U2hhZGluZ01ldGhvZEV2ZW50KSA9PiB0aGlzLm9uU2hhZGVySW52YWxpZGF0ZWQoZXZlbnQpO1xyXG5cclxuXHRcdHRoaXMuX2Jhc2VNZXRob2QgPSBiYXNlTWV0aG9kO1xyXG5cdFx0dGhpcy5fZmFkZVJhdGlvID0gZmFkZVJhdGlvO1xyXG5cdFx0dGhpcy5fbmVhclNoYWRvd01hcHBlciA9IDxOZWFyRGlyZWN0aW9uYWxTaGFkb3dNYXBwZXI+IHRoaXMuX3BDYXN0aW5nTGlnaHQuc2hhZG93TWFwcGVyO1xyXG5cdFx0aWYgKCF0aGlzLl9uZWFyU2hhZG93TWFwcGVyKVxyXG5cdFx0XHR0aHJvdyBuZXcgRXJyb3IoXCJTaGFkb3dOZWFyTWV0aG9kIHJlcXVpcmVzIGEgbGlnaHQgdGhhdCBoYXMgYSBOZWFyRGlyZWN0aW9uYWxTaGFkb3dNYXBwZXIgaW5zdGFuY2UgYXNzaWduZWQgdG8gc2hhZG93TWFwcGVyLlwiKTtcclxuXHRcdHRoaXMuX2Jhc2VNZXRob2QuYWRkRXZlbnRMaXN0ZW5lcihTaGFkaW5nTWV0aG9kRXZlbnQuU0hBREVSX0lOVkFMSURBVEVELCB0aGlzLl9vblNoYWRlckludmFsaWRhdGVkRGVsZWdhdGUpO1xyXG5cdH1cclxuXHJcblx0LyoqXHJcblx0ICogVGhlIGJhc2Ugc2hhZG93IG1hcCBtZXRob2Qgb24gd2hpY2ggdGhpcyBtZXRob2QncyBzaGFkaW5nIGlzIGJhc2VkLlxyXG5cdCAqL1xyXG5cdHB1YmxpYyBnZXQgYmFzZU1ldGhvZCgpOlNoYWRvd01ldGhvZEJhc2VcclxuXHR7XHJcblx0XHRyZXR1cm4gdGhpcy5fYmFzZU1ldGhvZDtcclxuXHR9XHJcblxyXG5cdHB1YmxpYyBzZXQgYmFzZU1ldGhvZCh2YWx1ZTpTaGFkb3dNZXRob2RCYXNlKVxyXG5cdHtcclxuXHRcdGlmICh0aGlzLl9iYXNlTWV0aG9kID09IHZhbHVlKVxyXG5cdFx0XHRyZXR1cm47XHJcblxyXG5cdFx0dGhpcy5fYmFzZU1ldGhvZC5yZW1vdmVFdmVudExpc3RlbmVyKFNoYWRpbmdNZXRob2RFdmVudC5TSEFERVJfSU5WQUxJREFURUQsIHRoaXMuX29uU2hhZGVySW52YWxpZGF0ZWREZWxlZ2F0ZSk7XHJcblxyXG5cdFx0dGhpcy5fYmFzZU1ldGhvZCA9IHZhbHVlO1xyXG5cclxuXHRcdHRoaXMuX2Jhc2VNZXRob2QuYWRkRXZlbnRMaXN0ZW5lcihTaGFkaW5nTWV0aG9kRXZlbnQuU0hBREVSX0lOVkFMSURBVEVELCB0aGlzLl9vblNoYWRlckludmFsaWRhdGVkRGVsZWdhdGUpO1xyXG5cclxuXHRcdHRoaXMuaUludmFsaWRhdGVTaGFkZXJQcm9ncmFtKCk7XHJcblx0fVxyXG5cclxuXHQvKipcclxuXHQgKiBAaW5oZXJpdERvY1xyXG5cdCAqL1xyXG5cdHB1YmxpYyBpSW5pdENvbnN0YW50cyhzaGFkZXJPYmplY3Q6U2hhZGVyT2JqZWN0QmFzZSwgbWV0aG9kVk86TWV0aG9kVk8pXHJcblx0e1xyXG5cdFx0c3VwZXIuaUluaXRDb25zdGFudHMoc2hhZGVyT2JqZWN0LCBtZXRob2RWTyk7XHJcblx0XHR0aGlzLl9iYXNlTWV0aG9kLmlJbml0Q29uc3RhbnRzKHNoYWRlck9iamVjdCwgbWV0aG9kVk8pO1xyXG5cclxuXHRcdHZhciBmcmFnbWVudERhdGE6QXJyYXk8bnVtYmVyPiA9IHNoYWRlck9iamVjdC5mcmFnbWVudENvbnN0YW50RGF0YTtcclxuXHRcdHZhciBpbmRleDpudW1iZXIgLyppbnQqLyA9IG1ldGhvZFZPLnNlY29uZGFyeUZyYWdtZW50Q29uc3RhbnRzSW5kZXg7XHJcblx0XHRmcmFnbWVudERhdGFbaW5kZXggKyAyXSA9IDA7XHJcblx0XHRmcmFnbWVudERhdGFbaW5kZXggKyAzXSA9IDE7XHJcblx0fVxyXG5cclxuXHQvKipcclxuXHQgKiBAaW5oZXJpdERvY1xyXG5cdCAqL1xyXG5cdHB1YmxpYyBpSW5pdFZPKHNoYWRlck9iamVjdDpTaGFkZXJMaWdodGluZ09iamVjdCwgbWV0aG9kVk86TWV0aG9kVk8pXHJcblx0e1xyXG5cdFx0dGhpcy5fYmFzZU1ldGhvZC5pSW5pdFZPKHNoYWRlck9iamVjdCwgbWV0aG9kVk8pO1xyXG5cclxuXHRcdG1ldGhvZFZPLm5lZWRzUHJvamVjdGlvbiA9IHRydWU7XHJcblx0fVxyXG5cclxuXHQvKipcclxuXHQgKiBAaW5oZXJpdERvY1xyXG5cdCAqL1xyXG5cdHB1YmxpYyBkaXNwb3NlKClcclxuXHR7XHJcblx0XHR0aGlzLl9iYXNlTWV0aG9kLnJlbW92ZUV2ZW50TGlzdGVuZXIoU2hhZGluZ01ldGhvZEV2ZW50LlNIQURFUl9JTlZBTElEQVRFRCwgdGhpcy5fb25TaGFkZXJJbnZhbGlkYXRlZERlbGVnYXRlKTtcclxuXHR9XHJcblxyXG5cdC8qKlxyXG5cdCAqIEBpbmhlcml0RG9jXHJcblx0ICovXHJcblx0cHVibGljIGdldCBhbHBoYSgpOm51bWJlclxyXG5cdHtcclxuXHRcdHJldHVybiB0aGlzLl9iYXNlTWV0aG9kLmFscGhhO1xyXG5cdH1cclxuXHJcblx0cHVibGljIHNldCBhbHBoYSh2YWx1ZTpudW1iZXIpXHJcblx0e1xyXG5cdFx0dGhpcy5fYmFzZU1ldGhvZC5hbHBoYSA9IHZhbHVlO1xyXG5cdH1cclxuXHJcblx0LyoqXHJcblx0ICogQGluaGVyaXREb2NcclxuXHQgKi9cclxuXHRwdWJsaWMgZ2V0IGVwc2lsb24oKTpudW1iZXJcclxuXHR7XHJcblx0XHRyZXR1cm4gdGhpcy5fYmFzZU1ldGhvZC5lcHNpbG9uO1xyXG5cdH1cclxuXHJcblx0cHVibGljIHNldCBlcHNpbG9uKHZhbHVlOm51bWJlcilcclxuXHR7XHJcblx0XHR0aGlzLl9iYXNlTWV0aG9kLmVwc2lsb24gPSB2YWx1ZTtcclxuXHR9XHJcblxyXG5cdC8qKlxyXG5cdCAqIFRoZSBhbW91bnQgb2Ygc2hhZG93IGZhZGluZyB0byB0aGUgb3V0ZXIgc2hhZG93IGFyZWEuIEEgdmFsdWUgb2YgMSB3b3VsZCBtZWFuIHRoZSBzaGFkb3dzIHN0YXJ0IGZhZGluZyBmcm9tIHRoZSBjYW1lcmEncyBuZWFyIHBsYW5lLlxyXG5cdCAqL1xyXG5cdHB1YmxpYyBnZXQgZmFkZVJhdGlvKCk6bnVtYmVyXHJcblx0e1xyXG5cdFx0cmV0dXJuIHRoaXMuX2ZhZGVSYXRpbztcclxuXHR9XHJcblxyXG5cdHB1YmxpYyBzZXQgZmFkZVJhdGlvKHZhbHVlOm51bWJlcilcclxuXHR7XHJcblx0XHR0aGlzLl9mYWRlUmF0aW8gPSB2YWx1ZTtcclxuXHR9XHJcblxyXG5cdC8qKlxyXG5cdCAqIEBpbmhlcml0RG9jXHJcblx0ICovXHJcblx0cHVibGljIGlHZXRGcmFnbWVudENvZGUoc2hhZGVyT2JqZWN0OlNoYWRlck9iamVjdEJhc2UsIG1ldGhvZFZPOk1ldGhvZFZPLCB0YXJnZXRSZWc6U2hhZGVyUmVnaXN0ZXJFbGVtZW50LCByZWdpc3RlckNhY2hlOlNoYWRlclJlZ2lzdGVyQ2FjaGUsIHNoYXJlZFJlZ2lzdGVyczpTaGFkZXJSZWdpc3RlckRhdGEpOnN0cmluZ1xyXG5cdHtcclxuXHRcdHZhciBjb2RlOnN0cmluZyA9IHRoaXMuX2Jhc2VNZXRob2QuaUdldEZyYWdtZW50Q29kZShzaGFkZXJPYmplY3QsIG1ldGhvZFZPLCB0YXJnZXRSZWcsIHJlZ2lzdGVyQ2FjaGUsIHNoYXJlZFJlZ2lzdGVycyk7XHJcblxyXG5cdFx0dmFyIGRhdGFSZWc6U2hhZGVyUmVnaXN0ZXJFbGVtZW50ID0gcmVnaXN0ZXJDYWNoZS5nZXRGcmVlRnJhZ21lbnRDb25zdGFudCgpO1xyXG5cdFx0dmFyIHRlbXA6U2hhZGVyUmVnaXN0ZXJFbGVtZW50ID0gcmVnaXN0ZXJDYWNoZS5nZXRGcmVlRnJhZ21lbnRTaW5nbGVUZW1wKCk7XHJcblx0XHRtZXRob2RWTy5zZWNvbmRhcnlGcmFnbWVudENvbnN0YW50c0luZGV4ID0gZGF0YVJlZy5pbmRleCo0O1xyXG5cclxuXHRcdGNvZGUgKz0gXCJhYnMgXCIgKyB0ZW1wICsgXCIsIFwiICsgc2hhcmVkUmVnaXN0ZXJzLnByb2plY3Rpb25GcmFnbWVudCArIFwiLndcXG5cIiArXHJcblx0XHRcdFwic3ViIFwiICsgdGVtcCArIFwiLCBcIiArIHRlbXAgKyBcIiwgXCIgKyBkYXRhUmVnICsgXCIueFxcblwiICtcclxuXHRcdFx0XCJtdWwgXCIgKyB0ZW1wICsgXCIsIFwiICsgdGVtcCArIFwiLCBcIiArIGRhdGFSZWcgKyBcIi55XFxuXCIgK1xyXG5cdFx0XHRcInNhdCBcIiArIHRlbXAgKyBcIiwgXCIgKyB0ZW1wICsgXCJcXG5cIiArXHJcblx0XHRcdFwic3ViIFwiICsgdGVtcCArIFwiLCBcIiArIGRhdGFSZWcgKyBcIi53LFwiICsgdGVtcCArIFwiXFxuXCIgK1xyXG5cdFx0XHRcInN1YiBcIiArIHRhcmdldFJlZyArIFwiLncsIFwiICsgZGF0YVJlZyArIFwiLncsXCIgKyB0YXJnZXRSZWcgKyBcIi53XFxuXCIgK1xyXG5cdFx0XHRcIm11bCBcIiArIHRhcmdldFJlZyArIFwiLncsIFwiICsgdGFyZ2V0UmVnICsgXCIudywgXCIgKyB0ZW1wICsgXCJcXG5cIiArXHJcblx0XHRcdFwic3ViIFwiICsgdGFyZ2V0UmVnICsgXCIudywgXCIgKyBkYXRhUmVnICsgXCIudyxcIiArIHRhcmdldFJlZyArIFwiLndcXG5cIjtcclxuXHJcblx0XHRyZXR1cm4gY29kZTtcclxuXHR9XHJcblxyXG5cdC8qKlxyXG5cdCAqIEBpbmhlcml0RG9jXHJcblx0ICovXHJcblx0cHVibGljIGlBY3RpdmF0ZShzaGFkZXJPYmplY3Q6U2hhZGVyT2JqZWN0QmFzZSwgbWV0aG9kVk86TWV0aG9kVk8sIHN0YWdlOlN0YWdlKVxyXG5cdHtcclxuXHRcdHRoaXMuX2Jhc2VNZXRob2QuaUFjdGl2YXRlKHNoYWRlck9iamVjdCwgbWV0aG9kVk8sIHN0YWdlKTtcclxuXHR9XHJcblxyXG5cdC8qKlxyXG5cdCAqIEBpbmhlcml0RG9jXHJcblx0ICovXHJcblx0cHVibGljIGlEZWFjdGl2YXRlKHNoYWRlck9iamVjdDpTaGFkZXJPYmplY3RCYXNlLCBtZXRob2RWTzpNZXRob2RWTywgc3RhZ2U6U3RhZ2UpXHJcblx0e1xyXG5cdFx0dGhpcy5fYmFzZU1ldGhvZC5pRGVhY3RpdmF0ZShzaGFkZXJPYmplY3QsIG1ldGhvZFZPLCBzdGFnZSk7XHJcblx0fVxyXG5cclxuXHQvKipcclxuXHQgKiBAaW5oZXJpdERvY1xyXG5cdCAqL1xyXG5cdHB1YmxpYyBpU2V0UmVuZGVyU3RhdGUoc2hhZGVyT2JqZWN0OlNoYWRlck9iamVjdEJhc2UsIG1ldGhvZFZPOk1ldGhvZFZPLCByZW5kZXJhYmxlOlJlbmRlcmFibGVCYXNlLCBzdGFnZTpTdGFnZSwgY2FtZXJhOkNhbWVyYSlcclxuXHR7XHJcblx0XHQvLyB0b2RvOiBtb3ZlIHRoaXMgdG8gYWN0aXZhdGUgKG5lZWRzIGNhbWVyYSlcclxuXHRcdHZhciBuZWFyOm51bWJlciA9IGNhbWVyYS5wcm9qZWN0aW9uLm5lYXI7XHJcblx0XHR2YXIgZDpudW1iZXIgPSBjYW1lcmEucHJvamVjdGlvbi5mYXIgLSBuZWFyO1xyXG5cdFx0dmFyIG1heERpc3RhbmNlOm51bWJlciA9IHRoaXMuX25lYXJTaGFkb3dNYXBwZXIuY292ZXJhZ2VSYXRpbztcclxuXHRcdHZhciBtaW5EaXN0YW5jZTpudW1iZXIgPSBtYXhEaXN0YW5jZSooMSAtIHRoaXMuX2ZhZGVSYXRpbyk7XHJcblxyXG5cdFx0bWF4RGlzdGFuY2UgPSBuZWFyICsgbWF4RGlzdGFuY2UqZDtcclxuXHRcdG1pbkRpc3RhbmNlID0gbmVhciArIG1pbkRpc3RhbmNlKmQ7XHJcblxyXG5cdFx0dmFyIGZyYWdtZW50RGF0YTpBcnJheTxudW1iZXI+ID0gc2hhZGVyT2JqZWN0LmZyYWdtZW50Q29uc3RhbnREYXRhO1xyXG5cdFx0dmFyIGluZGV4Om51bWJlciAvKmludCovID0gbWV0aG9kVk8uc2Vjb25kYXJ5RnJhZ21lbnRDb25zdGFudHNJbmRleDtcclxuXHRcdGZyYWdtZW50RGF0YVtpbmRleF0gPSBtaW5EaXN0YW5jZTtcclxuXHRcdGZyYWdtZW50RGF0YVtpbmRleCArIDFdID0gMS8obWF4RGlzdGFuY2UgLSBtaW5EaXN0YW5jZSk7XHJcblxyXG5cdFx0dGhpcy5fYmFzZU1ldGhvZC5pU2V0UmVuZGVyU3RhdGUoc2hhZGVyT2JqZWN0LCBtZXRob2RWTywgcmVuZGVyYWJsZSwgc3RhZ2UsIGNhbWVyYSk7XHJcblx0fVxyXG5cclxuXHQvKipcclxuXHQgKiBAaW5oZXJpdERvY1xyXG5cdCAqL1xyXG5cdHB1YmxpYyBpR2V0VmVydGV4Q29kZShzaGFkZXJPYmplY3Q6U2hhZGVyT2JqZWN0QmFzZSwgbWV0aG9kVk86TWV0aG9kVk8sIHJlZ2lzdGVyQ2FjaGU6U2hhZGVyUmVnaXN0ZXJDYWNoZSwgc2hhcmVkUmVnaXN0ZXJzOlNoYWRlclJlZ2lzdGVyRGF0YSk6c3RyaW5nXHJcblx0e1xyXG5cdFx0cmV0dXJuIHRoaXMuX2Jhc2VNZXRob2QuaUdldFZlcnRleENvZGUoc2hhZGVyT2JqZWN0LCBtZXRob2RWTywgcmVnaXN0ZXJDYWNoZSwgc2hhcmVkUmVnaXN0ZXJzKTtcclxuXHR9XHJcblxyXG5cdC8qKlxyXG5cdCAqIEBpbmhlcml0RG9jXHJcblx0ICovXHJcblx0cHVibGljIGlSZXNldCgpXHJcblx0e1xyXG5cdFx0dGhpcy5fYmFzZU1ldGhvZC5pUmVzZXQoKTtcclxuXHR9XHJcblxyXG5cdC8qKlxyXG5cdCAqIEBpbmhlcml0RG9jXHJcblx0ICovXHJcblx0cHVibGljIGlDbGVhbkNvbXBpbGF0aW9uRGF0YSgpXHJcblx0e1xyXG5cdFx0c3VwZXIuaUNsZWFuQ29tcGlsYXRpb25EYXRhKCk7XHJcblx0XHR0aGlzLl9iYXNlTWV0aG9kLmlDbGVhbkNvbXBpbGF0aW9uRGF0YSgpO1xyXG5cdH1cclxuXHJcblx0LyoqXHJcblx0ICogQ2FsbGVkIHdoZW4gdGhlIGJhc2UgbWV0aG9kJ3Mgc2hhZGVyIGNvZGUgaXMgaW52YWxpZGF0ZWQuXHJcblx0ICovXHJcblx0cHJpdmF0ZSBvblNoYWRlckludmFsaWRhdGVkKGV2ZW50OlNoYWRpbmdNZXRob2RFdmVudClcclxuXHR7XHJcblx0XHR0aGlzLmlJbnZhbGlkYXRlU2hhZGVyUHJvZ3JhbSgpO1xyXG5cdH1cclxufVxyXG5cclxuZXhwb3J0ID0gU2hhZG93TmVhck1ldGhvZDsiXX0=