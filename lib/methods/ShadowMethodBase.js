var __extends = this.__extends || function (d, b) {
    for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p];
    function __() { this.constructor = d; }
    __.prototype = b.prototype;
    d.prototype = new __();
};
var AbstractMethodError = require("awayjs-core/lib/errors/AbstractMethodError");
var PointLight = require("awayjs-display/lib/entities/PointLight");
var ShadowMapMethodBase = require("awayjs-methodmaterials/lib/methods/ShadowMapMethodBase");
/**
 * ShadowMethodBase provides an abstract method for simple (non-wrapping) shadow map methods.
 */
var ShadowMethodBase = (function (_super) {
    __extends(ShadowMethodBase, _super);
    /**
     * Creates a new ShadowMethodBase object.
     * @param castingLight The light used to cast shadows.
     */
    function ShadowMethodBase(castingLight) {
        this._pUsePoint = (castingLight instanceof PointLight);
        _super.call(this, castingLight);
    }
    /**
     * @inheritDoc
     */
    ShadowMethodBase.prototype.iInitVO = function (shaderObject, methodVO) {
        methodVO.needsView = true;
        methodVO.needsGlobalVertexPos = true;
        methodVO.needsGlobalFragmentPos = this._pUsePoint;
        methodVO.needsNormals = shaderObject.numLights > 0;
    };
    /**
     * @inheritDoc
     */
    ShadowMethodBase.prototype.iInitConstants = function (shaderObject, methodVO) {
        var fragmentData = shaderObject.fragmentConstantData;
        var vertexData = shaderObject.vertexConstantData;
        var index = methodVO.fragmentConstantsIndex;
        fragmentData[index] = 1.0;
        fragmentData[index + 1] = 1 / 255.0;
        fragmentData[index + 2] = 1 / 65025.0;
        fragmentData[index + 3] = 1 / 16581375.0;
        fragmentData[index + 6] = 0;
        fragmentData[index + 7] = 1;
        if (this._pUsePoint) {
            fragmentData[index + 8] = 0;
            fragmentData[index + 9] = 0;
            fragmentData[index + 10] = 0;
            fragmentData[index + 11] = 1;
        }
        index = methodVO.vertexConstantsIndex;
        if (index != -1) {
            vertexData[index] = .5;
            vertexData[index + 1] = .5;
            vertexData[index + 2] = 0.0;
            vertexData[index + 3] = 1.0;
        }
    };
    Object.defineProperty(ShadowMethodBase.prototype, "_iDepthMapCoordReg", {
        /**
         * Wrappers that override the vertex shader need to set this explicitly
         */
        get: function () {
            return this._pDepthMapCoordReg;
        },
        set: function (value) {
            this._pDepthMapCoordReg = value;
        },
        enumerable: true,
        configurable: true
    });
    /**
     * @inheritDoc
     */
    ShadowMethodBase.prototype.iCleanCompilationData = function () {
        _super.prototype.iCleanCompilationData.call(this);
        this._pDepthMapCoordReg = null;
    };
    /**
     * @inheritDoc
     */
    ShadowMethodBase.prototype.iGetVertexCode = function (shaderObject, methodVO, regCache, sharedRegisters) {
        return this._pUsePoint ? this._pGetPointVertexCode(methodVO, regCache, sharedRegisters) : this.pGetPlanarVertexCode(methodVO, regCache, sharedRegisters);
    };
    /**
     * Gets the vertex code for shadow mapping with a point light.
     *
     * @param methodVO The MethodVO object linking this method with the pass currently being compiled.
     * @param regCache The register cache used during the compilation.
     */
    ShadowMethodBase.prototype._pGetPointVertexCode = function (methodVO, regCache, sharedRegisters) {
        methodVO.vertexConstantsIndex = -1;
        return "";
    };
    /**
     * Gets the vertex code for shadow mapping with a planar shadow map (fe: directional lights).
     *
     * @param methodVO The MethodVO object linking this method with the pass currently being compiled.
     * @param regCache The register cache used during the compilation.
     */
    ShadowMethodBase.prototype.pGetPlanarVertexCode = function (methodVO, regCache, sharedRegisters) {
        var code = "";
        var temp = regCache.getFreeVertexVectorTemp();
        var dataReg = regCache.getFreeVertexConstant();
        var depthMapProj = regCache.getFreeVertexConstant();
        regCache.getFreeVertexConstant();
        regCache.getFreeVertexConstant();
        regCache.getFreeVertexConstant();
        this._pDepthMapCoordReg = regCache.getFreeVarying();
        methodVO.vertexConstantsIndex = dataReg.index * 4;
        // todo: can epsilon be applied here instead of fragment shader?
        code += "m44 " + temp + ", " + sharedRegisters.globalPositionVertex + ", " + depthMapProj + "\n" + "div " + temp + ", " + temp + ", " + temp + ".w\n" + "mul " + temp + ".xy, " + temp + ".xy, " + dataReg + ".xy\n" + "add " + this._pDepthMapCoordReg + ", " + temp + ", " + dataReg + ".xxwz\n";
        //"sub " + this._pDepthMapCoordReg + ".z, " + this._pDepthMapCoordReg + ".z, " + this._pDepthMapCoordReg + ".w\n";
        return code;
    };
    /**
     * @inheritDoc
     */
    ShadowMethodBase.prototype.iGetFragmentCode = function (shaderObject, methodVO, targetReg, registerCache, sharedRegisters) {
        var code = this._pUsePoint ? this._pGetPointFragmentCode(methodVO, targetReg, registerCache, sharedRegisters) : this._pGetPlanarFragmentCode(methodVO, targetReg, registerCache, sharedRegisters);
        code += "add " + targetReg + ".w, " + targetReg + ".w, fc" + (methodVO.fragmentConstantsIndex / 4 + 1) + ".y\n" + "sat " + targetReg + ".w, " + targetReg + ".w\n";
        return code;
    };
    /**
     * Gets the fragment code for shadow mapping with a planar shadow map.
     * @param methodVO The MethodVO object linking this method with the pass currently being compiled.
     * @param regCache The register cache used during the compilation.
     * @param targetReg The register to contain the shadow coverage
     * @return
     */
    ShadowMethodBase.prototype._pGetPlanarFragmentCode = function (methodVO, targetReg, regCache, sharedRegisters) {
        throw new AbstractMethodError();
        return "";
    };
    /**
     * Gets the fragment code for shadow mapping with a point light.
     * @param methodVO The MethodVO object linking this method with the pass currently being compiled.
     * @param regCache The register cache used during the compilation.
     * @param targetReg The register to contain the shadow coverage
     * @return
     */
    ShadowMethodBase.prototype._pGetPointFragmentCode = function (methodVO, targetReg, regCache, sharedRegisters) {
        throw new AbstractMethodError();
        return "";
    };
    /**
     * @inheritDoc
     */
    ShadowMethodBase.prototype.iSetRenderState = function (shaderObject, methodVO, renderable, stage, camera) {
        if (!this._pUsePoint)
            this._pShadowMapper.iDepthProjection.copyRawDataTo(shaderObject.vertexConstantData, methodVO.vertexConstantsIndex + 4, true);
    };
    /**
     * Gets the fragment code for combining this method with a cascaded shadow map method.
     * @param methodVO The MethodVO object linking this method with the pass currently being compiled.
     * @param regCache The register cache used during the compilation.
     * @param decodeRegister The register containing the data to decode the shadow map depth value.
     * @param depthTexture The texture containing the shadow map.
     * @param depthProjection The projection of the fragment relative to the light.
     * @param targetRegister The register to contain the shadow coverage
     * @return
     */
    ShadowMethodBase.prototype._iGetCascadeFragmentCode = function (shaderObject, methodVO, decodeRegister, depthTexture, depthProjection, targetRegister, registerCache, sharedRegisters) {
        throw new Error("This shadow method is incompatible with cascade shadows");
    };
    /**
     * @inheritDoc
     */
    ShadowMethodBase.prototype.iActivate = function (shaderObject, methodVO, stage) {
        var fragmentData = shaderObject.fragmentConstantData;
        var index = methodVO.fragmentConstantsIndex;
        if (this._pUsePoint)
            fragmentData[index + 4] = -Math.pow(1 / (this._pCastingLight.fallOff * this._pEpsilon), 2);
        else
            shaderObject.vertexConstantData[methodVO.vertexConstantsIndex + 3] = -1 / (this._pShadowMapper.depth * this._pEpsilon);
        fragmentData[index + 5] = 1 - this._pAlpha;
        if (this._pUsePoint) {
            var pos = this._pCastingLight.scenePosition;
            fragmentData[index + 8] = pos.x;
            fragmentData[index + 9] = pos.y;
            fragmentData[index + 10] = pos.z;
            // used to decompress distance
            var f = this._pCastingLight.fallOff;
            fragmentData[index + 11] = 1 / (2 * f * f);
        }
        if (!this._pUsePoint)
            stage.activateRenderTexture(methodVO.texturesIndex, this._pCastingLight.shadowMapper.depthMap);
        //else
        //	stage.activateCubeRenderTexture(methodVO.texturesIndex, <CubeTextureBase> this._pCastingLight.shadowMapper.depthMap);
    };
    /**
     * Sets the method state for cascade shadow mapping.
     */
    ShadowMethodBase.prototype.iActivateForCascade = function (shaderObject, methodVO, stage) {
        throw new Error("This shadow method is incompatible with cascade shadows");
    };
    return ShadowMethodBase;
})(ShadowMapMethodBase);
module.exports = ShadowMethodBase;

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImF3YXlqcy1tZXRob2RtYXRlcmlhbHMvbGliL21ldGhvZHMvU2hhZG93TWV0aG9kQmFzZS50cyJdLCJuYW1lcyI6WyJTaGFkb3dNZXRob2RCYXNlIiwiU2hhZG93TWV0aG9kQmFzZS5jb25zdHJ1Y3RvciIsIlNoYWRvd01ldGhvZEJhc2UuaUluaXRWTyIsIlNoYWRvd01ldGhvZEJhc2UuaUluaXRDb25zdGFudHMiLCJTaGFkb3dNZXRob2RCYXNlLl9pRGVwdGhNYXBDb29yZFJlZyIsIlNoYWRvd01ldGhvZEJhc2UuaUNsZWFuQ29tcGlsYXRpb25EYXRhIiwiU2hhZG93TWV0aG9kQmFzZS5pR2V0VmVydGV4Q29kZSIsIlNoYWRvd01ldGhvZEJhc2UuX3BHZXRQb2ludFZlcnRleENvZGUiLCJTaGFkb3dNZXRob2RCYXNlLnBHZXRQbGFuYXJWZXJ0ZXhDb2RlIiwiU2hhZG93TWV0aG9kQmFzZS5pR2V0RnJhZ21lbnRDb2RlIiwiU2hhZG93TWV0aG9kQmFzZS5fcEdldFBsYW5hckZyYWdtZW50Q29kZSIsIlNoYWRvd01ldGhvZEJhc2UuX3BHZXRQb2ludEZyYWdtZW50Q29kZSIsIlNoYWRvd01ldGhvZEJhc2UuaVNldFJlbmRlclN0YXRlIiwiU2hhZG93TWV0aG9kQmFzZS5faUdldENhc2NhZGVGcmFnbWVudENvZGUiLCJTaGFkb3dNZXRob2RCYXNlLmlBY3RpdmF0ZSIsIlNoYWRvd01ldGhvZEJhc2UuaUFjdGl2YXRlRm9yQ2FzY2FkZSJdLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBQ0EsSUFBTyxtQkFBbUIsV0FBYSw0Q0FBNEMsQ0FBQyxDQUFDO0FBT3JGLElBQU8sVUFBVSxXQUFlLHdDQUF3QyxDQUFDLENBQUM7QUFhMUUsSUFBTyxtQkFBbUIsV0FBYSx3REFBd0QsQ0FBQyxDQUFDO0FBRWpHLEFBR0E7O0dBREc7SUFDRyxnQkFBZ0I7SUFBU0EsVUFBekJBLGdCQUFnQkEsVUFBNEJBO0lBS2pEQTs7O09BR0dBO0lBQ0hBLFNBVEtBLGdCQUFnQkEsQ0FTVEEsWUFB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QTtJQUVEZDs7T0FFR0E7SUFDSUEsOENBQW1CQSxHQUExQkEsVUFBMkJBLFlBQTZCQSxFQUFFQSxRQUFpQkEsRUFBRUEsS0FBV0E7UUFFdkZlLE1BQU1BLElBQUlBLEtBQUtBLENBQUNBLHlEQUF5REEsQ0FBQ0EsQ0FBQ0E7SUFDNUVBLENBQUNBO0lBQ0ZmLHVCQUFDQTtBQUFEQSxDQWxPQSxBQWtPQ0EsRUFsTzhCLG1CQUFtQixFQWtPakQ7QUFFRCxBQUEwQixpQkFBakIsZ0JBQWdCLENBQUMiLCJmaWxlIjoibWV0aG9kcy9TaGFkb3dNZXRob2RCYXNlLmpzIiwic291cmNlUm9vdCI6Ii4uLyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBWZWN0b3IzRFx0XHRcdFx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1jb3JlL2xpYi9nZW9tL1ZlY3RvcjNEXCIpO1xyXG5pbXBvcnQgQWJzdHJhY3RNZXRob2RFcnJvclx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1jb3JlL2xpYi9lcnJvcnMvQWJzdHJhY3RNZXRob2RFcnJvclwiKTtcclxuaW1wb3J0IEN1YmVUZXh0dXJlQmFzZVx0XHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLWNvcmUvbGliL3RleHR1cmVzL0N1YmVUZXh0dXJlQmFzZVwiKTtcclxuaW1wb3J0IFRleHR1cmUyREJhc2VcdFx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1jb3JlL2xpYi90ZXh0dXJlcy9UZXh0dXJlMkRCYXNlXCIpO1xyXG5cclxuaW1wb3J0IExpZ2h0QmFzZVx0XHRcdFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtZGlzcGxheS9saWIvYmFzZS9MaWdodEJhc2VcIik7XHJcbmltcG9ydCBDYW1lcmFcdFx0XHRcdFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtZGlzcGxheS9saWIvZW50aXRpZXMvQ2FtZXJhXCIpO1xyXG5pbXBvcnQgRGlyZWN0aW9uYWxMaWdodFx0XHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLWRpc3BsYXkvbGliL2VudGl0aWVzL0RpcmVjdGlvbmFsTGlnaHRcIik7XHJcbmltcG9ydCBQb2ludExpZ2h0XHRcdFx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1kaXNwbGF5L2xpYi9lbnRpdGllcy9Qb2ludExpZ2h0XCIpO1xyXG5pbXBvcnQgRGlyZWN0aW9uYWxTaGFkb3dNYXBwZXJcdFx0PSByZXF1aXJlKFwiYXdheWpzLWRpc3BsYXkvbGliL21hdGVyaWFscy9zaGFkb3dtYXBwZXJzL0RpcmVjdGlvbmFsU2hhZG93TWFwcGVyXCIpO1xyXG5cclxuaW1wb3J0IFN0YWdlXHRcdFx0XHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLXN0YWdlZ2wvbGliL2Jhc2UvU3RhZ2VcIik7XHJcblxyXG5pbXBvcnQgUmVuZGVyYWJsZUJhc2VcdFx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1yZW5kZXJlcmdsL2xpYi9wb29sL1JlbmRlcmFibGVCYXNlXCIpO1xyXG5pbXBvcnQgU2hhZGVyTGlnaHRpbmdPYmplY3RcdFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtcmVuZGVyZXJnbC9saWIvY29tcGlsYXRpb24vU2hhZGVyTGlnaHRpbmdPYmplY3RcIik7XHJcbmltcG9ydCBTaGFkZXJPYmplY3RCYXNlXHRcdFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtcmVuZGVyZXJnbC9saWIvY29tcGlsYXRpb24vU2hhZGVyT2JqZWN0QmFzZVwiKTtcclxuaW1wb3J0IFNoYWRlclJlZ2lzdGVyQ2FjaGVcdFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtcmVuZGVyZXJnbC9saWIvY29tcGlsYXRpb24vU2hhZGVyUmVnaXN0ZXJDYWNoZVwiKTtcclxuaW1wb3J0IFNoYWRlclJlZ2lzdGVyRGF0YVx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1yZW5kZXJlcmdsL2xpYi9jb21waWxhdGlvbi9TaGFkZXJSZWdpc3RlckRhdGFcIik7XHJcbmltcG9ydCBTaGFkZXJSZWdpc3RlckVsZW1lbnRcdFx0PSByZXF1aXJlKFwiYXdheWpzLXJlbmRlcmVyZ2wvbGliL2NvbXBpbGF0aW9uL1NoYWRlclJlZ2lzdGVyRWxlbWVudFwiKTtcclxuXHJcbmltcG9ydCBNZXRob2RWT1x0XHRcdFx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1tZXRob2RtYXRlcmlhbHMvbGliL2RhdGEvTWV0aG9kVk9cIik7XHJcbmltcG9ydCBTaGFkb3dNYXBNZXRob2RCYXNlXHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLW1ldGhvZG1hdGVyaWFscy9saWIvbWV0aG9kcy9TaGFkb3dNYXBNZXRob2RCYXNlXCIpO1xyXG5cclxuLyoqXHJcbiAqIFNoYWRvd01ldGhvZEJhc2UgcHJvdmlkZXMgYW4gYWJzdHJhY3QgbWV0aG9kIGZvciBzaW1wbGUgKG5vbi13cmFwcGluZykgc2hhZG93IG1hcCBtZXRob2RzLlxyXG4gKi9cclxuY2xhc3MgU2hhZG93TWV0aG9kQmFzZSBleHRlbmRzIFNoYWRvd01hcE1ldGhvZEJhc2Vcclxue1xyXG5cdHB1YmxpYyBfcERlcHRoTWFwQ29vcmRSZWc6U2hhZGVyUmVnaXN0ZXJFbGVtZW50O1xyXG5cdHB1YmxpYyBfcFVzZVBvaW50OmJvb2xlYW47XHJcblxyXG5cdC8qKlxyXG5cdCAqIENyZWF0ZXMgYSBuZXcgU2hhZG93TWV0aG9kQmFzZSBvYmplY3QuXHJcblx0ICogQHBhcmFtIGNhc3RpbmdMaWdodCBUaGUgbGlnaHQgdXNlZCB0byBjYXN0IHNoYWRvd3MuXHJcblx0ICovXHJcblx0Y29uc3RydWN0b3IoY2FzdGluZ0xpZ2h0OkxpZ2h0QmFzZSlcclxuXHR7XHJcblx0XHR0aGlzLl9wVXNlUG9pbnQgPSAoY2FzdGluZ0xpZ2h0IGluc3RhbmNlb2YgUG9pbnRMaWdodCk7XHJcblxyXG5cdFx0c3VwZXIoY2FzdGluZ0xpZ2h0KTtcclxuXHR9XHJcblxyXG5cdC8qKlxyXG5cdCAqIEBpbmhlcml0RG9jXHJcblx0ICovXHJcblx0cHVibGljIGlJbml0Vk8oc2hhZGVyT2JqZWN0OlNoYWRlckxpZ2h0aW5nT2JqZWN0LCBtZXRob2RWTzpNZXRob2RWTylcclxuXHR7XHJcblx0XHRtZXRob2RWTy5uZWVkc1ZpZXcgPSB0cnVlO1xyXG5cdFx0bWV0aG9kVk8ubmVlZHNHbG9iYWxWZXJ0ZXhQb3MgPSB0cnVlO1xyXG5cdFx0bWV0aG9kVk8ubmVlZHNHbG9iYWxGcmFnbWVudFBvcyA9IHRoaXMuX3BVc2VQb2ludDtcclxuXHRcdG1ldGhvZFZPLm5lZWRzTm9ybWFscyA9IHNoYWRlck9iamVjdC5udW1MaWdodHMgPiAwO1xyXG5cdH1cclxuXHJcblx0LyoqXHJcblx0ICogQGluaGVyaXREb2NcclxuXHQgKi9cclxuXHRwdWJsaWMgaUluaXRDb25zdGFudHMoc2hhZGVyT2JqZWN0OlNoYWRlck9iamVjdEJhc2UsIG1ldGhvZFZPOk1ldGhvZFZPKVxyXG5cdHtcclxuXHRcdHZhciBmcmFnbWVudERhdGE6QXJyYXk8bnVtYmVyPiA9IHNoYWRlck9iamVjdC5mcmFnbWVudENvbnN0YW50RGF0YTtcclxuXHRcdHZhciB2ZXJ0ZXhEYXRhOkFycmF5PG51bWJlcj4gPSBzaGFkZXJPYmplY3QudmVydGV4Q29uc3RhbnREYXRhO1xyXG5cdFx0dmFyIGluZGV4Om51bWJlciAvKmludCovID0gbWV0aG9kVk8uZnJhZ21lbnRDb25zdGFudHNJbmRleDtcclxuXHRcdGZyYWdtZW50RGF0YVtpbmRleF0gPSAxLjA7XHJcblx0XHRmcmFnbWVudERhdGFbaW5kZXggKyAxXSA9IDEvMjU1LjA7XHJcblx0XHRmcmFnbWVudERhdGFbaW5kZXggKyAyXSA9IDEvNjUwMjUuMDtcclxuXHRcdGZyYWdtZW50RGF0YVtpbmRleCArIDNdID0gMS8xNjU4MTM3NS4wO1xyXG5cclxuXHRcdGZyYWdtZW50RGF0YVtpbmRleCArIDZdID0gMDtcclxuXHRcdGZyYWdtZW50RGF0YVtpbmRleCArIDddID0gMTtcclxuXHJcblx0XHRpZiAodGhpcy5fcFVzZVBvaW50KSB7XHJcblx0XHRcdGZyYWdtZW50RGF0YVtpbmRleCArIDhdID0gMDtcclxuXHRcdFx0ZnJhZ21lbnREYXRhW2luZGV4ICsgOV0gPSAwO1xyXG5cdFx0XHRmcmFnbWVudERhdGFbaW5kZXggKyAxMF0gPSAwO1xyXG5cdFx0XHRmcmFnbWVudERhdGFbaW5kZXggKyAxMV0gPSAxO1xyXG5cdFx0fVxyXG5cclxuXHRcdGluZGV4ID0gbWV0aG9kVk8udmVydGV4Q29uc3RhbnRzSW5kZXg7XHJcblx0XHRpZiAoaW5kZXggIT0gLTEpIHtcclxuXHRcdFx0dmVydGV4RGF0YVtpbmRleF0gPSAuNTtcclxuXHRcdFx0dmVydGV4RGF0YVtpbmRleCArIDFdID0gLjU7XHJcblx0XHRcdHZlcnRleERhdGFbaW5kZXggKyAyXSA9IDAuMDtcclxuXHRcdFx0dmVydGV4RGF0YVtpbmRleCArIDNdID0gMS4wO1xyXG5cdFx0fVxyXG5cdH1cclxuXHJcblx0LyoqXHJcblx0ICogV3JhcHBlcnMgdGhhdCBvdmVycmlkZSB0aGUgdmVydGV4IHNoYWRlciBuZWVkIHRvIHNldCB0aGlzIGV4cGxpY2l0bHlcclxuXHQgKi9cclxuXHRwdWJsaWMgZ2V0IF9pRGVwdGhNYXBDb29yZFJlZygpOlNoYWRlclJlZ2lzdGVyRWxlbWVudFxyXG5cdHtcclxuXHRcdHJldHVybiB0aGlzLl9wRGVwdGhNYXBDb29yZFJlZztcclxuXHR9XHJcblxyXG5cdHB1YmxpYyBzZXQgX2lEZXB0aE1hcENvb3JkUmVnKHZhbHVlOlNoYWRlclJlZ2lzdGVyRWxlbWVudClcclxuXHR7XHJcblx0XHR0aGlzLl9wRGVwdGhNYXBDb29yZFJlZyA9IHZhbHVlO1xyXG5cdH1cclxuXHJcblx0LyoqXHJcblx0ICogQGluaGVyaXREb2NcclxuXHQgKi9cclxuXHRwdWJsaWMgaUNsZWFuQ29tcGlsYXRpb25EYXRhKClcclxuXHR7XHJcblx0XHRzdXBlci5pQ2xlYW5Db21waWxhdGlvbkRhdGEoKTtcclxuXHJcblx0XHR0aGlzLl9wRGVwdGhNYXBDb29yZFJlZyA9IG51bGw7XHJcblx0fVxyXG5cclxuXHQvKipcclxuXHQgKiBAaW5oZXJpdERvY1xyXG5cdCAqL1xyXG5cdHB1YmxpYyBpR2V0VmVydGV4Q29kZShzaGFkZXJPYmplY3Q6U2hhZGVyT2JqZWN0QmFzZSwgbWV0aG9kVk86TWV0aG9kVk8sIHJlZ0NhY2hlOlNoYWRlclJlZ2lzdGVyQ2FjaGUsIHNoYXJlZFJlZ2lzdGVyczpTaGFkZXJSZWdpc3RlckRhdGEpOnN0cmluZ1xyXG5cdHtcclxuXHRcdHJldHVybiB0aGlzLl9wVXNlUG9pbnQ/IHRoaXMuX3BHZXRQb2ludFZlcnRleENvZGUobWV0aG9kVk8sIHJlZ0NhY2hlLCBzaGFyZWRSZWdpc3RlcnMpOnRoaXMucEdldFBsYW5hclZlcnRleENvZGUobWV0aG9kVk8sIHJlZ0NhY2hlLCBzaGFyZWRSZWdpc3RlcnMpO1xyXG5cdH1cclxuXHJcblx0LyoqXHJcblx0ICogR2V0cyB0aGUgdmVydGV4IGNvZGUgZm9yIHNoYWRvdyBtYXBwaW5nIHdpdGggYSBwb2ludCBsaWdodC5cclxuXHQgKlxyXG5cdCAqIEBwYXJhbSBtZXRob2RWTyBUaGUgTWV0aG9kVk8gb2JqZWN0IGxpbmtpbmcgdGhpcyBtZXRob2Qgd2l0aCB0aGUgcGFzcyBjdXJyZW50bHkgYmVpbmcgY29tcGlsZWQuXHJcblx0ICogQHBhcmFtIHJlZ0NhY2hlIFRoZSByZWdpc3RlciBjYWNoZSB1c2VkIGR1cmluZyB0aGUgY29tcGlsYXRpb24uXHJcblx0ICovXHJcblx0cHVibGljIF9wR2V0UG9pbnRWZXJ0ZXhDb2RlKG1ldGhvZFZPOk1ldGhvZFZPLCByZWdDYWNoZTpTaGFkZXJSZWdpc3RlckNhY2hlLCBzaGFyZWRSZWdpc3RlcnM6U2hhZGVyUmVnaXN0ZXJEYXRhKTpzdHJpbmdcclxuXHR7XHJcblx0XHRtZXRob2RWTy52ZXJ0ZXhDb25zdGFudHNJbmRleCA9IC0xO1xyXG5cdFx0cmV0dXJuIFwiXCI7XHJcblx0fVxyXG5cclxuXHQvKipcclxuXHQgKiBHZXRzIHRoZSB2ZXJ0ZXggY29kZSBmb3Igc2hhZG93IG1hcHBpbmcgd2l0aCBhIHBsYW5hciBzaGFkb3cgbWFwIChmZTogZGlyZWN0aW9uYWwgbGlnaHRzKS5cclxuXHQgKlxyXG5cdCAqIEBwYXJhbSBtZXRob2RWTyBUaGUgTWV0aG9kVk8gb2JqZWN0IGxpbmtpbmcgdGhpcyBtZXRob2Qgd2l0aCB0aGUgcGFzcyBjdXJyZW50bHkgYmVpbmcgY29tcGlsZWQuXHJcblx0ICogQHBhcmFtIHJlZ0NhY2hlIFRoZSByZWdpc3RlciBjYWNoZSB1c2VkIGR1cmluZyB0aGUgY29tcGlsYXRpb24uXHJcblx0ICovXHJcblx0cHVibGljIHBHZXRQbGFuYXJWZXJ0ZXhDb2RlKG1ldGhvZFZPOk1ldGhvZFZPLCByZWdDYWNoZTpTaGFkZXJSZWdpc3RlckNhY2hlLCBzaGFyZWRSZWdpc3RlcnM6U2hhZGVyUmVnaXN0ZXJEYXRhKTpzdHJpbmdcclxuXHR7XHJcblx0XHR2YXIgY29kZTpzdHJpbmcgPSBcIlwiO1xyXG5cdFx0dmFyIHRlbXA6U2hhZGVyUmVnaXN0ZXJFbGVtZW50ID0gcmVnQ2FjaGUuZ2V0RnJlZVZlcnRleFZlY3RvclRlbXAoKTtcclxuXHRcdHZhciBkYXRhUmVnOlNoYWRlclJlZ2lzdGVyRWxlbWVudCA9IHJlZ0NhY2hlLmdldEZyZWVWZXJ0ZXhDb25zdGFudCgpO1xyXG5cdFx0dmFyIGRlcHRoTWFwUHJvajpTaGFkZXJSZWdpc3RlckVsZW1lbnQgPSByZWdDYWNoZS5nZXRGcmVlVmVydGV4Q29uc3RhbnQoKTtcclxuXHRcdHJlZ0NhY2hlLmdldEZyZWVWZXJ0ZXhDb25zdGFudCgpO1xyXG5cdFx0cmVnQ2FjaGUuZ2V0RnJlZVZlcnRleENvbnN0YW50KCk7XHJcblx0XHRyZWdDYWNoZS5nZXRGcmVlVmVydGV4Q29uc3RhbnQoKTtcclxuXHRcdHRoaXMuX3BEZXB0aE1hcENvb3JkUmVnID0gcmVnQ2FjaGUuZ2V0RnJlZVZhcnlpbmcoKTtcclxuXHRcdG1ldGhvZFZPLnZlcnRleENvbnN0YW50c0luZGV4ID0gZGF0YVJlZy5pbmRleCo0O1xyXG5cclxuXHRcdC8vIHRvZG86IGNhbiBlcHNpbG9uIGJlIGFwcGxpZWQgaGVyZSBpbnN0ZWFkIG9mIGZyYWdtZW50IHNoYWRlcj9cclxuXHJcblx0XHRjb2RlICs9IFwibTQ0IFwiICsgdGVtcCArIFwiLCBcIiArIHNoYXJlZFJlZ2lzdGVycy5nbG9iYWxQb3NpdGlvblZlcnRleCArIFwiLCBcIiArIGRlcHRoTWFwUHJvaiArIFwiXFxuXCIgKyBcImRpdiBcIiArIHRlbXAgKyBcIiwgXCIgKyB0ZW1wICsgXCIsIFwiICsgdGVtcCArIFwiLndcXG5cIiArIFwibXVsIFwiICsgdGVtcCArIFwiLnh5LCBcIiArIHRlbXAgKyBcIi54eSwgXCIgKyBkYXRhUmVnICsgXCIueHlcXG5cIiArIFwiYWRkIFwiICsgdGhpcy5fcERlcHRoTWFwQ29vcmRSZWcgKyBcIiwgXCIgKyB0ZW1wICsgXCIsIFwiICsgZGF0YVJlZyArIFwiLnh4d3pcXG5cIjtcclxuXHRcdC8vXCJzdWIgXCIgKyB0aGlzLl9wRGVwdGhNYXBDb29yZFJlZyArIFwiLnosIFwiICsgdGhpcy5fcERlcHRoTWFwQ29vcmRSZWcgKyBcIi56LCBcIiArIHRoaXMuX3BEZXB0aE1hcENvb3JkUmVnICsgXCIud1xcblwiO1xyXG5cclxuXHRcdHJldHVybiBjb2RlO1xyXG5cdH1cclxuXHJcblx0LyoqXHJcblx0ICogQGluaGVyaXREb2NcclxuXHQgKi9cclxuXHRwdWJsaWMgaUdldEZyYWdtZW50Q29kZShzaGFkZXJPYmplY3Q6U2hhZGVyT2JqZWN0QmFzZSwgbWV0aG9kVk86TWV0aG9kVk8sIHRhcmdldFJlZzpTaGFkZXJSZWdpc3RlckVsZW1lbnQsIHJlZ2lzdGVyQ2FjaGU6U2hhZGVyUmVnaXN0ZXJDYWNoZSwgc2hhcmVkUmVnaXN0ZXJzOlNoYWRlclJlZ2lzdGVyRGF0YSk6c3RyaW5nXHJcblx0e1xyXG5cdFx0dmFyIGNvZGU6c3RyaW5nID0gdGhpcy5fcFVzZVBvaW50PyB0aGlzLl9wR2V0UG9pbnRGcmFnbWVudENvZGUobWV0aG9kVk8sIHRhcmdldFJlZywgcmVnaXN0ZXJDYWNoZSwgc2hhcmVkUmVnaXN0ZXJzKTp0aGlzLl9wR2V0UGxhbmFyRnJhZ21lbnRDb2RlKG1ldGhvZFZPLCB0YXJnZXRSZWcsIHJlZ2lzdGVyQ2FjaGUsIHNoYXJlZFJlZ2lzdGVycyk7XHJcblx0XHRjb2RlICs9IFwiYWRkIFwiICsgdGFyZ2V0UmVnICsgXCIudywgXCIgKyB0YXJnZXRSZWcgKyBcIi53LCBmY1wiICsgKG1ldGhvZFZPLmZyYWdtZW50Q29uc3RhbnRzSW5kZXgvNCArIDEpICsgXCIueVxcblwiICsgXCJzYXQgXCIgKyB0YXJnZXRSZWcgKyBcIi53LCBcIiArIHRhcmdldFJlZyArIFwiLndcXG5cIjtcclxuXHRcdHJldHVybiBjb2RlO1xyXG5cdH1cclxuXHJcblx0LyoqXHJcblx0ICogR2V0cyB0aGUgZnJhZ21lbnQgY29kZSBmb3Igc2hhZG93IG1hcHBpbmcgd2l0aCBhIHBsYW5hciBzaGFkb3cgbWFwLlxyXG5cdCAqIEBwYXJhbSBtZXRob2RWTyBUaGUgTWV0aG9kVk8gb2JqZWN0IGxpbmtpbmcgdGhpcyBtZXRob2Qgd2l0aCB0aGUgcGFzcyBjdXJyZW50bHkgYmVpbmcgY29tcGlsZWQuXHJcblx0ICogQHBhcmFtIHJlZ0NhY2hlIFRoZSByZWdpc3RlciBjYWNoZSB1c2VkIGR1cmluZyB0aGUgY29tcGlsYXRpb24uXHJcblx0ICogQHBhcmFtIHRhcmdldFJlZyBUaGUgcmVnaXN0ZXIgdG8gY29udGFpbiB0aGUgc2hhZG93IGNvdmVyYWdlXHJcblx0ICogQHJldHVyblxyXG5cdCAqL1xyXG5cdHB1YmxpYyBfcEdldFBsYW5hckZyYWdtZW50Q29kZShtZXRob2RWTzpNZXRob2RWTywgdGFyZ2V0UmVnOlNoYWRlclJlZ2lzdGVyRWxlbWVudCwgcmVnQ2FjaGU6U2hhZGVyUmVnaXN0ZXJDYWNoZSwgc2hhcmVkUmVnaXN0ZXJzOlNoYWRlclJlZ2lzdGVyRGF0YSk6c3RyaW5nXHJcblx0e1xyXG5cdFx0dGhyb3cgbmV3IEFic3RyYWN0TWV0aG9kRXJyb3IoKTtcclxuXHRcdHJldHVybiBcIlwiO1xyXG5cdH1cclxuXHJcblx0LyoqXHJcblx0ICogR2V0cyB0aGUgZnJhZ21lbnQgY29kZSBmb3Igc2hhZG93IG1hcHBpbmcgd2l0aCBhIHBvaW50IGxpZ2h0LlxyXG5cdCAqIEBwYXJhbSBtZXRob2RWTyBUaGUgTWV0aG9kVk8gb2JqZWN0IGxpbmtpbmcgdGhpcyBtZXRob2Qgd2l0aCB0aGUgcGFzcyBjdXJyZW50bHkgYmVpbmcgY29tcGlsZWQuXHJcblx0ICogQHBhcmFtIHJlZ0NhY2hlIFRoZSByZWdpc3RlciBjYWNoZSB1c2VkIGR1cmluZyB0aGUgY29tcGlsYXRpb24uXHJcblx0ICogQHBhcmFtIHRhcmdldFJlZyBUaGUgcmVnaXN0ZXIgdG8gY29udGFpbiB0aGUgc2hhZG93IGNvdmVyYWdlXHJcblx0ICogQHJldHVyblxyXG5cdCAqL1xyXG5cdHB1YmxpYyBfcEdldFBvaW50RnJhZ21lbnRDb2RlKG1ldGhvZFZPOk1ldGhvZFZPLCB0YXJnZXRSZWc6U2hhZGVyUmVnaXN0ZXJFbGVtZW50LCByZWdDYWNoZTpTaGFkZXJSZWdpc3RlckNhY2hlLCBzaGFyZWRSZWdpc3RlcnM6U2hhZGVyUmVnaXN0ZXJEYXRhKTpzdHJpbmdcclxuXHR7XHJcblx0XHR0aHJvdyBuZXcgQWJzdHJhY3RNZXRob2RFcnJvcigpO1xyXG5cdFx0cmV0dXJuIFwiXCI7XHJcblx0fVxyXG5cclxuXHQvKipcclxuXHQgKiBAaW5oZXJpdERvY1xyXG5cdCAqL1xyXG5cdHB1YmxpYyBpU2V0UmVuZGVyU3RhdGUoc2hhZGVyT2JqZWN0OlNoYWRlck9iamVjdEJhc2UsIG1ldGhvZFZPOk1ldGhvZFZPLCByZW5kZXJhYmxlOlJlbmRlcmFibGVCYXNlLCBzdGFnZTpTdGFnZSwgY2FtZXJhOkNhbWVyYSlcclxuXHR7XHJcblx0XHRpZiAoIXRoaXMuX3BVc2VQb2ludClcclxuXHRcdFx0KDxEaXJlY3Rpb25hbFNoYWRvd01hcHBlcj4gdGhpcy5fcFNoYWRvd01hcHBlcikuaURlcHRoUHJvamVjdGlvbi5jb3B5UmF3RGF0YVRvKHNoYWRlck9iamVjdC52ZXJ0ZXhDb25zdGFudERhdGEsIG1ldGhvZFZPLnZlcnRleENvbnN0YW50c0luZGV4ICsgNCwgdHJ1ZSk7XHJcblx0fVxyXG5cclxuXHQvKipcclxuXHQgKiBHZXRzIHRoZSBmcmFnbWVudCBjb2RlIGZvciBjb21iaW5pbmcgdGhpcyBtZXRob2Qgd2l0aCBhIGNhc2NhZGVkIHNoYWRvdyBtYXAgbWV0aG9kLlxyXG5cdCAqIEBwYXJhbSBtZXRob2RWTyBUaGUgTWV0aG9kVk8gb2JqZWN0IGxpbmtpbmcgdGhpcyBtZXRob2Qgd2l0aCB0aGUgcGFzcyBjdXJyZW50bHkgYmVpbmcgY29tcGlsZWQuXHJcblx0ICogQHBhcmFtIHJlZ0NhY2hlIFRoZSByZWdpc3RlciBjYWNoZSB1c2VkIGR1cmluZyB0aGUgY29tcGlsYXRpb24uXHJcblx0ICogQHBhcmFtIGRlY29kZVJlZ2lzdGVyIFRoZSByZWdpc3RlciBjb250YWluaW5nIHRoZSBkYXRhIHRvIGRlY29kZSB0aGUgc2hhZG93IG1hcCBkZXB0aCB2YWx1ZS5cclxuXHQgKiBAcGFyYW0gZGVwdGhUZXh0dXJlIFRoZSB0ZXh0dXJlIGNvbnRhaW5pbmcgdGhlIHNoYWRvdyBtYXAuXHJcblx0ICogQHBhcmFtIGRlcHRoUHJvamVjdGlvbiBUaGUgcHJvamVjdGlvbiBvZiB0aGUgZnJhZ21lbnQgcmVsYXRpdmUgdG8gdGhlIGxpZ2h0LlxyXG5cdCAqIEBwYXJhbSB0YXJnZXRSZWdpc3RlciBUaGUgcmVnaXN0ZXIgdG8gY29udGFpbiB0aGUgc2hhZG93IGNvdmVyYWdlXHJcblx0ICogQHJldHVyblxyXG5cdCAqL1xyXG5cdHB1YmxpYyBfaUdldENhc2NhZGVGcmFnbWVudENvZGUoc2hhZGVyT2JqZWN0OlNoYWRlck9iamVjdEJhc2UsIG1ldGhvZFZPOk1ldGhvZFZPLCBkZWNvZGVSZWdpc3RlcjpTaGFkZXJSZWdpc3RlckVsZW1lbnQsIGRlcHRoVGV4dHVyZTpTaGFkZXJSZWdpc3RlckVsZW1lbnQsIGRlcHRoUHJvamVjdGlvbjpTaGFkZXJSZWdpc3RlckVsZW1lbnQsIHRhcmdldFJlZ2lzdGVyOlNoYWRlclJlZ2lzdGVyRWxlbWVudCwgcmVnaXN0ZXJDYWNoZTpTaGFkZXJSZWdpc3RlckNhY2hlLCBzaGFyZWRSZWdpc3RlcnM6U2hhZGVyUmVnaXN0ZXJEYXRhKTpzdHJpbmdcclxuXHR7XHJcblx0XHR0aHJvdyBuZXcgRXJyb3IoXCJUaGlzIHNoYWRvdyBtZXRob2QgaXMgaW5jb21wYXRpYmxlIHdpdGggY2FzY2FkZSBzaGFkb3dzXCIpO1xyXG5cdH1cclxuXHJcblx0LyoqXHJcblx0ICogQGluaGVyaXREb2NcclxuXHQgKi9cclxuXHRwdWJsaWMgaUFjdGl2YXRlKHNoYWRlck9iamVjdDpTaGFkZXJPYmplY3RCYXNlLCBtZXRob2RWTzpNZXRob2RWTywgc3RhZ2U6U3RhZ2UpXHJcblx0e1xyXG5cdFx0dmFyIGZyYWdtZW50RGF0YTpBcnJheTxudW1iZXI+ID0gc2hhZGVyT2JqZWN0LmZyYWdtZW50Q29uc3RhbnREYXRhO1xyXG5cdFx0dmFyIGluZGV4Om51bWJlciAvKmludCovID0gbWV0aG9kVk8uZnJhZ21lbnRDb25zdGFudHNJbmRleDtcclxuXHJcblx0XHRpZiAodGhpcy5fcFVzZVBvaW50KVxyXG5cdFx0XHRmcmFnbWVudERhdGFbaW5kZXggKyA0XSA9IC1NYXRoLnBvdygxLygoPFBvaW50TGlnaHQ+IHRoaXMuX3BDYXN0aW5nTGlnaHQpLmZhbGxPZmYqdGhpcy5fcEVwc2lsb24pLCAyKTtcclxuXHRcdGVsc2VcclxuXHRcdFx0c2hhZGVyT2JqZWN0LnZlcnRleENvbnN0YW50RGF0YVttZXRob2RWTy52ZXJ0ZXhDb25zdGFudHNJbmRleCArIDNdID0gLTEvKCg8RGlyZWN0aW9uYWxTaGFkb3dNYXBwZXI+IHRoaXMuX3BTaGFkb3dNYXBwZXIpLmRlcHRoKnRoaXMuX3BFcHNpbG9uKTtcclxuXHJcblx0XHRmcmFnbWVudERhdGFbaW5kZXggKyA1XSA9IDEgLSB0aGlzLl9wQWxwaGE7XHJcblxyXG5cdFx0aWYgKHRoaXMuX3BVc2VQb2ludCkge1xyXG5cdFx0XHR2YXIgcG9zOlZlY3RvcjNEID0gdGhpcy5fcENhc3RpbmdMaWdodC5zY2VuZVBvc2l0aW9uO1xyXG5cdFx0XHRmcmFnbWVudERhdGFbaW5kZXggKyA4XSA9IHBvcy54O1xyXG5cdFx0XHRmcmFnbWVudERhdGFbaW5kZXggKyA5XSA9IHBvcy55O1xyXG5cdFx0XHRmcmFnbWVudERhdGFbaW5kZXggKyAxMF0gPSBwb3MuejtcclxuXHRcdFx0Ly8gdXNlZCB0byBkZWNvbXByZXNzIGRpc3RhbmNlXHJcblx0XHRcdHZhciBmOm51bWJlciA9ICg8UG9pbnRMaWdodD4gdGhpcy5fcENhc3RpbmdMaWdodCkuZmFsbE9mZjtcclxuXHRcdFx0ZnJhZ21lbnREYXRhW2luZGV4ICsgMTFdID0gMS8oMipmKmYpO1xyXG5cdFx0fVxyXG5cclxuXHRcdGlmICghdGhpcy5fcFVzZVBvaW50KVxyXG5cdFx0XHRzdGFnZS5hY3RpdmF0ZVJlbmRlclRleHR1cmUobWV0aG9kVk8udGV4dHVyZXNJbmRleCwgPFRleHR1cmUyREJhc2U+IHRoaXMuX3BDYXN0aW5nTGlnaHQuc2hhZG93TWFwcGVyLmRlcHRoTWFwKTtcclxuXHRcdC8vZWxzZVxyXG5cdFx0Ly9cdHN0YWdlLmFjdGl2YXRlQ3ViZVJlbmRlclRleHR1cmUobWV0aG9kVk8udGV4dHVyZXNJbmRleCwgPEN1YmVUZXh0dXJlQmFzZT4gdGhpcy5fcENhc3RpbmdMaWdodC5zaGFkb3dNYXBwZXIuZGVwdGhNYXApO1xyXG5cdH1cclxuXHJcblx0LyoqXHJcblx0ICogU2V0cyB0aGUgbWV0aG9kIHN0YXRlIGZvciBjYXNjYWRlIHNoYWRvdyBtYXBwaW5nLlxyXG5cdCAqL1xyXG5cdHB1YmxpYyBpQWN0aXZhdGVGb3JDYXNjYWRlKHNoYWRlck9iamVjdDpTaGFkZXJPYmplY3RCYXNlLCBtZXRob2RWTzpNZXRob2RWTywgc3RhZ2U6U3RhZ2UpXHJcblx0e1xyXG5cdFx0dGhyb3cgbmV3IEVycm9yKFwiVGhpcyBzaGFkb3cgbWV0aG9kIGlzIGluY29tcGF0aWJsZSB3aXRoIGNhc2NhZGUgc2hhZG93c1wiKTtcclxuXHR9XHJcbn1cclxuXHJcbmV4cG9ydCA9IFNoYWRvd01ldGhvZEJhc2U7Il19