var __extends = this.__extends || function (d, b) {
    for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p];
    function __() { this.constructor = d; }
    __.prototype = b.prototype;
    d.prototype = new __();
};
var PoissonLookup = require("awayjs-core/lib/geom/PoissonLookup");
var ShadowMethodBase = require("awayjs-methodmaterials/lib/methods/ShadowMethodBase");
/**
 * ShadowSoftMethod provides a soft shadowing technique by randomly distributing sample points.
 */
var ShadowSoftMethod = (function (_super) {
    __extends(ShadowSoftMethod, _super);
    /**
     * Creates a new DiffuseBasicMethod object.
     *
     * @param castingLight The light casting the shadows
     * @param numSamples The amount of samples to take for dithering. Minimum 1, maximum 32.
     */
    function ShadowSoftMethod(castingLight, numSamples, range) {
        if (numSamples === void 0) { numSamples = 5; }
        if (range === void 0) { range = 1; }
        _super.call(this, castingLight);
        this._range = 1;
        this.numSamples = numSamples;
        this.range = range;
    }
    Object.defineProperty(ShadowSoftMethod.prototype, "numSamples", {
        /**
         * The amount of samples to take for dithering. Minimum 1, maximum 32. The actual maximum may depend on the
         * complexity of the shader.
         */
        get: function () {
            return this._numSamples;
        },
        set: function (value /*int*/) {
            this._numSamples = value;
            if (this._numSamples < 1)
                this._numSamples = 1;
            else if (this._numSamples > 32)
                this._numSamples = 32;
            this._offsets = PoissonLookup.getDistribution(this._numSamples);
            this.iInvalidateShaderProgram();
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(ShadowSoftMethod.prototype, "range", {
        /**
         * The range in the shadow map in which to distribute the samples.
         */
        get: function () {
            return this._range;
        },
        set: function (value) {
            this._range = value;
        },
        enumerable: true,
        configurable: true
    });
    /**
     * @inheritDoc
     */
    ShadowSoftMethod.prototype.iInitConstants = function (shaderObject, methodVO) {
        _super.prototype.iInitConstants.call(this, shaderObject, methodVO);
        shaderObject.fragmentConstantData[methodVO.fragmentConstantsIndex + 8] = 1 / this._numSamples;
        shaderObject.fragmentConstantData[methodVO.fragmentConstantsIndex + 9] = 0;
    };
    /**
     * @inheritDoc
     */
    ShadowSoftMethod.prototype.iActivate = function (shaderObject, methodVO, stage) {
        _super.prototype.iActivate.call(this, shaderObject, methodVO, stage);
        var texRange = .5 * this._range / this._pCastingLight.shadowMapper.depthMapSize;
        var data = shaderObject.fragmentConstantData;
        var index = methodVO.fragmentConstantsIndex + 10;
        var len = this._numSamples << 1;
        for (var i = 0; i < len; ++i)
            data[index + i] = this._offsets[i] * texRange;
    };
    /**
     * @inheritDoc
     */
    ShadowSoftMethod.prototype._pGetPlanarFragmentCode = function (methodVO, targetReg, regCache, sharedRegisters) {
        // todo: move some things to super
        var depthMapRegister = regCache.getFreeTextureReg();
        var decReg = regCache.getFreeFragmentConstant();
        var dataReg = regCache.getFreeFragmentConstant();
        var customDataReg = regCache.getFreeFragmentConstant();
        methodVO.fragmentConstantsIndex = decReg.index * 4;
        methodVO.texturesIndex = depthMapRegister.index;
        return this.getSampleCode(regCache, depthMapRegister, decReg, targetReg, customDataReg);
    };
    /**
     * Adds the code for another tap to the shader code.
     * @param uv The uv register for the tap.
     * @param texture The texture register containing the depth map.
     * @param decode The register containing the depth map decoding data.
     * @param target The target register to add the tap comparison result.
     * @param regCache The register cache managing the registers.
     * @return
     */
    ShadowSoftMethod.prototype.addSample = function (uv, texture, decode, target, regCache) {
        var temp = regCache.getFreeFragmentVectorTemp();
        return "tex " + temp + ", " + uv + ", " + texture + " <2d,nearest,clamp>\n" + "dp4 " + temp + ".z, " + temp + ", " + decode + "\n" + "slt " + uv + ".w, " + this._pDepthMapCoordReg + ".z, " + temp + ".z\n" + "add " + target + ".w, " + target + ".w, " + uv + ".w\n";
    };
    /**
     * @inheritDoc
     */
    ShadowSoftMethod.prototype.iActivateForCascade = function (shaderObject, methodVO, stage) {
        _super.prototype.iActivate.call(this, shaderObject, methodVO, stage);
        var texRange = this._range / this._pCastingLight.shadowMapper.depthMapSize;
        var data = shaderObject.fragmentConstantData;
        var index = methodVO.secondaryFragmentConstantsIndex;
        var len = this._numSamples << 1;
        data[index] = 1 / this._numSamples;
        data[index + 1] = 0;
        index += 2;
        for (var i = 0; i < len; ++i)
            data[index + i] = this._offsets[i] * texRange;
        if (len % 4 == 0) {
            data[index + len] = 0;
            data[index + len + 1] = 0;
        }
    };
    /**
     * @inheritDoc
     */
    ShadowSoftMethod.prototype._iGetCascadeFragmentCode = function (shaderObject, methodVO, decodeRegister, depthTexture, depthProjection, targetRegister, registerCache, sharedRegisters) {
        this._pDepthMapCoordReg = depthProjection;
        var dataReg = registerCache.getFreeFragmentConstant();
        methodVO.secondaryFragmentConstantsIndex = dataReg.index * 4;
        return this.getSampleCode(registerCache, depthTexture, decodeRegister, targetRegister, dataReg);
    };
    /**
     * Get the actual shader code for shadow mapping
     * @param regCache The register cache managing the registers.
     * @param depthTexture The texture register containing the depth map.
     * @param decodeRegister The register containing the depth map decoding data.
     * @param targetReg The target register to add the shadow coverage.
     * @param dataReg The register containing additional data.
     */
    ShadowSoftMethod.prototype.getSampleCode = function (regCache, depthTexture, decodeRegister, targetRegister, dataReg) {
        var uvReg;
        var code;
        var offsets = new Array(dataReg + ".zw");
        uvReg = regCache.getFreeFragmentVectorTemp();
        regCache.addFragmentTempUsages(uvReg, 1);
        var temp = regCache.getFreeFragmentVectorTemp();
        var numRegs = this._numSamples >> 1;
        for (var i = 0; i < numRegs; ++i) {
            var reg = regCache.getFreeFragmentConstant();
            offsets.push(reg + ".xy");
            offsets.push(reg + ".zw");
        }
        for (i = 0; i < this._numSamples; ++i) {
            if (i == 0) {
                code = "add " + uvReg + ", " + this._pDepthMapCoordReg + ", " + dataReg + ".zwyy\n" + "tex " + temp + ", " + uvReg + ", " + depthTexture + " <2d,nearest,clamp>\n" + "dp4 " + temp + ".z, " + temp + ", " + decodeRegister + "\n" + "slt " + targetRegister + ".w, " + this._pDepthMapCoordReg + ".z, " + temp + ".z\n"; // 0 if in shadow;
            }
            else {
                code += "add " + uvReg + ".xy, " + this._pDepthMapCoordReg + ".xy, " + offsets[i] + "\n" + this.addSample(uvReg, depthTexture, decodeRegister, targetRegister, regCache);
            }
        }
        regCache.removeFragmentTempUsage(uvReg);
        code += "mul " + targetRegister + ".w, " + targetRegister + ".w, " + dataReg + ".x\n"; // average
        return code;
    };
    return ShadowSoftMethod;
})(ShadowMethodBase);
module.exports = ShadowSoftMethod;

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImF3YXlqcy1tZXRob2RtYXRlcmlhbHMvbGliL21ldGhvZHMvU2hhZG93U29mdE1ldGhvZC50cyJdLCJuYW1lcyI6WyJTaGFkb3dTb2Z0TWV0aG9kIiwiU2hhZG93U29mdE1ldGhvZC5jb25zdHJ1Y3RvciIsIlNoYWRvd1NvZnRNZXRob2QubnVtU2FtcGxlcyIsIlNoYWRvd1NvZnRNZXRob2QucmFuZ2UiLCJTaGFkb3dTb2Z0TWV0aG9kLmlJbml0Q29uc3RhbnRzIiwiU2hhZG93U29mdE1ldGhvZC5pQWN0aXZhdGUiLCJTaGFkb3dTb2Z0TWV0aG9kLl9wR2V0UGxhbmFyRnJhZ21lbnRDb2RlIiwiU2hhZG93U29mdE1ldGhvZC5hZGRTYW1wbGUiLCJTaGFkb3dTb2Z0TWV0aG9kLmlBY3RpdmF0ZUZvckNhc2NhZGUiLCJTaGFkb3dTb2Z0TWV0aG9kLl9pR2V0Q2FzY2FkZUZyYWdtZW50Q29kZSIsIlNoYWRvd1NvZnRNZXRob2QuZ2V0U2FtcGxlQ29kZSJdLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBQUEsSUFBTyxhQUFhLFdBQWUsb0NBQW9DLENBQUMsQ0FBQztBQVl6RSxJQUFPLGdCQUFnQixXQUFlLHFEQUFxRCxDQUFDLENBQUM7QUFFN0YsQUFHQTs7R0FERztJQUNHLGdCQUFnQjtJQUFTQSxVQUF6QkEsZ0JBQWdCQSxVQUF5QkE7SUFNOUNBOzs7OztPQUtHQTtJQUNIQSxTQVpLQSxnQkFBZ0JBLENBWVRBLFlBQTZCQSxFQUFFQSxVQUE2QkEsRUFBRUEsS0FBZ0JBO1FBQS9DQywwQkFBNkJBLEdBQTdCQSxjQUE2QkE7UUFBRUEscUJBQWdCQSxHQUFoQkEsU0FBZ0JBO1FBRXpGQSxrQkFBTUEsWUFBWUEsQ0FBQ0EsQ0FBQ0E7UUFaYkEsV0FBTUEsR0FBVUEsQ0FBQ0EsQ0FBQ0E7UUFjekJBLElBQUlBLENBQUNBLFVBQVVBLEdBQUdBLFVBQVVBLENBQUNBO1FBQzdCQSxJQUFJQSxDQUFDQSxLQUFLQSxHQUFHQSxLQUFLQSxDQUFDQTtJQUNwQkEsQ0FBQ0E7SUFNREQs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LHVCQUF1QkEsR0FDNUVBLE1BQU1BLEdBQUdBLElBQUlBLEdBQUdBLE1BQU1BLEdBQUdBLElBQUlBLEdBQUdBLElBQUlBLEdBQUdBLGNBQWNBLEdBQUdBLElBQUlBLEdBQzVEQSxNQUFNQSxHQUFHQSxjQUFjQSxHQUFHQSxNQUFNQSxHQUFHQSxJQUFJQSxDQUFDQSxrQkFBa0JBLEdBQUdBLE1BQU1BLEdBQUdBLElBQUlBLEdBQUdBLE1BQU1BLEVBQUVBLGtCQUFrQkE7WUFDekdBLENBQUNBLEdBRHFGQTtZQUNwRkEsSUFBSUEsQ0FBQ0EsQ0FBQ0E7Z0JBQ1BBLElBQUlBLElBQUlBLE1BQU1BLEdBQUdBLEtBQUtBLEdBQUdBLE9BQU9BLEdBQUdBLElBQUlBLENBQUNBLGtCQUFrQkEsR0FBR0EsT0FBT0EsR0FBR0EsT0FBT0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsR0FBR0EsSUFBSUEsR0FDdkZBLElBQUlBLENBQUNBLFNBQVNBLENBQUNBLEtBQUtBLEVBQUVBLFlBQVlBLEVBQUVBLGNBQWNBLEVBQUVBLGNBQWNBLEVBQUVBLFFBQVFBLENBQUNBLENBQUNBO1lBQ2hGQSxDQUFDQTtRQUNGQSxDQUFDQTtRQUVEQSxRQUFRQSxDQUFDQSx1QkFBdUJBLENBQUNBLEtBQUtBLENBQUNBLENBQUNBO1FBRXhDQSxJQUFJQSxJQUFJQSxNQUFNQSxHQUFHQSxjQUFjQSxHQUFHQSxNQUFNQSxHQUFHQSxjQUFjQSxHQUFHQSxNQUFNQSxHQUFHQSxPQUFPQSxHQUFHQSxNQUFNQSxFQUFFQSxVQUFVQTtRQUVqR0EsTUFBTUEsQ0FBQ0EsSUFBSUEsQ0FBQ0E7SUFDYkEsQ0FBQ0E7SUFDRlYsdUJBQUNBO0FBQURBLENBdE1BLEFBc01DQSxFQXRNOEIsZ0JBQWdCLEVBc005QztBQUVELEFBQTBCLGlCQUFqQixnQkFBZ0IsQ0FBQyIsImZpbGUiOiJtZXRob2RzL1NoYWRvd1NvZnRNZXRob2QuanMiLCJzb3VyY2VSb290IjoiLi4vIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IFBvaXNzb25Mb29rdXBcdFx0XHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLWNvcmUvbGliL2dlb20vUG9pc3Nvbkxvb2t1cFwiKTtcclxuXHJcbmltcG9ydCBEaXJlY3Rpb25hbExpZ2h0XHRcdFx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1kaXNwbGF5L2xpYi9lbnRpdGllcy9EaXJlY3Rpb25hbExpZ2h0XCIpO1xyXG5cclxuaW1wb3J0IFN0YWdlXHRcdFx0XHRcdFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtc3RhZ2VnbC9saWIvYmFzZS9TdGFnZVwiKTtcclxuXHJcbmltcG9ydCBTaGFkZXJPYmplY3RCYXNlXHRcdFx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1yZW5kZXJlcmdsL2xpYi9jb21waWxhdGlvbi9TaGFkZXJPYmplY3RCYXNlXCIpO1xyXG5pbXBvcnQgU2hhZGVyUmVnaXN0ZXJDYWNoZVx0XHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLXJlbmRlcmVyZ2wvbGliL2NvbXBpbGF0aW9uL1NoYWRlclJlZ2lzdGVyQ2FjaGVcIik7XHJcbmltcG9ydCBTaGFkZXJSZWdpc3RlckRhdGFcdFx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1yZW5kZXJlcmdsL2xpYi9jb21waWxhdGlvbi9TaGFkZXJSZWdpc3RlckRhdGFcIik7XHJcbmltcG9ydCBTaGFkZXJSZWdpc3RlckVsZW1lbnRcdFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtcmVuZGVyZXJnbC9saWIvY29tcGlsYXRpb24vU2hhZGVyUmVnaXN0ZXJFbGVtZW50XCIpO1xyXG5cclxuaW1wb3J0IE1ldGhvZFZPXHRcdFx0XHRcdFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtbWV0aG9kbWF0ZXJpYWxzL2xpYi9kYXRhL01ldGhvZFZPXCIpO1xyXG5pbXBvcnQgU2hhZG93TWV0aG9kQmFzZVx0XHRcdFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtbWV0aG9kbWF0ZXJpYWxzL2xpYi9tZXRob2RzL1NoYWRvd01ldGhvZEJhc2VcIik7XHJcblxyXG4vKipcclxuICogU2hhZG93U29mdE1ldGhvZCBwcm92aWRlcyBhIHNvZnQgc2hhZG93aW5nIHRlY2huaXF1ZSBieSByYW5kb21seSBkaXN0cmlidXRpbmcgc2FtcGxlIHBvaW50cy5cclxuICovXHJcbmNsYXNzIFNoYWRvd1NvZnRNZXRob2QgZXh0ZW5kcyBTaGFkb3dNZXRob2RCYXNlXHJcbntcclxuXHRwcml2YXRlIF9yYW5nZTpudW1iZXIgPSAxO1xyXG5cdHByaXZhdGUgX251bVNhbXBsZXM6bnVtYmVyIC8qaW50Ki87XHJcblx0cHJpdmF0ZSBfb2Zmc2V0czpBcnJheTxudW1iZXI+O1xyXG5cclxuXHQvKipcclxuXHQgKiBDcmVhdGVzIGEgbmV3IERpZmZ1c2VCYXNpY01ldGhvZCBvYmplY3QuXHJcblx0ICpcclxuXHQgKiBAcGFyYW0gY2FzdGluZ0xpZ2h0IFRoZSBsaWdodCBjYXN0aW5nIHRoZSBzaGFkb3dzXHJcblx0ICogQHBhcmFtIG51bVNhbXBsZXMgVGhlIGFtb3VudCBvZiBzYW1wbGVzIHRvIHRha2UgZm9yIGRpdGhlcmluZy4gTWluaW11bSAxLCBtYXhpbXVtIDMyLlxyXG5cdCAqL1xyXG5cdGNvbnN0cnVjdG9yKGNhc3RpbmdMaWdodDpEaXJlY3Rpb25hbExpZ2h0LCBudW1TYW1wbGVzOm51bWJlciAvKmludCovID0gNSwgcmFuZ2U6bnVtYmVyID0gMSlcclxuXHR7XHJcblx0XHRzdXBlcihjYXN0aW5nTGlnaHQpO1xyXG5cclxuXHRcdHRoaXMubnVtU2FtcGxlcyA9IG51bVNhbXBsZXM7XHJcblx0XHR0aGlzLnJhbmdlID0gcmFuZ2U7XHJcblx0fVxyXG5cclxuXHQvKipcclxuXHQgKiBUaGUgYW1vdW50IG9mIHNhbXBsZXMgdG8gdGFrZSBmb3IgZGl0aGVyaW5nLiBNaW5pbXVtIDEsIG1heGltdW0gMzIuIFRoZSBhY3R1YWwgbWF4aW11bSBtYXkgZGVwZW5kIG9uIHRoZVxyXG5cdCAqIGNvbXBsZXhpdHkgb2YgdGhlIHNoYWRlci5cclxuXHQgKi9cclxuXHRwdWJsaWMgZ2V0IG51bVNhbXBsZXMoKTpudW1iZXIgLyppbnQqL1xyXG5cdHtcclxuXHRcdHJldHVybiB0aGlzLl9udW1TYW1wbGVzO1xyXG5cdH1cclxuXHJcblx0cHVibGljIHNldCBudW1TYW1wbGVzKHZhbHVlOm51bWJlciAvKmludCovKVxyXG5cdHtcclxuXHRcdHRoaXMuX251bVNhbXBsZXMgPSB2YWx1ZTtcclxuXHRcdFxyXG5cdFx0aWYgKHRoaXMuX251bVNhbXBsZXMgPCAxKVxyXG5cdFx0XHR0aGlzLl9udW1TYW1wbGVzID0gMTtcclxuXHRcdGVsc2UgaWYgKHRoaXMuX251bVNhbXBsZXMgPiAzMilcclxuXHRcdFx0dGhpcy5fbnVtU2FtcGxlcyA9IDMyO1xyXG5cclxuXHRcdHRoaXMuX29mZnNldHMgPSBQb2lzc29uTG9va3VwLmdldERpc3RyaWJ1dGlvbih0aGlzLl9udW1TYW1wbGVzKTtcclxuXHRcdFxyXG5cdFx0dGhpcy5pSW52YWxpZGF0ZVNoYWRlclByb2dyYW0oKTtcclxuXHR9XHJcblxyXG5cdC8qKlxyXG5cdCAqIFRoZSByYW5nZSBpbiB0aGUgc2hhZG93IG1hcCBpbiB3aGljaCB0byBkaXN0cmlidXRlIHRoZSBzYW1wbGVzLlxyXG5cdCAqL1xyXG5cdHB1YmxpYyBnZXQgcmFuZ2UoKTpudW1iZXJcclxuXHR7XHJcblx0XHRyZXR1cm4gdGhpcy5fcmFuZ2U7XHJcblx0fVxyXG5cclxuXHRwdWJsaWMgc2V0IHJhbmdlKHZhbHVlOm51bWJlcilcclxuXHR7XHJcblx0XHR0aGlzLl9yYW5nZSA9IHZhbHVlO1xyXG5cdH1cclxuXHJcblx0LyoqXHJcblx0ICogQGluaGVyaXREb2NcclxuXHQgKi9cclxuXHRwdWJsaWMgaUluaXRDb25zdGFudHMoc2hhZGVyT2JqZWN0OlNoYWRlck9iamVjdEJhc2UsIG1ldGhvZFZPOk1ldGhvZFZPKVxyXG5cdHtcclxuXHRcdHN1cGVyLmlJbml0Q29uc3RhbnRzKHNoYWRlck9iamVjdCwgbWV0aG9kVk8pO1xyXG5cclxuXHRcdHNoYWRlck9iamVjdC5mcmFnbWVudENvbnN0YW50RGF0YVttZXRob2RWTy5mcmFnbWVudENvbnN0YW50c0luZGV4ICsgOF0gPSAxL3RoaXMuX251bVNhbXBsZXM7XHJcblx0XHRzaGFkZXJPYmplY3QuZnJhZ21lbnRDb25zdGFudERhdGFbbWV0aG9kVk8uZnJhZ21lbnRDb25zdGFudHNJbmRleCArIDldID0gMDtcclxuXHR9XHJcblxyXG5cdC8qKlxyXG5cdCAqIEBpbmhlcml0RG9jXHJcblx0ICovXHJcblx0cHVibGljIGlBY3RpdmF0ZShzaGFkZXJPYmplY3Q6U2hhZGVyT2JqZWN0QmFzZSwgbWV0aG9kVk86TWV0aG9kVk8sIHN0YWdlOlN0YWdlKVxyXG5cdHtcclxuXHRcdHN1cGVyLmlBY3RpdmF0ZShzaGFkZXJPYmplY3QsIG1ldGhvZFZPLCBzdGFnZSk7XHJcblxyXG5cdFx0dmFyIHRleFJhbmdlOm51bWJlciA9IC41KnRoaXMuX3JhbmdlL3RoaXMuX3BDYXN0aW5nTGlnaHQuc2hhZG93TWFwcGVyLmRlcHRoTWFwU2l6ZTtcclxuXHRcdHZhciBkYXRhOkFycmF5PG51bWJlcj4gPSBzaGFkZXJPYmplY3QuZnJhZ21lbnRDb25zdGFudERhdGE7XHJcblx0XHR2YXIgaW5kZXg6bnVtYmVyIC8qdWludCovID0gbWV0aG9kVk8uZnJhZ21lbnRDb25zdGFudHNJbmRleCArIDEwO1xyXG5cdFx0dmFyIGxlbjpudW1iZXIgLyp1aW50Ki8gPSB0aGlzLl9udW1TYW1wbGVzIDw8IDE7XHJcblxyXG5cdFx0Zm9yICh2YXIgaTpudW1iZXIgLyppbnQqLyA9IDA7IGkgPCBsZW47ICsraSlcclxuXHRcdFx0ZGF0YVtpbmRleCArIGldID0gdGhpcy5fb2Zmc2V0c1tpXSp0ZXhSYW5nZTtcclxuXHR9XHJcblxyXG5cdC8qKlxyXG5cdCAqIEBpbmhlcml0RG9jXHJcblx0ICovXHJcblx0cHVibGljIF9wR2V0UGxhbmFyRnJhZ21lbnRDb2RlKG1ldGhvZFZPOk1ldGhvZFZPLCB0YXJnZXRSZWc6U2hhZGVyUmVnaXN0ZXJFbGVtZW50LCByZWdDYWNoZTpTaGFkZXJSZWdpc3RlckNhY2hlLCBzaGFyZWRSZWdpc3RlcnM6U2hhZGVyUmVnaXN0ZXJEYXRhKTpzdHJpbmdcclxuXHR7XHJcblx0XHQvLyB0b2RvOiBtb3ZlIHNvbWUgdGhpbmdzIHRvIHN1cGVyXHJcblx0XHR2YXIgZGVwdGhNYXBSZWdpc3RlcjpTaGFkZXJSZWdpc3RlckVsZW1lbnQgPSByZWdDYWNoZS5nZXRGcmVlVGV4dHVyZVJlZygpO1xyXG5cdFx0dmFyIGRlY1JlZzpTaGFkZXJSZWdpc3RlckVsZW1lbnQgPSByZWdDYWNoZS5nZXRGcmVlRnJhZ21lbnRDb25zdGFudCgpO1xyXG5cdFx0dmFyIGRhdGFSZWc6U2hhZGVyUmVnaXN0ZXJFbGVtZW50ID0gcmVnQ2FjaGUuZ2V0RnJlZUZyYWdtZW50Q29uc3RhbnQoKTtcclxuXHRcdHZhciBjdXN0b21EYXRhUmVnOlNoYWRlclJlZ2lzdGVyRWxlbWVudCA9IHJlZ0NhY2hlLmdldEZyZWVGcmFnbWVudENvbnN0YW50KCk7XHJcblxyXG5cdFx0bWV0aG9kVk8uZnJhZ21lbnRDb25zdGFudHNJbmRleCA9IGRlY1JlZy5pbmRleCo0O1xyXG5cdFx0bWV0aG9kVk8udGV4dHVyZXNJbmRleCA9IGRlcHRoTWFwUmVnaXN0ZXIuaW5kZXg7XHJcblxyXG5cdFx0cmV0dXJuIHRoaXMuZ2V0U2FtcGxlQ29kZShyZWdDYWNoZSwgZGVwdGhNYXBSZWdpc3RlciwgZGVjUmVnLCB0YXJnZXRSZWcsIGN1c3RvbURhdGFSZWcpO1xyXG5cdH1cclxuXHJcblx0LyoqXHJcblx0ICogQWRkcyB0aGUgY29kZSBmb3IgYW5vdGhlciB0YXAgdG8gdGhlIHNoYWRlciBjb2RlLlxyXG5cdCAqIEBwYXJhbSB1diBUaGUgdXYgcmVnaXN0ZXIgZm9yIHRoZSB0YXAuXHJcblx0ICogQHBhcmFtIHRleHR1cmUgVGhlIHRleHR1cmUgcmVnaXN0ZXIgY29udGFpbmluZyB0aGUgZGVwdGggbWFwLlxyXG5cdCAqIEBwYXJhbSBkZWNvZGUgVGhlIHJlZ2lzdGVyIGNvbnRhaW5pbmcgdGhlIGRlcHRoIG1hcCBkZWNvZGluZyBkYXRhLlxyXG5cdCAqIEBwYXJhbSB0YXJnZXQgVGhlIHRhcmdldCByZWdpc3RlciB0byBhZGQgdGhlIHRhcCBjb21wYXJpc29uIHJlc3VsdC5cclxuXHQgKiBAcGFyYW0gcmVnQ2FjaGUgVGhlIHJlZ2lzdGVyIGNhY2hlIG1hbmFnaW5nIHRoZSByZWdpc3RlcnMuXHJcblx0ICogQHJldHVyblxyXG5cdCAqL1xyXG5cdHByaXZhdGUgYWRkU2FtcGxlKHV2OlNoYWRlclJlZ2lzdGVyRWxlbWVudCwgdGV4dHVyZTpTaGFkZXJSZWdpc3RlckVsZW1lbnQsIGRlY29kZTpTaGFkZXJSZWdpc3RlckVsZW1lbnQsIHRhcmdldDpTaGFkZXJSZWdpc3RlckVsZW1lbnQsIHJlZ0NhY2hlOlNoYWRlclJlZ2lzdGVyQ2FjaGUpOnN0cmluZ1xyXG5cdHtcclxuXHRcdHZhciB0ZW1wOlNoYWRlclJlZ2lzdGVyRWxlbWVudCA9IHJlZ0NhY2hlLmdldEZyZWVGcmFnbWVudFZlY3RvclRlbXAoKTtcclxuXHRcdHJldHVybiBcInRleCBcIiArIHRlbXAgKyBcIiwgXCIgKyB1diArIFwiLCBcIiArIHRleHR1cmUgKyBcIiA8MmQsbmVhcmVzdCxjbGFtcD5cXG5cIiArXHJcblx0XHRcdFwiZHA0IFwiICsgdGVtcCArIFwiLnosIFwiICsgdGVtcCArIFwiLCBcIiArIGRlY29kZSArIFwiXFxuXCIgK1xyXG5cdFx0XHRcInNsdCBcIiArIHV2ICsgXCIudywgXCIgKyB0aGlzLl9wRGVwdGhNYXBDb29yZFJlZyArIFwiLnosIFwiICsgdGVtcCArIFwiLnpcXG5cIiArIC8vIDAgaWYgaW4gc2hhZG93XHJcblx0XHRcdFwiYWRkIFwiICsgdGFyZ2V0ICsgXCIudywgXCIgKyB0YXJnZXQgKyBcIi53LCBcIiArIHV2ICsgXCIud1xcblwiO1xyXG5cdH1cclxuXHJcblx0LyoqXHJcblx0ICogQGluaGVyaXREb2NcclxuXHQgKi9cclxuXHRwdWJsaWMgaUFjdGl2YXRlRm9yQ2FzY2FkZShzaGFkZXJPYmplY3Q6U2hhZGVyT2JqZWN0QmFzZSwgbWV0aG9kVk86TWV0aG9kVk8sIHN0YWdlOlN0YWdlKVxyXG5cdHtcclxuXHRcdHN1cGVyLmlBY3RpdmF0ZShzaGFkZXJPYmplY3QsIG1ldGhvZFZPLCBzdGFnZSk7XHJcblxyXG5cdFx0dmFyIHRleFJhbmdlOm51bWJlciA9IHRoaXMuX3JhbmdlL3RoaXMuX3BDYXN0aW5nTGlnaHQuc2hhZG93TWFwcGVyLmRlcHRoTWFwU2l6ZTtcclxuXHRcdHZhciBkYXRhOkFycmF5PG51bWJlcj4gPSBzaGFkZXJPYmplY3QuZnJhZ21lbnRDb25zdGFudERhdGE7XHJcblx0XHR2YXIgaW5kZXg6bnVtYmVyIC8qdWludCovID0gbWV0aG9kVk8uc2Vjb25kYXJ5RnJhZ21lbnRDb25zdGFudHNJbmRleDtcclxuXHRcdHZhciBsZW46bnVtYmVyIC8qdWludCovID0gdGhpcy5fbnVtU2FtcGxlcyA8PCAxO1xyXG5cdFx0ZGF0YVtpbmRleF0gPSAxL3RoaXMuX251bVNhbXBsZXM7XHJcblx0XHRkYXRhW2luZGV4ICsgMV0gPSAwO1xyXG5cdFx0aW5kZXggKz0gMjtcclxuXHJcblx0XHRmb3IgKHZhciBpOm51bWJlciAvKmludCovID0gMDsgaSA8IGxlbjsgKytpKVxyXG5cdFx0XHRkYXRhW2luZGV4ICsgaV0gPSB0aGlzLl9vZmZzZXRzW2ldKnRleFJhbmdlO1xyXG5cclxuXHRcdGlmIChsZW4lNCA9PSAwKSB7XHJcblx0XHRcdGRhdGFbaW5kZXggKyBsZW5dID0gMDtcclxuXHRcdFx0ZGF0YVtpbmRleCArIGxlbiArIDFdID0gMDtcclxuXHRcdH1cclxuXHR9XHJcblxyXG5cdC8qKlxyXG5cdCAqIEBpbmhlcml0RG9jXHJcblx0ICovXHJcblx0cHVibGljIF9pR2V0Q2FzY2FkZUZyYWdtZW50Q29kZShzaGFkZXJPYmplY3Q6U2hhZGVyT2JqZWN0QmFzZSwgbWV0aG9kVk86TWV0aG9kVk8sIGRlY29kZVJlZ2lzdGVyOlNoYWRlclJlZ2lzdGVyRWxlbWVudCwgZGVwdGhUZXh0dXJlOlNoYWRlclJlZ2lzdGVyRWxlbWVudCwgZGVwdGhQcm9qZWN0aW9uOlNoYWRlclJlZ2lzdGVyRWxlbWVudCwgdGFyZ2V0UmVnaXN0ZXI6U2hhZGVyUmVnaXN0ZXJFbGVtZW50LCByZWdpc3RlckNhY2hlOlNoYWRlclJlZ2lzdGVyQ2FjaGUsIHNoYXJlZFJlZ2lzdGVyczpTaGFkZXJSZWdpc3RlckRhdGEpOnN0cmluZ1xyXG5cdHtcclxuXHRcdHRoaXMuX3BEZXB0aE1hcENvb3JkUmVnID0gZGVwdGhQcm9qZWN0aW9uO1xyXG5cclxuXHRcdHZhciBkYXRhUmVnOlNoYWRlclJlZ2lzdGVyRWxlbWVudCA9IHJlZ2lzdGVyQ2FjaGUuZ2V0RnJlZUZyYWdtZW50Q29uc3RhbnQoKTtcclxuXHRcdG1ldGhvZFZPLnNlY29uZGFyeUZyYWdtZW50Q29uc3RhbnRzSW5kZXggPSBkYXRhUmVnLmluZGV4KjQ7XHJcblxyXG5cdFx0cmV0dXJuIHRoaXMuZ2V0U2FtcGxlQ29kZShyZWdpc3RlckNhY2hlLCBkZXB0aFRleHR1cmUsIGRlY29kZVJlZ2lzdGVyLCB0YXJnZXRSZWdpc3RlciwgZGF0YVJlZyk7XHJcblx0fVxyXG5cclxuXHQvKipcclxuXHQgKiBHZXQgdGhlIGFjdHVhbCBzaGFkZXIgY29kZSBmb3Igc2hhZG93IG1hcHBpbmdcclxuXHQgKiBAcGFyYW0gcmVnQ2FjaGUgVGhlIHJlZ2lzdGVyIGNhY2hlIG1hbmFnaW5nIHRoZSByZWdpc3RlcnMuXHJcblx0ICogQHBhcmFtIGRlcHRoVGV4dHVyZSBUaGUgdGV4dHVyZSByZWdpc3RlciBjb250YWluaW5nIHRoZSBkZXB0aCBtYXAuXHJcblx0ICogQHBhcmFtIGRlY29kZVJlZ2lzdGVyIFRoZSByZWdpc3RlciBjb250YWluaW5nIHRoZSBkZXB0aCBtYXAgZGVjb2RpbmcgZGF0YS5cclxuXHQgKiBAcGFyYW0gdGFyZ2V0UmVnIFRoZSB0YXJnZXQgcmVnaXN0ZXIgdG8gYWRkIHRoZSBzaGFkb3cgY292ZXJhZ2UuXHJcblx0ICogQHBhcmFtIGRhdGFSZWcgVGhlIHJlZ2lzdGVyIGNvbnRhaW5pbmcgYWRkaXRpb25hbCBkYXRhLlxyXG5cdCAqL1xyXG5cdHByaXZhdGUgZ2V0U2FtcGxlQ29kZShyZWdDYWNoZTpTaGFkZXJSZWdpc3RlckNhY2hlLCBkZXB0aFRleHR1cmU6U2hhZGVyUmVnaXN0ZXJFbGVtZW50LCBkZWNvZGVSZWdpc3RlcjpTaGFkZXJSZWdpc3RlckVsZW1lbnQsIHRhcmdldFJlZ2lzdGVyOlNoYWRlclJlZ2lzdGVyRWxlbWVudCwgZGF0YVJlZzpTaGFkZXJSZWdpc3RlckVsZW1lbnQpOnN0cmluZ1xyXG5cdHtcclxuXHRcdHZhciB1dlJlZzpTaGFkZXJSZWdpc3RlckVsZW1lbnQ7XHJcblx0XHR2YXIgY29kZTpzdHJpbmc7XHJcblx0XHR2YXIgb2Zmc2V0czpBcnJheTxzdHJpbmc+ID0gbmV3IEFycmF5PHN0cmluZz4oZGF0YVJlZyArIFwiLnp3XCIpO1xyXG5cdFx0dXZSZWcgPSByZWdDYWNoZS5nZXRGcmVlRnJhZ21lbnRWZWN0b3JUZW1wKCk7XHJcblx0XHRyZWdDYWNoZS5hZGRGcmFnbWVudFRlbXBVc2FnZXModXZSZWcsIDEpO1xyXG5cclxuXHRcdHZhciB0ZW1wOlNoYWRlclJlZ2lzdGVyRWxlbWVudCA9IHJlZ0NhY2hlLmdldEZyZWVGcmFnbWVudFZlY3RvclRlbXAoKTtcclxuXHJcblx0XHR2YXIgbnVtUmVnczpudW1iZXIgLyppbnQqLyA9IHRoaXMuX251bVNhbXBsZXMgPj4gMTtcclxuXHRcdGZvciAodmFyIGk6bnVtYmVyIC8qaW50Ki8gPSAwOyBpIDwgbnVtUmVnczsgKytpKSB7XHJcblx0XHRcdHZhciByZWc6U2hhZGVyUmVnaXN0ZXJFbGVtZW50ID0gcmVnQ2FjaGUuZ2V0RnJlZUZyYWdtZW50Q29uc3RhbnQoKTtcclxuXHRcdFx0b2Zmc2V0cy5wdXNoKHJlZyArIFwiLnh5XCIpO1xyXG5cdFx0XHRvZmZzZXRzLnB1c2gocmVnICsgXCIuendcIik7XHJcblx0XHR9XHJcblxyXG5cdFx0Zm9yIChpID0gMDsgaSA8IHRoaXMuX251bVNhbXBsZXM7ICsraSkge1xyXG5cdFx0XHRpZiAoaSA9PSAwKSB7XHJcblx0XHRcdFx0Y29kZSA9IFwiYWRkIFwiICsgdXZSZWcgKyBcIiwgXCIgKyB0aGlzLl9wRGVwdGhNYXBDb29yZFJlZyArIFwiLCBcIiArIGRhdGFSZWcgKyBcIi56d3l5XFxuXCIgK1xyXG5cdFx0XHRcdFx0XCJ0ZXggXCIgKyB0ZW1wICsgXCIsIFwiICsgdXZSZWcgKyBcIiwgXCIgKyBkZXB0aFRleHR1cmUgKyBcIiA8MmQsbmVhcmVzdCxjbGFtcD5cXG5cIiArXHJcblx0XHRcdFx0XHRcImRwNCBcIiArIHRlbXAgKyBcIi56LCBcIiArIHRlbXAgKyBcIiwgXCIgKyBkZWNvZGVSZWdpc3RlciArIFwiXFxuXCIgK1xyXG5cdFx0XHRcdFx0XCJzbHQgXCIgKyB0YXJnZXRSZWdpc3RlciArIFwiLncsIFwiICsgdGhpcy5fcERlcHRoTWFwQ29vcmRSZWcgKyBcIi56LCBcIiArIHRlbXAgKyBcIi56XFxuXCI7IC8vIDAgaWYgaW4gc2hhZG93O1xyXG5cdFx0XHR9IGVsc2Uge1xyXG5cdFx0XHRcdGNvZGUgKz0gXCJhZGQgXCIgKyB1dlJlZyArIFwiLnh5LCBcIiArIHRoaXMuX3BEZXB0aE1hcENvb3JkUmVnICsgXCIueHksIFwiICsgb2Zmc2V0c1tpXSArIFwiXFxuXCIgK1xyXG5cdFx0XHRcdFx0dGhpcy5hZGRTYW1wbGUodXZSZWcsIGRlcHRoVGV4dHVyZSwgZGVjb2RlUmVnaXN0ZXIsIHRhcmdldFJlZ2lzdGVyLCByZWdDYWNoZSk7XHJcblx0XHRcdH1cclxuXHRcdH1cclxuXHJcblx0XHRyZWdDYWNoZS5yZW1vdmVGcmFnbWVudFRlbXBVc2FnZSh1dlJlZyk7XHJcblxyXG5cdFx0Y29kZSArPSBcIm11bCBcIiArIHRhcmdldFJlZ2lzdGVyICsgXCIudywgXCIgKyB0YXJnZXRSZWdpc3RlciArIFwiLncsIFwiICsgZGF0YVJlZyArIFwiLnhcXG5cIjsgLy8gYXZlcmFnZVxyXG5cclxuXHRcdHJldHVybiBjb2RlO1xyXG5cdH1cclxufVxyXG5cclxuZXhwb3J0ID0gU2hhZG93U29mdE1ldGhvZDsiXX0=