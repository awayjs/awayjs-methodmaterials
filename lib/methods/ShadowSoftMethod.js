var __extends = this.__extends || function (d, b) {
    for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p];
    function __() { this.constructor = d; }
    __.prototype = b.prototype;
    d.prototype = new __();
};
var PoissonLookup = require("awayjs-core/lib/geom/PoissonLookup");
var ShadowMethodBase = require("awayjs-methodmaterials/lib/methods/ShadowMethodBase");
/**
 * ShadowSoftMethod provides a soft shadowing technique by randomly distributing sample points.
 */
var ShadowSoftMethod = (function (_super) {
    __extends(ShadowSoftMethod, _super);
    /**
     * Creates a new DiffuseBasicMethod object.
     *
     * @param castingLight The light casting the shadows
     * @param numSamples The amount of samples to take for dithering. Minimum 1, maximum 32.
     */
    function ShadowSoftMethod(castingLight, numSamples, range) {
        if (numSamples === void 0) { numSamples = 5; }
        if (range === void 0) { range = 1; }
        _super.call(this, castingLight);
        this._range = 1;
        this.numSamples = numSamples;
        this.range = range;
    }
    Object.defineProperty(ShadowSoftMethod.prototype, "numSamples", {
        /**
         * The amount of samples to take for dithering. Minimum 1, maximum 32. The actual maximum may depend on the
         * complexity of the shader.
         */
        get: function () {
            return this._numSamples;
        },
        set: function (value /*int*/) {
            this._numSamples = value;
            if (this._numSamples < 1)
                this._numSamples = 1;
            else if (this._numSamples > 32)
                this._numSamples = 32;
            this._offsets = PoissonLookup.getDistribution(this._numSamples);
            this.iInvalidateShaderProgram();
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(ShadowSoftMethod.prototype, "range", {
        /**
         * The range in the shadow map in which to distribute the samples.
         */
        get: function () {
            return this._range;
        },
        set: function (value) {
            this._range = value;
        },
        enumerable: true,
        configurable: true
    });
    /**
     * @inheritDoc
     */
    ShadowSoftMethod.prototype.iInitConstants = function (shaderObject, methodVO) {
        _super.prototype.iInitConstants.call(this, shaderObject, methodVO);
        shaderObject.fragmentConstantData[methodVO.fragmentConstantsIndex + 8] = 1 / this._numSamples;
        shaderObject.fragmentConstantData[methodVO.fragmentConstantsIndex + 9] = 0;
    };
    /**
     * @inheritDoc
     */
    ShadowSoftMethod.prototype.iActivate = function (shaderObject, methodVO, stage) {
        _super.prototype.iActivate.call(this, shaderObject, methodVO, stage);
        var texRange = .5 * this._range / this._pCastingLight.shadowMapper.depthMapSize;
        var data = shaderObject.fragmentConstantData;
        var index = methodVO.fragmentConstantsIndex + 10;
        var len = this._numSamples << 1;
        for (var i = 0; i < len; ++i)
            data[index + i] = this._offsets[i] * texRange;
    };
    /**
     * @inheritDoc
     */
    ShadowSoftMethod.prototype._pGetPlanarFragmentCode = function (methodVO, targetReg, regCache, sharedRegisters) {
        // todo: move some things to super
        var depthMapRegister = regCache.getFreeTextureReg();
        var decReg = regCache.getFreeFragmentConstant();
        var dataReg = regCache.getFreeFragmentConstant();
        var customDataReg = regCache.getFreeFragmentConstant();
        methodVO.fragmentConstantsIndex = decReg.index * 4;
        methodVO.texturesIndex = depthMapRegister.index;
        return this.getSampleCode(regCache, depthMapRegister, decReg, targetReg, customDataReg);
    };
    /**
     * Adds the code for another tap to the shader code.
     * @param uv The uv register for the tap.
     * @param texture The texture register containing the depth map.
     * @param decode The register containing the depth map decoding data.
     * @param target The target register to add the tap comparison result.
     * @param regCache The register cache managing the registers.
     * @return
     */
    ShadowSoftMethod.prototype.addSample = function (uv, texture, decode, target, regCache) {
        var temp = regCache.getFreeFragmentVectorTemp();
        return "tex " + temp + ", " + uv + ", " + texture + " <2d,nearest,clamp>\n" + "dp4 " + temp + ".z, " + temp + ", " + decode + "\n" + "slt " + uv + ".w, " + this._pDepthMapCoordReg + ".z, " + temp + ".z\n" + "add " + target + ".w, " + target + ".w, " + uv + ".w\n";
    };
    /**
     * @inheritDoc
     */
    ShadowSoftMethod.prototype.iActivateForCascade = function (shaderObject, methodVO, stage) {
        _super.prototype.iActivate.call(this, shaderObject, methodVO, stage);
        var texRange = this._range / this._pCastingLight.shadowMapper.depthMapSize;
        var data = shaderObject.fragmentConstantData;
        var index = methodVO.secondaryFragmentConstantsIndex;
        var len = this._numSamples << 1;
        data[index] = 1 / this._numSamples;
        data[index + 1] = 0;
        index += 2;
        for (var i = 0; i < len; ++i)
            data[index + i] = this._offsets[i] * texRange;
        if (len % 4 == 0) {
            data[index + len] = 0;
            data[index + len + 1] = 0;
        }
    };
    /**
     * @inheritDoc
     */
    ShadowSoftMethod.prototype._iGetCascadeFragmentCode = function (shaderObject, methodVO, decodeRegister, depthTexture, depthProjection, targetRegister, registerCache, sharedRegisters) {
        this._pDepthMapCoordReg = depthProjection;
        var dataReg = registerCache.getFreeFragmentConstant();
        methodVO.secondaryFragmentConstantsIndex = dataReg.index * 4;
        return this.getSampleCode(registerCache, depthTexture, decodeRegister, targetRegister, dataReg);
    };
    /**
     * Get the actual shader code for shadow mapping
     * @param regCache The register cache managing the registers.
     * @param depthTexture The texture register containing the depth map.
     * @param decodeRegister The register containing the depth map decoding data.
     * @param targetReg The target register to add the shadow coverage.
     * @param dataReg The register containing additional data.
     */
    ShadowSoftMethod.prototype.getSampleCode = function (regCache, depthTexture, decodeRegister, targetRegister, dataReg) {
        var uvReg;
        var code;
        var offsets = new Array(dataReg + ".zw");
        uvReg = regCache.getFreeFragmentVectorTemp();
        regCache.addFragmentTempUsages(uvReg, 1);
        var temp = regCache.getFreeFragmentVectorTemp();
        var numRegs = this._numSamples >> 1;
        for (var i = 0; i < numRegs; ++i) {
            var reg = regCache.getFreeFragmentConstant();
            offsets.push(reg + ".xy");
            offsets.push(reg + ".zw");
        }
        for (i = 0; i < this._numSamples; ++i) {
            if (i == 0) {
                code = "add " + uvReg + ", " + this._pDepthMapCoordReg + ", " + dataReg + ".zwyy\n" + "tex " + temp + ", " + uvReg + ", " + depthTexture + " <2d,nearest,clamp>\n" + "dp4 " + temp + ".z, " + temp + ", " + decodeRegister + "\n" + "slt " + targetRegister + ".w, " + this._pDepthMapCoordReg + ".z, " + temp + ".z\n"; // 0 if in shadow;
            }
            else {
                code += "add " + uvReg + ".xy, " + this._pDepthMapCoordReg + ".xy, " + offsets[i] + "\n" + this.addSample(uvReg, depthTexture, decodeRegister, targetRegister, regCache);
            }
        }
        regCache.removeFragmentTempUsage(uvReg);
        code += "mul " + targetRegister + ".w, " + targetRegister + ".w, " + dataReg + ".x\n"; // average
        return code;
    };
    return ShadowSoftMethod;
})(ShadowMethodBase);
module.exports = ShadowSoftMethod;

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImF3YXlqcy1tZXRob2RtYXRlcmlhbHMvbGliL21ldGhvZHMvU2hhZG93U29mdE1ldGhvZC50cyJdLCJuYW1lcyI6WyJTaGFkb3dTb2Z0TWV0aG9kIiwiU2hhZG93U29mdE1ldGhvZC5jb25zdHJ1Y3RvciIsIlNoYWRvd1NvZnRNZXRob2QubnVtU2FtcGxlcyIsIlNoYWRvd1NvZnRNZXRob2QucmFuZ2UiLCJTaGFkb3dTb2Z0TWV0aG9kLmlJbml0Q29uc3RhbnRzIiwiU2hhZG93U29mdE1ldGhvZC5pQWN0aXZhdGUiLCJTaGFkb3dTb2Z0TWV0aG9kLl9wR2V0UGxhbmFyRnJhZ21lbnRDb2RlIiwiU2hhZG93U29mdE1ldGhvZC5hZGRTYW1wbGUiLCJTaGFkb3dTb2Z0TWV0aG9kLmlBY3RpdmF0ZUZvckNhc2NhZGUiLCJTaGFkb3dTb2Z0TWV0aG9kLl9pR2V0Q2FzY2FkZUZyYWdtZW50Q29kZSIsIlNoYWRvd1NvZnRNZXRob2QuZ2V0U2FtcGxlQ29kZSJdLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBQUEsSUFBTyxhQUFhLFdBQWUsb0NBQW9DLENBQUMsQ0FBQztBQVl6RSxJQUFPLGdCQUFnQixXQUFlLHFEQUFxRCxDQUFDLENBQUM7QUFFN0YsQUFHQTs7R0FERztJQUNHLGdCQUFnQjtJQUFTQSxVQUF6QkEsZ0JBQWdCQSxVQUF5QkE7SUFNOUNBOzs7OztPQUtHQTtJQUNIQSxTQVpLQSxnQkFBZ0JBLENBWVRBLFlBQTZCQSxFQUFFQSxVQUE2QkEsRUFBRUEsS0FBZ0JBO1FBQS9DQywwQkFBNkJBLEdBQTdCQSxjQUE2QkE7UUFBRUEscUJBQWdCQSxHQUFoQkEsU0FBZ0JBO1FBRXpGQSxrQkFBTUEsWUFBWUEsQ0FBQ0EsQ0FBQ0E7UUFaYkEsV0FBTUEsR0FBVUEsQ0FBQ0EsQ0FBQ0E7UUFjekJBLElBQUlBLENBQUNBLFVBQVVBLEdBQUdBLFVBQVVBLENBQUNBO1FBQzdCQSxJQUFJQSxDQUFDQSxLQUFLQSxHQUFHQSxLQUFLQSxDQUFDQTtJQUNwQkEsQ0FBQ0E7SUFNREQs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LHVCQUF1QkEsR0FDNUVBLE1BQU1BLEdBQUdBLElBQUlBLEdBQUdBLE1BQU1BLEdBQUdBLElBQUlBLEdBQUdBLElBQUlBLEdBQUdBLGNBQWNBLEdBQUdBLElBQUlBLEdBQzVEQSxNQUFNQSxHQUFHQSxjQUFjQSxHQUFHQSxNQUFNQSxHQUFHQSxJQUFJQSxDQUFDQSxrQkFBa0JBLEdBQUdBLE1BQU1BLEdBQUdBLElBQUlBLEdBQUdBLE1BQU1BLEVBQUVBLGtCQUFrQkE7WUFDekdBLENBQUNBLEdBRHFGQTtZQUNwRkEsSUFBSUEsQ0FBQ0EsQ0FBQ0E7Z0JBQ1BBLElBQUlBLElBQUlBLE1BQU1BLEdBQUdBLEtBQUtBLEdBQUdBLE9BQU9BLEdBQUdBLElBQUlBLENBQUNBLGtCQUFrQkEsR0FBR0EsT0FBT0EsR0FBR0EsT0FBT0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsR0FBR0EsSUFBSUEsR0FDdkZBLElBQUlBLENBQUNBLFNBQVNBLENBQUNBLEtBQUtBLEVBQUVBLFlBQVlBLEVBQUVBLGNBQWNBLEVBQUVBLGNBQWNBLEVBQUVBLFFBQVFBLENBQUNBLENBQUNBO1lBQ2hGQSxDQUFDQTtRQUNGQSxDQUFDQTtRQUVEQSxRQUFRQSxDQUFDQSx1QkFBdUJBLENBQUNBLEtBQUtBLENBQUNBLENBQUNBO1FBRXhDQSxJQUFJQSxJQUFJQSxNQUFNQSxHQUFHQSxjQUFjQSxHQUFHQSxNQUFNQSxHQUFHQSxjQUFjQSxHQUFHQSxNQUFNQSxHQUFHQSxPQUFPQSxHQUFHQSxNQUFNQSxFQUFFQSxVQUFVQTtRQUVqR0EsTUFBTUEsQ0FBQ0EsSUFBSUEsQ0FBQ0E7SUFDYkEsQ0FBQ0E7SUFDRlYsdUJBQUNBO0FBQURBLENBdE1BLEFBc01DQSxFQXRNOEIsZ0JBQWdCLEVBc005QztBQUVELEFBQTBCLGlCQUFqQixnQkFBZ0IsQ0FBQyIsImZpbGUiOiJtZXRob2RzL1NoYWRvd1NvZnRNZXRob2QuanMiLCJzb3VyY2VSb290IjoiLi4vIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IFBvaXNzb25Mb29rdXBcdFx0XHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLWNvcmUvbGliL2dlb20vUG9pc3Nvbkxvb2t1cFwiKTtcblxuaW1wb3J0IERpcmVjdGlvbmFsTGlnaHRcdFx0XHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLWRpc3BsYXkvbGliL2VudGl0aWVzL0RpcmVjdGlvbmFsTGlnaHRcIik7XG5cbmltcG9ydCBTdGFnZVx0XHRcdFx0XHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLXN0YWdlZ2wvbGliL2Jhc2UvU3RhZ2VcIik7XG5cbmltcG9ydCBTaGFkZXJPYmplY3RCYXNlXHRcdFx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1yZW5kZXJlcmdsL2xpYi9jb21waWxhdGlvbi9TaGFkZXJPYmplY3RCYXNlXCIpO1xuaW1wb3J0IFNoYWRlclJlZ2lzdGVyQ2FjaGVcdFx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1yZW5kZXJlcmdsL2xpYi9jb21waWxhdGlvbi9TaGFkZXJSZWdpc3RlckNhY2hlXCIpO1xuaW1wb3J0IFNoYWRlclJlZ2lzdGVyRGF0YVx0XHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLXJlbmRlcmVyZ2wvbGliL2NvbXBpbGF0aW9uL1NoYWRlclJlZ2lzdGVyRGF0YVwiKTtcbmltcG9ydCBTaGFkZXJSZWdpc3RlckVsZW1lbnRcdFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtcmVuZGVyZXJnbC9saWIvY29tcGlsYXRpb24vU2hhZGVyUmVnaXN0ZXJFbGVtZW50XCIpO1xuXG5pbXBvcnQgTWV0aG9kVk9cdFx0XHRcdFx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1tZXRob2RtYXRlcmlhbHMvbGliL2RhdGEvTWV0aG9kVk9cIik7XG5pbXBvcnQgU2hhZG93TWV0aG9kQmFzZVx0XHRcdFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtbWV0aG9kbWF0ZXJpYWxzL2xpYi9tZXRob2RzL1NoYWRvd01ldGhvZEJhc2VcIik7XG5cbi8qKlxuICogU2hhZG93U29mdE1ldGhvZCBwcm92aWRlcyBhIHNvZnQgc2hhZG93aW5nIHRlY2huaXF1ZSBieSByYW5kb21seSBkaXN0cmlidXRpbmcgc2FtcGxlIHBvaW50cy5cbiAqL1xuY2xhc3MgU2hhZG93U29mdE1ldGhvZCBleHRlbmRzIFNoYWRvd01ldGhvZEJhc2Vcbntcblx0cHJpdmF0ZSBfcmFuZ2U6bnVtYmVyID0gMTtcblx0cHJpdmF0ZSBfbnVtU2FtcGxlczpudW1iZXIgLyppbnQqLztcblx0cHJpdmF0ZSBfb2Zmc2V0czpBcnJheTxudW1iZXI+O1xuXG5cdC8qKlxuXHQgKiBDcmVhdGVzIGEgbmV3IERpZmZ1c2VCYXNpY01ldGhvZCBvYmplY3QuXG5cdCAqXG5cdCAqIEBwYXJhbSBjYXN0aW5nTGlnaHQgVGhlIGxpZ2h0IGNhc3RpbmcgdGhlIHNoYWRvd3Ncblx0ICogQHBhcmFtIG51bVNhbXBsZXMgVGhlIGFtb3VudCBvZiBzYW1wbGVzIHRvIHRha2UgZm9yIGRpdGhlcmluZy4gTWluaW11bSAxLCBtYXhpbXVtIDMyLlxuXHQgKi9cblx0Y29uc3RydWN0b3IoY2FzdGluZ0xpZ2h0OkRpcmVjdGlvbmFsTGlnaHQsIG51bVNhbXBsZXM6bnVtYmVyIC8qaW50Ki8gPSA1LCByYW5nZTpudW1iZXIgPSAxKVxuXHR7XG5cdFx0c3VwZXIoY2FzdGluZ0xpZ2h0KTtcblxuXHRcdHRoaXMubnVtU2FtcGxlcyA9IG51bVNhbXBsZXM7XG5cdFx0dGhpcy5yYW5nZSA9IHJhbmdlO1xuXHR9XG5cblx0LyoqXG5cdCAqIFRoZSBhbW91bnQgb2Ygc2FtcGxlcyB0byB0YWtlIGZvciBkaXRoZXJpbmcuIE1pbmltdW0gMSwgbWF4aW11bSAzMi4gVGhlIGFjdHVhbCBtYXhpbXVtIG1heSBkZXBlbmQgb24gdGhlXG5cdCAqIGNvbXBsZXhpdHkgb2YgdGhlIHNoYWRlci5cblx0ICovXG5cdHB1YmxpYyBnZXQgbnVtU2FtcGxlcygpOm51bWJlciAvKmludCovXG5cdHtcblx0XHRyZXR1cm4gdGhpcy5fbnVtU2FtcGxlcztcblx0fVxuXG5cdHB1YmxpYyBzZXQgbnVtU2FtcGxlcyh2YWx1ZTpudW1iZXIgLyppbnQqLylcblx0e1xuXHRcdHRoaXMuX251bVNhbXBsZXMgPSB2YWx1ZTtcblx0XHRcblx0XHRpZiAodGhpcy5fbnVtU2FtcGxlcyA8IDEpXG5cdFx0XHR0aGlzLl9udW1TYW1wbGVzID0gMTtcblx0XHRlbHNlIGlmICh0aGlzLl9udW1TYW1wbGVzID4gMzIpXG5cdFx0XHR0aGlzLl9udW1TYW1wbGVzID0gMzI7XG5cblx0XHR0aGlzLl9vZmZzZXRzID0gUG9pc3Nvbkxvb2t1cC5nZXREaXN0cmlidXRpb24odGhpcy5fbnVtU2FtcGxlcyk7XG5cdFx0XG5cdFx0dGhpcy5pSW52YWxpZGF0ZVNoYWRlclByb2dyYW0oKTtcblx0fVxuXG5cdC8qKlxuXHQgKiBUaGUgcmFuZ2UgaW4gdGhlIHNoYWRvdyBtYXAgaW4gd2hpY2ggdG8gZGlzdHJpYnV0ZSB0aGUgc2FtcGxlcy5cblx0ICovXG5cdHB1YmxpYyBnZXQgcmFuZ2UoKTpudW1iZXJcblx0e1xuXHRcdHJldHVybiB0aGlzLl9yYW5nZTtcblx0fVxuXG5cdHB1YmxpYyBzZXQgcmFuZ2UodmFsdWU6bnVtYmVyKVxuXHR7XG5cdFx0dGhpcy5fcmFuZ2UgPSB2YWx1ZTtcblx0fVxuXG5cdC8qKlxuXHQgKiBAaW5oZXJpdERvY1xuXHQgKi9cblx0cHVibGljIGlJbml0Q29uc3RhbnRzKHNoYWRlck9iamVjdDpTaGFkZXJPYmplY3RCYXNlLCBtZXRob2RWTzpNZXRob2RWTylcblx0e1xuXHRcdHN1cGVyLmlJbml0Q29uc3RhbnRzKHNoYWRlck9iamVjdCwgbWV0aG9kVk8pO1xuXG5cdFx0c2hhZGVyT2JqZWN0LmZyYWdtZW50Q29uc3RhbnREYXRhW21ldGhvZFZPLmZyYWdtZW50Q29uc3RhbnRzSW5kZXggKyA4XSA9IDEvdGhpcy5fbnVtU2FtcGxlcztcblx0XHRzaGFkZXJPYmplY3QuZnJhZ21lbnRDb25zdGFudERhdGFbbWV0aG9kVk8uZnJhZ21lbnRDb25zdGFudHNJbmRleCArIDldID0gMDtcblx0fVxuXG5cdC8qKlxuXHQgKiBAaW5oZXJpdERvY1xuXHQgKi9cblx0cHVibGljIGlBY3RpdmF0ZShzaGFkZXJPYmplY3Q6U2hhZGVyT2JqZWN0QmFzZSwgbWV0aG9kVk86TWV0aG9kVk8sIHN0YWdlOlN0YWdlKVxuXHR7XG5cdFx0c3VwZXIuaUFjdGl2YXRlKHNoYWRlck9iamVjdCwgbWV0aG9kVk8sIHN0YWdlKTtcblxuXHRcdHZhciB0ZXhSYW5nZTpudW1iZXIgPSAuNSp0aGlzLl9yYW5nZS90aGlzLl9wQ2FzdGluZ0xpZ2h0LnNoYWRvd01hcHBlci5kZXB0aE1hcFNpemU7XG5cdFx0dmFyIGRhdGE6QXJyYXk8bnVtYmVyPiA9IHNoYWRlck9iamVjdC5mcmFnbWVudENvbnN0YW50RGF0YTtcblx0XHR2YXIgaW5kZXg6bnVtYmVyIC8qdWludCovID0gbWV0aG9kVk8uZnJhZ21lbnRDb25zdGFudHNJbmRleCArIDEwO1xuXHRcdHZhciBsZW46bnVtYmVyIC8qdWludCovID0gdGhpcy5fbnVtU2FtcGxlcyA8PCAxO1xuXG5cdFx0Zm9yICh2YXIgaTpudW1iZXIgLyppbnQqLyA9IDA7IGkgPCBsZW47ICsraSlcblx0XHRcdGRhdGFbaW5kZXggKyBpXSA9IHRoaXMuX29mZnNldHNbaV0qdGV4UmFuZ2U7XG5cdH1cblxuXHQvKipcblx0ICogQGluaGVyaXREb2Ncblx0ICovXG5cdHB1YmxpYyBfcEdldFBsYW5hckZyYWdtZW50Q29kZShtZXRob2RWTzpNZXRob2RWTywgdGFyZ2V0UmVnOlNoYWRlclJlZ2lzdGVyRWxlbWVudCwgcmVnQ2FjaGU6U2hhZGVyUmVnaXN0ZXJDYWNoZSwgc2hhcmVkUmVnaXN0ZXJzOlNoYWRlclJlZ2lzdGVyRGF0YSk6c3RyaW5nXG5cdHtcblx0XHQvLyB0b2RvOiBtb3ZlIHNvbWUgdGhpbmdzIHRvIHN1cGVyXG5cdFx0dmFyIGRlcHRoTWFwUmVnaXN0ZXI6U2hhZGVyUmVnaXN0ZXJFbGVtZW50ID0gcmVnQ2FjaGUuZ2V0RnJlZVRleHR1cmVSZWcoKTtcblx0XHR2YXIgZGVjUmVnOlNoYWRlclJlZ2lzdGVyRWxlbWVudCA9IHJlZ0NhY2hlLmdldEZyZWVGcmFnbWVudENvbnN0YW50KCk7XG5cdFx0dmFyIGRhdGFSZWc6U2hhZGVyUmVnaXN0ZXJFbGVtZW50ID0gcmVnQ2FjaGUuZ2V0RnJlZUZyYWdtZW50Q29uc3RhbnQoKTtcblx0XHR2YXIgY3VzdG9tRGF0YVJlZzpTaGFkZXJSZWdpc3RlckVsZW1lbnQgPSByZWdDYWNoZS5nZXRGcmVlRnJhZ21lbnRDb25zdGFudCgpO1xuXG5cdFx0bWV0aG9kVk8uZnJhZ21lbnRDb25zdGFudHNJbmRleCA9IGRlY1JlZy5pbmRleCo0O1xuXHRcdG1ldGhvZFZPLnRleHR1cmVzSW5kZXggPSBkZXB0aE1hcFJlZ2lzdGVyLmluZGV4O1xuXG5cdFx0cmV0dXJuIHRoaXMuZ2V0U2FtcGxlQ29kZShyZWdDYWNoZSwgZGVwdGhNYXBSZWdpc3RlciwgZGVjUmVnLCB0YXJnZXRSZWcsIGN1c3RvbURhdGFSZWcpO1xuXHR9XG5cblx0LyoqXG5cdCAqIEFkZHMgdGhlIGNvZGUgZm9yIGFub3RoZXIgdGFwIHRvIHRoZSBzaGFkZXIgY29kZS5cblx0ICogQHBhcmFtIHV2IFRoZSB1diByZWdpc3RlciBmb3IgdGhlIHRhcC5cblx0ICogQHBhcmFtIHRleHR1cmUgVGhlIHRleHR1cmUgcmVnaXN0ZXIgY29udGFpbmluZyB0aGUgZGVwdGggbWFwLlxuXHQgKiBAcGFyYW0gZGVjb2RlIFRoZSByZWdpc3RlciBjb250YWluaW5nIHRoZSBkZXB0aCBtYXAgZGVjb2RpbmcgZGF0YS5cblx0ICogQHBhcmFtIHRhcmdldCBUaGUgdGFyZ2V0IHJlZ2lzdGVyIHRvIGFkZCB0aGUgdGFwIGNvbXBhcmlzb24gcmVzdWx0LlxuXHQgKiBAcGFyYW0gcmVnQ2FjaGUgVGhlIHJlZ2lzdGVyIGNhY2hlIG1hbmFnaW5nIHRoZSByZWdpc3RlcnMuXG5cdCAqIEByZXR1cm5cblx0ICovXG5cdHByaXZhdGUgYWRkU2FtcGxlKHV2OlNoYWRlclJlZ2lzdGVyRWxlbWVudCwgdGV4dHVyZTpTaGFkZXJSZWdpc3RlckVsZW1lbnQsIGRlY29kZTpTaGFkZXJSZWdpc3RlckVsZW1lbnQsIHRhcmdldDpTaGFkZXJSZWdpc3RlckVsZW1lbnQsIHJlZ0NhY2hlOlNoYWRlclJlZ2lzdGVyQ2FjaGUpOnN0cmluZ1xuXHR7XG5cdFx0dmFyIHRlbXA6U2hhZGVyUmVnaXN0ZXJFbGVtZW50ID0gcmVnQ2FjaGUuZ2V0RnJlZUZyYWdtZW50VmVjdG9yVGVtcCgpO1xuXHRcdHJldHVybiBcInRleCBcIiArIHRlbXAgKyBcIiwgXCIgKyB1diArIFwiLCBcIiArIHRleHR1cmUgKyBcIiA8MmQsbmVhcmVzdCxjbGFtcD5cXG5cIiArXG5cdFx0XHRcImRwNCBcIiArIHRlbXAgKyBcIi56LCBcIiArIHRlbXAgKyBcIiwgXCIgKyBkZWNvZGUgKyBcIlxcblwiICtcblx0XHRcdFwic2x0IFwiICsgdXYgKyBcIi53LCBcIiArIHRoaXMuX3BEZXB0aE1hcENvb3JkUmVnICsgXCIueiwgXCIgKyB0ZW1wICsgXCIuelxcblwiICsgLy8gMCBpZiBpbiBzaGFkb3dcblx0XHRcdFwiYWRkIFwiICsgdGFyZ2V0ICsgXCIudywgXCIgKyB0YXJnZXQgKyBcIi53LCBcIiArIHV2ICsgXCIud1xcblwiO1xuXHR9XG5cblx0LyoqXG5cdCAqIEBpbmhlcml0RG9jXG5cdCAqL1xuXHRwdWJsaWMgaUFjdGl2YXRlRm9yQ2FzY2FkZShzaGFkZXJPYmplY3Q6U2hhZGVyT2JqZWN0QmFzZSwgbWV0aG9kVk86TWV0aG9kVk8sIHN0YWdlOlN0YWdlKVxuXHR7XG5cdFx0c3VwZXIuaUFjdGl2YXRlKHNoYWRlck9iamVjdCwgbWV0aG9kVk8sIHN0YWdlKTtcblxuXHRcdHZhciB0ZXhSYW5nZTpudW1iZXIgPSB0aGlzLl9yYW5nZS90aGlzLl9wQ2FzdGluZ0xpZ2h0LnNoYWRvd01hcHBlci5kZXB0aE1hcFNpemU7XG5cdFx0dmFyIGRhdGE6QXJyYXk8bnVtYmVyPiA9IHNoYWRlck9iamVjdC5mcmFnbWVudENvbnN0YW50RGF0YTtcblx0XHR2YXIgaW5kZXg6bnVtYmVyIC8qdWludCovID0gbWV0aG9kVk8uc2Vjb25kYXJ5RnJhZ21lbnRDb25zdGFudHNJbmRleDtcblx0XHR2YXIgbGVuOm51bWJlciAvKnVpbnQqLyA9IHRoaXMuX251bVNhbXBsZXMgPDwgMTtcblx0XHRkYXRhW2luZGV4XSA9IDEvdGhpcy5fbnVtU2FtcGxlcztcblx0XHRkYXRhW2luZGV4ICsgMV0gPSAwO1xuXHRcdGluZGV4ICs9IDI7XG5cblx0XHRmb3IgKHZhciBpOm51bWJlciAvKmludCovID0gMDsgaSA8IGxlbjsgKytpKVxuXHRcdFx0ZGF0YVtpbmRleCArIGldID0gdGhpcy5fb2Zmc2V0c1tpXSp0ZXhSYW5nZTtcblxuXHRcdGlmIChsZW4lNCA9PSAwKSB7XG5cdFx0XHRkYXRhW2luZGV4ICsgbGVuXSA9IDA7XG5cdFx0XHRkYXRhW2luZGV4ICsgbGVuICsgMV0gPSAwO1xuXHRcdH1cblx0fVxuXG5cdC8qKlxuXHQgKiBAaW5oZXJpdERvY1xuXHQgKi9cblx0cHVibGljIF9pR2V0Q2FzY2FkZUZyYWdtZW50Q29kZShzaGFkZXJPYmplY3Q6U2hhZGVyT2JqZWN0QmFzZSwgbWV0aG9kVk86TWV0aG9kVk8sIGRlY29kZVJlZ2lzdGVyOlNoYWRlclJlZ2lzdGVyRWxlbWVudCwgZGVwdGhUZXh0dXJlOlNoYWRlclJlZ2lzdGVyRWxlbWVudCwgZGVwdGhQcm9qZWN0aW9uOlNoYWRlclJlZ2lzdGVyRWxlbWVudCwgdGFyZ2V0UmVnaXN0ZXI6U2hhZGVyUmVnaXN0ZXJFbGVtZW50LCByZWdpc3RlckNhY2hlOlNoYWRlclJlZ2lzdGVyQ2FjaGUsIHNoYXJlZFJlZ2lzdGVyczpTaGFkZXJSZWdpc3RlckRhdGEpOnN0cmluZ1xuXHR7XG5cdFx0dGhpcy5fcERlcHRoTWFwQ29vcmRSZWcgPSBkZXB0aFByb2plY3Rpb247XG5cblx0XHR2YXIgZGF0YVJlZzpTaGFkZXJSZWdpc3RlckVsZW1lbnQgPSByZWdpc3RlckNhY2hlLmdldEZyZWVGcmFnbWVudENvbnN0YW50KCk7XG5cdFx0bWV0aG9kVk8uc2Vjb25kYXJ5RnJhZ21lbnRDb25zdGFudHNJbmRleCA9IGRhdGFSZWcuaW5kZXgqNDtcblxuXHRcdHJldHVybiB0aGlzLmdldFNhbXBsZUNvZGUocmVnaXN0ZXJDYWNoZSwgZGVwdGhUZXh0dXJlLCBkZWNvZGVSZWdpc3RlciwgdGFyZ2V0UmVnaXN0ZXIsIGRhdGFSZWcpO1xuXHR9XG5cblx0LyoqXG5cdCAqIEdldCB0aGUgYWN0dWFsIHNoYWRlciBjb2RlIGZvciBzaGFkb3cgbWFwcGluZ1xuXHQgKiBAcGFyYW0gcmVnQ2FjaGUgVGhlIHJlZ2lzdGVyIGNhY2hlIG1hbmFnaW5nIHRoZSByZWdpc3RlcnMuXG5cdCAqIEBwYXJhbSBkZXB0aFRleHR1cmUgVGhlIHRleHR1cmUgcmVnaXN0ZXIgY29udGFpbmluZyB0aGUgZGVwdGggbWFwLlxuXHQgKiBAcGFyYW0gZGVjb2RlUmVnaXN0ZXIgVGhlIHJlZ2lzdGVyIGNvbnRhaW5pbmcgdGhlIGRlcHRoIG1hcCBkZWNvZGluZyBkYXRhLlxuXHQgKiBAcGFyYW0gdGFyZ2V0UmVnIFRoZSB0YXJnZXQgcmVnaXN0ZXIgdG8gYWRkIHRoZSBzaGFkb3cgY292ZXJhZ2UuXG5cdCAqIEBwYXJhbSBkYXRhUmVnIFRoZSByZWdpc3RlciBjb250YWluaW5nIGFkZGl0aW9uYWwgZGF0YS5cblx0ICovXG5cdHByaXZhdGUgZ2V0U2FtcGxlQ29kZShyZWdDYWNoZTpTaGFkZXJSZWdpc3RlckNhY2hlLCBkZXB0aFRleHR1cmU6U2hhZGVyUmVnaXN0ZXJFbGVtZW50LCBkZWNvZGVSZWdpc3RlcjpTaGFkZXJSZWdpc3RlckVsZW1lbnQsIHRhcmdldFJlZ2lzdGVyOlNoYWRlclJlZ2lzdGVyRWxlbWVudCwgZGF0YVJlZzpTaGFkZXJSZWdpc3RlckVsZW1lbnQpOnN0cmluZ1xuXHR7XG5cdFx0dmFyIHV2UmVnOlNoYWRlclJlZ2lzdGVyRWxlbWVudDtcblx0XHR2YXIgY29kZTpzdHJpbmc7XG5cdFx0dmFyIG9mZnNldHM6QXJyYXk8c3RyaW5nPiA9IG5ldyBBcnJheTxzdHJpbmc+KGRhdGFSZWcgKyBcIi56d1wiKTtcblx0XHR1dlJlZyA9IHJlZ0NhY2hlLmdldEZyZWVGcmFnbWVudFZlY3RvclRlbXAoKTtcblx0XHRyZWdDYWNoZS5hZGRGcmFnbWVudFRlbXBVc2FnZXModXZSZWcsIDEpO1xuXG5cdFx0dmFyIHRlbXA6U2hhZGVyUmVnaXN0ZXJFbGVtZW50ID0gcmVnQ2FjaGUuZ2V0RnJlZUZyYWdtZW50VmVjdG9yVGVtcCgpO1xuXG5cdFx0dmFyIG51bVJlZ3M6bnVtYmVyIC8qaW50Ki8gPSB0aGlzLl9udW1TYW1wbGVzID4+IDE7XG5cdFx0Zm9yICh2YXIgaTpudW1iZXIgLyppbnQqLyA9IDA7IGkgPCBudW1SZWdzOyArK2kpIHtcblx0XHRcdHZhciByZWc6U2hhZGVyUmVnaXN0ZXJFbGVtZW50ID0gcmVnQ2FjaGUuZ2V0RnJlZUZyYWdtZW50Q29uc3RhbnQoKTtcblx0XHRcdG9mZnNldHMucHVzaChyZWcgKyBcIi54eVwiKTtcblx0XHRcdG9mZnNldHMucHVzaChyZWcgKyBcIi56d1wiKTtcblx0XHR9XG5cblx0XHRmb3IgKGkgPSAwOyBpIDwgdGhpcy5fbnVtU2FtcGxlczsgKytpKSB7XG5cdFx0XHRpZiAoaSA9PSAwKSB7XG5cdFx0XHRcdGNvZGUgPSBcImFkZCBcIiArIHV2UmVnICsgXCIsIFwiICsgdGhpcy5fcERlcHRoTWFwQ29vcmRSZWcgKyBcIiwgXCIgKyBkYXRhUmVnICsgXCIuend5eVxcblwiICtcblx0XHRcdFx0XHRcInRleCBcIiArIHRlbXAgKyBcIiwgXCIgKyB1dlJlZyArIFwiLCBcIiArIGRlcHRoVGV4dHVyZSArIFwiIDwyZCxuZWFyZXN0LGNsYW1wPlxcblwiICtcblx0XHRcdFx0XHRcImRwNCBcIiArIHRlbXAgKyBcIi56LCBcIiArIHRlbXAgKyBcIiwgXCIgKyBkZWNvZGVSZWdpc3RlciArIFwiXFxuXCIgK1xuXHRcdFx0XHRcdFwic2x0IFwiICsgdGFyZ2V0UmVnaXN0ZXIgKyBcIi53LCBcIiArIHRoaXMuX3BEZXB0aE1hcENvb3JkUmVnICsgXCIueiwgXCIgKyB0ZW1wICsgXCIuelxcblwiOyAvLyAwIGlmIGluIHNoYWRvdztcblx0XHRcdH0gZWxzZSB7XG5cdFx0XHRcdGNvZGUgKz0gXCJhZGQgXCIgKyB1dlJlZyArIFwiLnh5LCBcIiArIHRoaXMuX3BEZXB0aE1hcENvb3JkUmVnICsgXCIueHksIFwiICsgb2Zmc2V0c1tpXSArIFwiXFxuXCIgK1xuXHRcdFx0XHRcdHRoaXMuYWRkU2FtcGxlKHV2UmVnLCBkZXB0aFRleHR1cmUsIGRlY29kZVJlZ2lzdGVyLCB0YXJnZXRSZWdpc3RlciwgcmVnQ2FjaGUpO1xuXHRcdFx0fVxuXHRcdH1cblxuXHRcdHJlZ0NhY2hlLnJlbW92ZUZyYWdtZW50VGVtcFVzYWdlKHV2UmVnKTtcblxuXHRcdGNvZGUgKz0gXCJtdWwgXCIgKyB0YXJnZXRSZWdpc3RlciArIFwiLncsIFwiICsgdGFyZ2V0UmVnaXN0ZXIgKyBcIi53LCBcIiArIGRhdGFSZWcgKyBcIi54XFxuXCI7IC8vIGF2ZXJhZ2VcblxuXHRcdHJldHVybiBjb2RlO1xuXHR9XG59XG5cbmV4cG9ydCA9IFNoYWRvd1NvZnRNZXRob2Q7Il19